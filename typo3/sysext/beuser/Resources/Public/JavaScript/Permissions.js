/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["TYPO3/CMS/Core/Event/RegularEvent","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Backend/Tooltip"],(function(e,t,a){"use strict";class o{constructor(){this.options={containerSelector:"#typo3-permissionList",editControllerSelector:"#PermissionControllerEdit"},this.ajaxUrl=TYPO3.settings.ajaxUrls.user_access_permissions,this.initializeCheckboxGroups(),this.initializeEvents()}static setPermissionCheckboxes(e,t){const a=document.querySelectorAll(`input[type="checkbox"][name^="${e}"]`);for(let e of a){const a=parseInt(e.value,10);e.checked=(t&a)===a}}static updatePermissionValue(e,t){let a=0;const o=document.querySelectorAll(`input[type="checkbox"][name^="${e}"]:checked`);for(let e of o)a|=parseInt(e.value,10);document.forms.namedItem("editform")[t].value=a|("check[perms_user]"===e?1:0)}setPermissions(e){let o=e.dataset.page,n=e.dataset.who;a.hide(document.querySelectorAll('[data-bs-toggle="tooltip"]')),new t(this.ajaxUrl).post({page:o,who:n,permissions:e.dataset.permissions,mode:e.dataset.mode,bits:e.dataset.bits}).then(async e=>{const t=await e.resolve();document.getElementById(o+"_"+n).outerHTML=t,a.initialize('[data-bs-toggle="tooltip"]')})}toggleEditLock(e){let a=e.dataset.page;new t(this.ajaxUrl).post({action:"toggle_edit_lock",page:a,editLockState:e.dataset.lockstate}).then(async e=>{document.getElementById("el_"+a).outerHTML=await e.resolve()})}changeOwner(e){let a=e.dataset.page;const o=document.getElementById("o_"+a);new t(this.ajaxUrl).post({action:"change_owner",page:a,ownerUid:e.dataset.owner,newOwnerUid:o.getElementsByTagName("select")[0].value}).then(async e=>{o.outerHTML=await e.resolve()})}showChangeOwnerSelector(e){let a=e.dataset.page;new t(this.ajaxUrl).post({action:"show_change_owner_selector",page:a,ownerUid:e.dataset.owner,username:e.dataset.username}).then(async e=>{document.getElementById("o_"+a).outerHTML=await e.resolve()})}restoreOwner(e){var t;const a=e.dataset.page,o=null!==(t=e.dataset.username)&&void 0!==t?t:e.dataset.ifNotSet,n=document.createElement("span");n.setAttribute("id","o_"+a);const s=document.createElement("button");s.classList.add("ug_selector","changeowner","btn","btn-link"),s.setAttribute("type","button"),s.setAttribute("data-page",a),s.setAttribute("data-owner",e.dataset.owner),s.setAttribute("data-username",o),s.innerText=o,n.appendChild(s);const r=document.getElementById("o_"+a);r.parentNode.replaceChild(n,r)}restoreGroup(e){var t;const a=e.dataset.page,o=null!==(t=e.dataset.groupname)&&void 0!==t?t:e.dataset.ifNotSet,n=document.createElement("span");n.setAttribute("id","g_"+a);const s=document.createElement("button");s.classList.add("ug_selector","changegroup","btn","btn-link"),s.setAttribute("type","button"),s.setAttribute("data-page",a),s.setAttribute("data-group-id",e.dataset.groupId),s.setAttribute("data-groupname",o),s.innerText=o,n.appendChild(s);const r=document.getElementById("g_"+a);r.parentNode.replaceChild(n,r)}changeGroup(e){let a=e.dataset.page;const o=document.getElementById("g_"+a);new t(this.ajaxUrl).post({action:"change_group",page:a,groupUid:e.dataset.groupId,newGroupUid:o.getElementsByTagName("select")[0].value}).then(async e=>{o.outerHTML=await e.resolve()})}showChangeGroupSelector(e){let a=e.dataset.page;new t(this.ajaxUrl).post({action:"show_change_group_selector",page:a,groupUid:e.dataset.groupId,groupname:e.dataset.groupname}).then(async e=>{document.getElementById("g_"+a).outerHTML=await e.resolve()})}initializeCheckboxGroups(){document.querySelectorAll("[data-checkbox-group]").forEach(e=>{const t=e.dataset.checkboxGroup,a=parseInt(e.value,10);o.setPermissionCheckboxes(t,a)})}initializeEvents(){const t=document.querySelector(this.options.containerSelector),a=document.querySelector(this.options.editControllerSelector);null!==t&&(new e("click",(e,t)=>{e.preventDefault(),this.setPermissions(t)}).delegateTo(t,".change-permission"),new e("click",(e,t)=>{e.preventDefault(),this.toggleEditLock(t)}).delegateTo(t,".editlock"),new e("click",(e,t)=>{e.preventDefault(),this.showChangeOwnerSelector(t)}).delegateTo(t,".changeowner"),new e("click",(e,t)=>{e.preventDefault(),this.showChangeGroupSelector(t)}).delegateTo(t,".changegroup"),new e("click",(e,t)=>{e.preventDefault(),this.restoreOwner(t)}).delegateTo(t,".restoreowner"),new e("click",(e,t)=>{e.preventDefault(),this.changeOwner(t)}).delegateTo(t,".saveowner"),new e("click",(e,t)=>{e.preventDefault(),this.restoreGroup(t)}).delegateTo(t,".restoregroup"),new e("click",(e,t)=>{e.preventDefault(),this.changeGroup(t)}).delegateTo(t,".savegroup")),null!==a&&new e("click",(e,t)=>{const a=t.dataset.checkChangePermissions.split(",").map(e=>e.trim());o.updatePermissionValue.apply(this,a)}).delegateTo(a,"[data-check-change-permissions]")}}return new o}));