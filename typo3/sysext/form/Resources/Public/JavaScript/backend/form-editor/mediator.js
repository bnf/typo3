/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import*as Helper from"@typo3/form/backend/form-editor/helper.js";let formEditorApp=null,viewModel=null;function getFormEditorApp(){return formEditorApp}function getViewModel(){return viewModel}function getUtility(){return getFormEditorApp().getUtility()}function assert(e,t,r){return getFormEditorApp().assert(e,t,r)}function getHelper(e){return getUtility().isUndefinedOrNull(e)?Helper.setConfiguration(getViewModel().getConfiguration()):Helper.setConfiguration(e)}function getCurrentlySelectedFormElement(){return getFormEditorApp().getCurrentlySelectedFormElement()}function getPublisherSubscriber(){return getFormEditorApp().getPublisherSubscriber()}function getRootFormElement(){return getFormEditorApp().getRootFormElement()}function subscribeEvents(){window.onbeforeunload=function(e){if(getFormEditorApp().getUnsavedContent())return(e=e||window.event)&&(e.returnValue=getFormEditorApp().getFormElementDefinition(getRootFormElement(),"modalCloseDialogMessage")),getFormEditorApp().getFormElementDefinition(getRootFormElement(),"modalCloseDialogTitle")},getPublisherSubscriber().subscribe("view/ready",(function(e,t){getViewModel().onViewReadyBatch()})),getPublisherSubscriber().subscribe("core/applicationState/add",(function(e,t){getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderRedo"))),t[2]>1&&t[1]<=t[2]?getViewModel().enableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderUndo"))):getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderUndo")))})),getPublisherSubscriber().subscribe("core/ajax/saveFormDefinition/success",(function(e,t){getFormEditorApp().setUnsavedContent(!1),getViewModel().showSaveSuccessMessage(),getViewModel().showSaveButtonSaveIcon(),getFormEditorApp().setFormDefinition(t[0].formDefinition),getViewModel().addStructureRootElementSelection(),getFormEditorApp().setCurrentlySelectedFormElement(getRootFormElement()),getViewModel().setStructureRootElementTitle(),getViewModel().setStageHeadline(),getViewModel().renderAbstractStageArea(),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("core/ajax/saveFormDefinition/error",(function(e,t){getViewModel().showSaveButtonSaveIcon(),getViewModel().showSaveErrorMessage(t[0])})),getPublisherSubscriber().subscribe("core/ajax/renderFormDefinitionPage/success",(function(e,t){getViewModel().renderPreviewStageArea(t[0])})),getPublisherSubscriber().subscribe("core/ajax/error",(function(e,t){0!==t[0].status&&(getViewModel().showErrorFlashMessage(t[1],t[2]),getViewModel().renderPreviewStageArea(t[0].responseText))})),getPublisherSubscriber().subscribe("view/header/button/save/clicked",(function(e,t){getFormEditorApp().validationResultsHasErrors(getFormEditorApp().validateFormElementRecursive(getRootFormElement(),!0))?getViewModel().showValidationErrorsModal():(getViewModel().showSaveButtonSpinnerIcon(),getFormEditorApp().saveFormDefinition())})),getPublisherSubscriber().subscribe("view/header/formSettings/clicked",(function(e,t){getViewModel().addStructureRootElementSelection(),getFormEditorApp().setCurrentlySelectedFormElement(getRootFormElement()),getViewModel().renderAbstractStageArea(),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/header/button/newPage/clicked",(function(e,t){getFormEditorApp().isRootFormElementSelected()&&getViewModel().selectPageBatch(0),getViewModel().showInsertPagesModal(t[0])})),getPublisherSubscriber().subscribe("view/header/button/close/clicked",(function(e,t){getViewModel().showCloseConfirmationModal()})),getPublisherSubscriber().subscribe("view/undoButton/clicked",(function(e,t){getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderRedo"))),getFormEditorApp().undoApplicationState(),getViewModel().getPreviewMode()?getFormEditorApp().renderCurrentFormPage():getViewModel().renderAbstractStageArea(),getFormEditorApp().setUnsavedContent(!0),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/redoButton/clicked",(function(e,t){getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderUndo"))),getViewModel().disableButton($(getHelper().getDomElementDataIdentifierSelector("buttonHeaderRedo"))),getFormEditorApp().redoApplicationState(),getViewModel().getPreviewMode()?getFormEditorApp().renderCurrentFormPage():getViewModel().renderAbstractStageArea(),getFormEditorApp().setUnsavedContent(!0),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/stage/element/clicked",(function(e,t){getCurrentlySelectedFormElement().get("__identifierPath")!==t[0]&&(getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().renewStructure(),getViewModel().refreshSelectedElementItemsBatch(),getViewModel().addAbstractViewValidationResults(),getViewModel().renderInspectorEditors())})),getPublisherSubscriber().subscribe("view/stage/abstract/elementToolbar/button/newElement/clicked",(function(e,t){getFormEditorApp().isRootFormElementSelected()&&getViewModel().selectPageBatch(0),getViewModel().showInsertElementsModal(t[0],t[1])})),getPublisherSubscriber().subscribe("view/stage/abstract/button/newElement/clicked",(function(e,t){getFormEditorApp().isRootFormElementSelected()&&getViewModel().selectPageBatch(0),getViewModel().showInsertElementsModal(t[0],t[1]||void 0)})),getPublisherSubscriber().subscribe("view/stage/abstract/dnd/start",(function(e,t){getViewModel().onAbstractViewDndStartBatch(t[0],t[1])})),getPublisherSubscriber().subscribe("view/stage/abstract/dnd/stop",(function(e,t){getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().renewStructure(),getViewModel().renderAbstractStageArea(!1,!1),getViewModel().refreshSelectedElementItemsBatch(),getViewModel().addAbstractViewValidationResults(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/stage/abstract/dnd/change",(function(e,t){getViewModel().onAbstractViewDndChangeBatch(t[0],t[1],t[2])})),getPublisherSubscriber().subscribe("view/stage/abstract/dnd/update",(function(e,t){getViewModel().onAbstractViewDndUpdateBatch(t[0],t[1],t[2],t[3])})),getPublisherSubscriber().subscribe("view/viewModeButton/abstract/clicked",(function(e,t){getViewModel().getPreviewMode()&&(getViewModel().setPreviewMode(!1),getViewModel().renderAbstractStageArea())})),getPublisherSubscriber().subscribe("view/viewModeButton/preview/clicked",(function(e,t){getViewModel().getPreviewMode()||(getViewModel().setPreviewMode(!0),getFormEditorApp().renderCurrentFormPage())})),getPublisherSubscriber().subscribe("view/paginationPrevious/clicked",(function(e,t){getViewModel().selectPageBatch(getFormEditorApp().getCurrentlySelectedPageIndex()-1),getViewModel().getPreviewMode()?getFormEditorApp().renderCurrentFormPage():getViewModel().renderAbstractStageArea()})),getPublisherSubscriber().subscribe("view/paginationNext/clicked",(function(e,t){getViewModel().selectPageBatch(getFormEditorApp().getCurrentlySelectedPageIndex()+1),getViewModel().getPreviewMode()?getFormEditorApp().renderCurrentFormPage():getViewModel().renderAbstractStageArea()})),getPublisherSubscriber().subscribe("view/stage/abstract/render/postProcess",(function(e,t){getViewModel().renderUndoRedo()})),getPublisherSubscriber().subscribe("view/stage/preview/render/postProcess",(function(e,t){getViewModel().renderUndoRedo()})),getPublisherSubscriber().subscribe("view/tree/node/clicked",(function(e,t){let r;getCurrentlySelectedFormElement().get("__identifierPath")!==t[0]&&(r=getFormEditorApp().getCurrentlySelectedPageIndex(),getFormEditorApp().setCurrentlySelectedFormElement(t[0]),r!==getFormEditorApp().getCurrentlySelectedPageIndex()?getViewModel().renderAbstractStageArea():getViewModel().renderAbstractStageArea(!1),getViewModel().renderPagination(),getViewModel().renderInspectorEditors())})),getPublisherSubscriber().subscribe("view/tree/node/changed",(function(e,t){const r=getFormEditorApp().getFormElementByIdentifierPath(t[0]);r.set("label",t[1]),getViewModel().getStructure().setTreeNodeTitle(null,r),getCurrentlySelectedFormElement().get("__identifierPath")===t[0]&&getViewModel().renderInspectorEditors(t[0],!1)})),getPublisherSubscriber().subscribe("view/structure/root/selected",(function(e,t){getFormEditorApp().isRootFormElementSelected()||(getViewModel().addStructureRootElementSelection(),getFormEditorApp().setCurrentlySelectedFormElement(getRootFormElement()),getViewModel().renderAbstractStageArea(),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors())})),getPublisherSubscriber().subscribe("view/structure/button/newPage/clicked",(function(e,t){getFormEditorApp().isRootFormElementSelected()&&getViewModel().selectPageBatch(0),getViewModel().showInsertPagesModal(t[0])})),getPublisherSubscriber().subscribe("view/tree/dnd/stop",(function(e,t){getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().renewStructure(),getViewModel().renderPagination(),getViewModel().renderAbstractStageArea(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/tree/dnd/change",(function(e,t){getViewModel().onStructureDndChangeBatch(t[0],t[1],t[2])})),getPublisherSubscriber().subscribe("view/tree/dnd/update",(function(e,t){getViewModel().onStructureDndUpdateBatch(t[0],t[1],t[2],t[3])})),getPublisherSubscriber().subscribe("view/structure/renew/postProcess",(function(e,t){getViewModel().addStructureValidationResults()})),getPublisherSubscriber().subscribe("view/inspector/removeCollectionElement/perform",(function(e,t){getViewModel().removePropertyCollectionElement(t[0],t[1],t[2]||void 0)})),getPublisherSubscriber().subscribe("view/inspector/collectionElement/new/selected",(function(e,t){getViewModel().createAndAddPropertyCollectionElement(t[0],t[1])})),getPublisherSubscriber().subscribe("view/inspector/collectionElement/existing/selected",(function(e,t){getViewModel().renderInspectorCollectionElementEditors(t[1],t[0])})),getPublisherSubscriber().subscribe("view/inspector/collectionElements/dnd/update",(function(e,t){t[2]?getViewModel().movePropertyCollectionElement(t[0],"before",t[2],t[3]):t[1]?getViewModel().movePropertyCollectionElement(t[0],"after",t[1],t[3]):assert(!1,"Next element or previous element need to be set.",1477407673)})),getPublisherSubscriber().subscribe("core/formElement/somePropertyChanged",(function(e,t){"renderables"!==t[0]&&(getFormEditorApp().isRootFormElementSelected()||"label"!==t[0]?getFormEditorApp().getUtility().isUndefinedOrNull(t[3])||getRootFormElement().get("__identifierPath")!==t[3]||(getViewModel().setStructureRootElementTitle(),getViewModel().setStageHeadline()):getViewModel().getStructure().setTreeNodeTitle(),getViewModel().getPreviewMode()?getFormEditorApp().renderCurrentFormPage():getViewModel().renderAbstractStageArea(!1,!1),getViewModel().addStructureValidationResults()),getFormEditorApp().setUnsavedContent(!0)})),getPublisherSubscriber().subscribe("view/formElement/removed",(function(e,t){getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().renewStructure(),getViewModel().renderAbstractStageArea(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/formElement/inserted",(function(e,t){getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().renewStructure(),getViewModel().renderAbstractStageArea(),getViewModel().renderPagination(),getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/collectionElement/new/added",(function(e,t){getViewModel().renderInspectorEditors()})),getPublisherSubscriber().subscribe("view/collectionElement/moved",(function(e,t){getViewModel().renderInspectorEditors(void 0,!1)})),getPublisherSubscriber().subscribe("view/collectionElement/removed",(function(e,t){getViewModel().renderInspectorEditors(void 0,!1)})),getPublisherSubscriber().subscribe("view/insertElements/perform/bottom",(function(e,t){const r=getFormEditorApp().getLastTopLevelElementOnCurrentPage();r?!getFormEditorApp().getFormElementDefinition(r,"_isTopLevelFormElement")&&getFormEditorApp().getFormElementDefinition(r,"_isCompositeFormElement")?getViewModel().createAndAddFormElement(t[0],getFormEditorApp().getCurrentlySelectedPage()):getViewModel().createAndAddFormElement(t[0],r):getViewModel().createAndAddFormElement(t[0],getFormEditorApp().getCurrentlySelectedPage())})),getPublisherSubscriber().subscribe("view/insertElements/perform/after",(function(e,t){let r;r=getViewModel().createAndAddFormElement(t[0],void 0,!0),r=getViewModel().moveFormElement(r,"after",getFormEditorApp().getCurrentlySelectedFormElement()),getPublisherSubscriber().publish("view/formElement/inserted",[r])})),getPublisherSubscriber().subscribe("view/insertElements/perform/inside",(function(e,t){getViewModel().createAndAddFormElement(t[0])})),getPublisherSubscriber().subscribe("view/insertPages/perform",(function(e,t){getViewModel().createAndAddFormElement(t[0])})),getPublisherSubscriber().subscribe("view/modal/close/perform",(function(e,t){getFormEditorApp().setUnsavedContent(!1),getViewModel().closeEditor()})),getPublisherSubscriber().subscribe("view/modal/removeFormElement/perform",(function(e,t){getViewModel().removeFormElement(t[0])})),getPublisherSubscriber().subscribe("view/modal/removeCollectionElement/perform",(function(e,t){getViewModel().removePropertyCollectionElement(t[0],t[1],t[2])})),getPublisherSubscriber().subscribe("view/modal/validationErrors/element/clicked",(function(e,t){let r;getCurrentlySelectedFormElement().get("__identifierPath")!==t[0]&&(r=getFormEditorApp().getCurrentlySelectedPageIndex(),getFormEditorApp().setCurrentlySelectedFormElement(t[0]),getViewModel().getPreviewMode()&&getViewModel().setPreviewMode(!1),r!==getFormEditorApp().getCurrentlySelectedPageIndex()?getViewModel().renderAbstractStageArea():getViewModel().renderAbstractStageArea(!1),getViewModel().renderPagination(),getViewModel().renderInspectorEditors())}))}export function bootstrap(e,t){formEditorApp=e,viewModel=t,Helper.bootstrap(formEditorApp),subscribeEvents()}