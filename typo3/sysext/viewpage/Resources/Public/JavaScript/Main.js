/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","TYPO3/CMS/Backend/Storage/Persistent","TYPO3/CMS/Core/SecurityUtility","jquery-ui/resizable"],(function(e,t,i){"use strict";var s;!function(e){e.resizableContainerIdentifier=".t3js-viewpage-resizeable",e.sizeIdentifier=".t3js-viewpage-size",e.moduleBodySelector=".t3js-module-body",e.customSelector=".t3js-preset-custom",e.customWidthSelector=".t3js-preset-custom",e.customHeightSelector=".t3js-preset-custom-height",e.changeOrientationSelector=".t3js-change-orientation",e.changePresetSelector=".t3js-change-preset",e.inputWidthSelector=".t3js-viewpage-input-width",e.inputHeightSelector=".t3js-viewpage-input-height",e.currentLabelSelector=".t3js-viewpage-current-label",e.topbarContainerSelector=".t3js-viewpage-topbar"}(s||(s={}));class r{constructor(){this.defaultLabel="",this.minimalHeight=300,this.minimalWidth=300,this.storagePrefix="moduleData.web_view.States.",this.queue=[],this.queueIsRunning=!1,e(()=>{const t=e(".t3js-preset-custom-label");this.defaultLabel=t.length>0?t.html().trim():"",this.$iframe=e("#tx_this_iframe"),this.$resizableContainer=e(s.resizableContainerIdentifier),this.$sizeSelector=e(s.sizeIdentifier),this.initialize()})}static getCurrentWidth(){return e(s.inputWidthSelector).val()}static getCurrentHeight(){return e(s.inputHeightSelector).val()}static setLabel(t){e(s.currentLabelSelector).html((new i).encodeHtml(t))}static getCurrentLabel(){return e(s.currentLabelSelector).html().trim()}persistQueue(){if(!1===this.queueIsRunning&&this.queue.length>=1){this.queueIsRunning=!0;let e=this.queue.shift();t.set(e.storageIdentifier,e.data).done(()=>{this.queueIsRunning=!1,this.persistQueue()})}}addToQueue(e,t){const i={storageIdentifier:e,data:t};this.queue.push(i),this.queue.length>=1&&this.persistQueue()}setSize(t,i){isNaN(i)&&(i=this.calculateContainerMaxHeight()),i<this.minimalHeight&&(i=this.minimalHeight),isNaN(t)&&(t=this.calculateContainerMaxWidth()),t<this.minimalWidth&&(t=this.minimalWidth),e(s.inputWidthSelector).val(t),e(s.inputHeightSelector).val(i),this.$resizableContainer.css({width:t,height:i,left:0})}persistCurrentPreset(){let e={width:r.getCurrentWidth(),height:r.getCurrentHeight(),label:r.getCurrentLabel()};this.addToQueue(this.storagePrefix+"current",e)}persistCustomPreset(){let t={width:r.getCurrentWidth(),height:r.getCurrentHeight()};e(s.customSelector).data("width",t.width),e(s.customSelector).data("height",t.height),e(s.customWidthSelector).html(t.width),e(s.customHeightSelector).html(t.height),this.addToQueue(this.storagePrefix+"custom",t)}persistCustomPresetAfterChange(){clearTimeout(this.queueDelayTimer),this.queueDelayTimer=window.setTimeout(()=>{this.persistCustomPreset()},1e3)}initialize(){e(document).on("click",s.changeOrientationSelector,()=>{const t=e(s.inputHeightSelector).val(),i=e(s.inputWidthSelector).val();this.setSize(t,i),this.persistCurrentPreset()}),e(document).on("change",s.inputWidthSelector,()=>{const t=e(s.inputWidthSelector).val(),i=e(s.inputHeightSelector).val();this.setSize(t,i),r.setLabel(this.defaultLabel),this.persistCustomPresetAfterChange()}),e(document).on("change",s.inputHeightSelector,()=>{const t=e(s.inputWidthSelector).val(),i=e(s.inputHeightSelector).val();this.setSize(t,i),r.setLabel(this.defaultLabel),this.persistCustomPresetAfterChange()}),e(document).on("click",s.changePresetSelector,t=>{const i=e(t.currentTarget).data();this.setSize(parseInt(i.width,10),parseInt(i.height,10)),r.setLabel(i.label),this.persistCurrentPreset()}),this.$resizableContainer.resizable({handles:"w, sw, s, se, e"}),this.$resizableContainer.on("resizestart",t=>{e(t.currentTarget).append('<div id="this-iframe-cover" style="z-index:99;position:absolute;width:100%;top:0;left:0;height:100%;"></div>')}),this.$resizableContainer.on("resize",(t,i)=>{i.size.width=i.originalSize.width+2*(i.size.width-i.originalSize.width),i.size.height<this.minimalHeight&&(i.size.height=this.minimalHeight),i.size.width<this.minimalWidth&&(i.size.width=this.minimalWidth),e(s.inputWidthSelector).val(i.size.width),e(s.inputHeightSelector).val(i.size.height),this.$resizableContainer.css({left:0}),r.setLabel(this.defaultLabel)}),this.$resizableContainer.on("resizestop",()=>{e("#viewpage-iframe-cover").remove(),this.persistCurrentPreset(),this.persistCustomPreset()})}calculateContainerMaxHeight(){this.$resizableContainer.hide();let t=e(s.moduleBodySelector),i=t.outerHeight()-t.height(),r=e(document).height(),h=e(s.topbarContainerSelector).outerHeight();return this.$resizableContainer.show(),r-i-h-8}calculateContainerMaxWidth(){this.$resizableContainer.hide();let t=e(s.moduleBodySelector),i=t.outerWidth()-t.width(),r=e(document).width();return this.$resizableContainer.show(),parseInt(r-i+"",10)}}return new r}));