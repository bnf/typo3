/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","../AbstractInteractableModule","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Core/SecurityUtility","../../Renderable/FlashMessage","../../Renderable/InfoBox","../../Renderable/ProgressBar","../../Renderable/Severity","../../Router","bootstrap"],(function(t,a,e,s,n,i,o,d,l){"use strict";class c extends a.AbstractInteractableModule{constructor(){super(...arguments),this.selectorOutputContainer=".t3js-languagePacks-output",this.selectorContentContainer=".t3js-languagePacks-mainContent",this.selectorActivateLanguage=".t3js-languagePacks-activateLanguage",this.selectorActivateLanguageIcon="#t3js-languagePacks-activate-icon",this.selectorAddLanguageToggle=".t3js-languagePacks-addLanguage-toggle",this.selectorLanguageInactive=".t3js-languagePacks-inactive",this.selectorDeactivateLanguage=".t3js-languagePacks-deactivateLanguage",this.selectorDeactivateLanguageIcon="#t3js-languagePacks-deactivate-icon",this.selectorUpdate=".t3js-languagePacks-update",this.selectorLanguageUpdateIcon="#t3js-languagePacks-languageUpdate-icon",this.selectorNotifications=".t3js-languagePacks-notifications",this.activeLanguages=[],this.activeExtensions=[],this.packsUpdateDetails={toHandle:0,handled:0,updated:0,new:0,failed:0},this.notifications=[]}static pluralize(t,a="pack",e="s",s=0){return 1!==t&&1!==s?a+e:a}initialize(a){this.currentModal=a,this.getData(),a.on("click",this.selectorAddLanguageToggle,()=>{a.find(this.selectorContentContainer+" "+this.selectorLanguageInactive).toggle()}),a.on("click",this.selectorActivateLanguage,a=>{const e=t(a.target).closest(this.selectorActivateLanguage).data("iso");a.preventDefault(),this.activateLanguage(e)}),a.on("click",this.selectorDeactivateLanguage,a=>{const e=t(a.target).closest(this.selectorDeactivateLanguage).data("iso");a.preventDefault(),this.deactivateLanguage(e)}),a.on("click",this.selectorUpdate,a=>{const e=t(a.target).closest(this.selectorUpdate).data("iso"),s=t(a.target).closest(this.selectorUpdate).data("extension");a.preventDefault(),this.updatePacks(e,s)})}getData(){const a=this.getModalBody();new e(l.getUrl("languagePacksGetData")).get({cache:"no-cache"}).then(async e=>{const s=await e.resolve();if(!0===s.success){this.activeLanguages=s.activeLanguages,this.activeExtensions=s.activeExtensions,a.empty().append(s.html);const e=a.parent().find(this.selectorContentContainer);e.empty(),e.append(this.languageMatrixHtml(s)),e.append(this.extensionMatrixHtml(s)),t('[data-toggle="tooltip"]').tooltip({container:e})}else{const t=i.render(d.error,"Something went wrong","");this.addNotification(t)}this.renderNotifications()},t=>{l.handleAjaxError(t,a)})}activateLanguage(t){const a=this.getModalBody(),s=this.findInModal(this.selectorOutputContainer),c=o.render(d.loading,"Loading...","");s.empty().append(c),this.getNotificationBox().empty(),new e(l.getUrl()).post({install:{action:"languagePacksActivateLanguage",token:this.getModuleContent().data("language-packs-activate-language-token"),iso:t}}).then(async t=>{const a=await t.resolve();if(s.empty(),!0===a.success&&Array.isArray(a.status))a.status.forEach(t=>{const a=i.render(t.severity,t.title,t.message);this.addNotification(a)});else{const t=n.render(d.error,"Something went wrong","");this.addNotification(t)}this.getData()},t=>{l.handleAjaxError(t,a)})}deactivateLanguage(t){const a=this.getModalBody(),s=this.findInModal(this.selectorOutputContainer),c=o.render(d.loading,"Loading...","");s.empty().append(c),this.getNotificationBox().empty(),new e(l.getUrl()).post({install:{action:"languagePacksDeactivateLanguage",token:this.getModuleContent().data("language-packs-deactivate-language-token"),iso:t}}).then(async t=>{const a=await t.resolve();if(s.empty(),!0===a.success&&Array.isArray(a.status))a.status.forEach(t=>{const a=i.render(t.severity,t.title,t.message);this.addNotification(a)});else{const t=n.render(d.error,"Something went wrong","");this.addNotification(t)}this.getData()},t=>{l.handleAjaxError(t,a)})}updatePacks(a,s){const n=this.findInModal(this.selectorOutputContainer),i=this.findInModal(this.selectorContentContainer),o=void 0===a?this.activeLanguages:[a];let d=!0,p=this.activeExtensions;void 0!==s&&(p=[s],d=!1),this.packsUpdateDetails={toHandle:o.length*p.length,handled:0,updated:0,new:0,failed:0},n.empty().append(t("<div>",{class:"progress"}).append(t("<div>",{class:"progress-bar progress-bar-info",role:"progressbar","aria-valuenow":0,"aria-valuemin":0,"aria-valuemax":100,style:"width: 0;"}).append(t("<span>",{class:"text-nowrap"}).text("0 of "+this.packsUpdateDetails.toHandle+" language "+c.pluralize(this.packsUpdateDetails.toHandle)+" updated")))),i.empty(),o.forEach(t=>{p.forEach(a=>{this.getNotificationBox().empty(),new e(l.getUrl()).post({install:{action:"languagePacksUpdatePack",token:this.getModuleContent().data("language-packs-update-pack-token"),iso:t,extension:a}}).then(async t=>{const a=await t.resolve();!0===a.success?(this.packsUpdateDetails.handled++,"new"===a.packResult?this.packsUpdateDetails.new++:"update"===a.packResult?this.packsUpdateDetails.updated++:this.packsUpdateDetails.failed++,this.packUpdateDone(d,o)):(this.packsUpdateDetails.handled++,this.packsUpdateDetails.failed++,this.packUpdateDone(d,o))},()=>{this.packsUpdateDetails.handled++,this.packsUpdateDetails.failed++,this.packUpdateDone(d,o)})})})}packUpdateDone(t,a){const s=this.getModalBody(),o=this.findInModal(this.selectorOutputContainer);if(this.packsUpdateDetails.handled===this.packsUpdateDetails.toHandle){const o=i.render(d.ok,"Language packs updated",this.packsUpdateDetails.new+" new language "+c.pluralize(this.packsUpdateDetails.new)+" downloaded, "+this.packsUpdateDetails.updated+" language "+c.pluralize(this.packsUpdateDetails.updated)+" updated, "+this.packsUpdateDetails.failed+" language "+c.pluralize(this.packsUpdateDetails.failed)+" not available");this.addNotification(o),!0===t?new e(l.getUrl()).post({install:{action:"languagePacksUpdateIsoTimes",token:this.getModuleContent().data("language-packs-update-iso-times-token"),isos:a}}).then(async t=>{if(!0===(await t.resolve()).success)this.getData();else{const t=n.render(d.error,"Something went wrong","");this.addNotification(t)}},t=>{l.handleAjaxError(t,s)}):this.getData()}else{const t=this.packsUpdateDetails.handled/this.packsUpdateDetails.toHandle*100;o.find(".progress-bar").css("width",t+"%").attr("aria-valuenow",t).find("span").text(this.packsUpdateDetails.handled+" of "+this.packsUpdateDetails.toHandle+" language "+c.pluralize(this.packsUpdateDetails.handled,"pack","s",this.packsUpdateDetails.toHandle)+" updated")}}languageMatrixHtml(a){const e=this.findInModal(this.selectorActivateLanguageIcon).html(),s=this.findInModal(this.selectorDeactivateLanguageIcon).html(),n=this.findInModal(this.selectorLanguageUpdateIcon).html(),i=t("<div>"),o=t("<tbody>");return a.languages.forEach(a=>{const i=a.active,d=t("<tr>");i?o.append(d.append(t("<td>").text(" "+a.name).prepend(t("<div />",{class:"btn-group"}).append(t("<a>",{class:"btn btn-default t3js-languagePacks-deactivateLanguage","data-iso":a.iso,"data-toggle":"tooltip",title:"Deactivate"}).append(s),t("<a>",{class:"btn btn-default t3js-languagePacks-update","data-iso":a.iso,"data-toggle":"tooltip",title:"Download language packs"}).append(n))))):o.append(d.addClass("t3-languagePacks-inactive t3js-languagePacks-inactive").css({display:"none"}).append(t("<td>").text(" "+a.name).prepend(t("<div />",{class:"btn-group"}).append(t("<a>",{class:"btn btn-default t3js-languagePacks-activateLanguage","data-iso":a.iso,"data-toggle":"tooltip",title:"Activate"}).append(e))))),d.append(t("<td>").text(a.iso),t("<td>").text(a.dependencies.join(", ")),t("<td>").text(null===a.lastUpdate?"":a.lastUpdate)),o.append(d)}),i.append(t("<h3>").text("Active languages"),t("<table>",{class:"table table-striped table-bordered"}).append(t("<thead>").append(t("<tr>").append(t("<th>").append(t("<div />",{class:"btn-group"}).append(t("<button>",{class:"btn btn-default t3js-languagePacks-addLanguage-toggle",type:"button"}).append(t("<span>").append(e)," Add language"),t("<button>",{class:"btn btn-default disabled update-all t3js-languagePacks-update",type:"button",disabled:"disabled"}).append(t("<span>").append(n)," Update all"))),t("<th>").text("Locale"),t("<th>").text("Dependencies"),t("<th>").text("Last update"))),o)),Array.isArray(this.activeLanguages)&&this.activeLanguages.length&&i.find(".update-all").removeClass("disabled").removeAttr("disabled"),i.html()}extensionMatrixHtml(a){const e=new s,n=this.findInModal(this.selectorLanguageUpdateIcon).html();let o,l="",c=0;const p=t("<div>"),g=t("<tr>");g.append(t("<th>").text("Extension"),t("<th>").text("Key")),a.activeLanguages.forEach(a=>{g.append(t("<th>").append(t("<a>",{class:"btn btn-default t3js-languagePacks-update","data-iso":a,"data-toggle":"tooltip",title:"Download and update all language packs"}).append(t("<span>").append(n)," "+a)))});const r=t("<tbody>");return a.extensions.forEach(a=>{c++,o=void 0!==a.icon?t("<span>").append(t("<img>",{style:"max-height: 16px; max-width: 16px;",src:"../"+a.icon,alt:a.title}),t("<span>").text(" "+a.title)):t("<span>").text(a.title);const s=t("<tr>");s.append(t("<td>").html(o.html()),t("<td>").text(a.key)),a.packs.forEach(i=>{const o=t("<td>");s.append(o),l=!0!==i.exists?null!==i.lastUpdate?"No language pack available for "+i.iso+" when tried at "+i.lastUpdate+". Click to re-try.":"Language pack not downloaded. Click to download":null===i.lastUpdate?"Downloaded. Click to renew":"Language pack downloaded at "+i.lastUpdate+". Click to renew",o.append(t("<a>",{class:"btn btn-default t3js-languagePacks-update","data-extension":a.key,"data-iso":i.iso,"data-toggle":"tooltip",title:e.encodeHtml(l)}).append(n))}),r.append(s)}),p.append(t("<h3>").text("Translation status"),t("<table>",{class:"table table-striped table-bordered"}).append(t("<thead>").append(g),r)),0===c?i.render(d.ok,"Language packs have been found for every installed extension.","To download the latest changes, use the refresh button in the list above."):p.html()}getNotificationBox(){return this.findInModal(this.selectorNotifications)}addNotification(t){this.notifications.push(t)}renderNotifications(){const t=this.getNotificationBox();for(let a of this.notifications)t.append(a);this.notifications=[]}}return new c}));