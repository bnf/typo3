/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","nprogress","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Tooltip","TYPO3/CMS/Backend/Severity","TYPO3/CMS/Core/SecurityUtility","./Repository","./Update","./UploadForm","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Core/Event/DebounceEvent","TYPO3/CMS/Core/Event/RegularEvent","tablesort","tablesort.dotsep","TYPO3/CMS/Backend/Input/Clearable"],(function(e,t,n,o,i,s,a,r,l,c,d,u){"use strict";const p=new s;var m;!function(e){e.extensionlist="typo3-extension-list",e.searchField="#Tx_Extensionmanager_extensionkey"}(m||(m={}));let g=new class{constructor(){const s=this;e(()=>{this.Update=new r,this.UploadForm=new l,this.Repository=new a;const p=document.getElementById(m.extensionlist);let g;null!==p&&(new Tablesort(p),new u("click",(function(e){e.preventDefault(),n.confirm(TYPO3.lang["extensionList.removalConfirmation.title"],TYPO3.lang["extensionList.removalConfirmation.question"],i.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{n.dismiss()}},{text:TYPO3.lang["button.remove"],btnClass:"btn-danger",trigger:()=>{s.removeExtensionFromDisk(this),n.dismiss()}}])})).delegateTo(p,".removeExtension")),e(document).on("click",".onClickMaskExtensionManager",()=>{t.start()}).on("click","a[data-action=update-extension]",n=>{n.preventDefault(),t.start(),new c(e(n.currentTarget).attr("href")).get().then(this.updateExtension)}).on("change","input[name=unlockDependencyIgnoreButton]",t=>{e(".t3js-dependencies").toggleClass("disabled",!e(t.currentTarget).prop("checked"))}),null!==(g=document.querySelector(m.searchField))&&(new u("submit",e=>{e.preventDefault()}).bindTo(g.closest("form")),new d("keyup",e=>{this.filterExtensions(e.target)},100).bindTo(g),g.clearable({onClear:e=>{this.filterExtensions(e)}})),e(document).on("click",".t3-button-action-installdistribution",()=>{t.start()}),this.Repository.initDom(),this.Update.initializeEvents(),this.UploadForm.initializeEvents(),o.initialize("#typo3-extension-list [title]")})}static getUrlVars(){let e=[],t=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(let n of t){const[t,o]=n.split("=");e.push(t),e[t]=o}return e}filterExtensions(e){const t=document.querySelectorAll("[data-filterable]"),n=[];t.forEach(e=>{const t=Array.from(e.parentElement.children);n.push(t.indexOf(e))});const o=n.map(e=>`td:nth-child(${e+1})`).join(",");document.querySelectorAll("#typo3-extension-list tbody tr").forEach(t=>{const n=t.querySelectorAll(o),i=[];n.forEach(e=>{i.push(e.textContent.trim().replace(/\s+/g," "))}),t.classList.toggle("hidden",""!==e.value&&!RegExp(e.value,"i").test(i.join(":")))})}removeExtensionFromDisk(e){t.start(),new c(e.href).get().then(()=>{location.reload()}).finally(()=>{t.done()})}async updateExtension(o){let s=0;const a=await o.resolve(),r=e("<form>");e.each(a.updateComments,(t,n)=>{const o=e("<input>").attr({type:"radio",name:"version"}).val(t);0===s&&o.attr("checked","checked"),r.append([e("<h3>").append([o," "+p.encodeHtml(t)]),e("<div>").append(n.replace(/(\r\n|\n\r|\r|\n)/g,"\n").split(/\n/).map(e=>p.encodeHtml(e)).join("<br>"))]),s++});const l=e("<div>").append([e("<h1>").text(TYPO3.lang["extensionList.updateConfirmation.title"]),e("<h2>").text(TYPO3.lang["extensionList.updateConfirmation.message"]),r]);t.done(),n.confirm(TYPO3.lang["extensionList.updateConfirmation.questionVersionComments"],l,i.warning,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{n.dismiss()}},{text:TYPO3.lang["button.updateExtension"],btnClass:"btn-warning",trigger:()=>{t.start(),new c(a.url).withQueryArguments({tx_extensionmanager_tools_extensionmanagerextensionmanager:{version:e("input:radio[name=version]:checked",n.currentModal).val()}}).get().finally(()=>{location.reload()}),n.dismiss()}}])}};return void 0===TYPO3.ExtensionManager&&(TYPO3.ExtensionManager=g),g}));