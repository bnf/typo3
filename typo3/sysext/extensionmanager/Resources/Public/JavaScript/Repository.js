/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","nprogress","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Notification","TYPO3/CMS/Backend/Severity","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Core/Event/RegularEvent","tablesort","TYPO3/CMS/Backend/Input/Clearable"],(function(e,n,t,s,a,o,l){"use strict";return class{constructor(){this.downloadPath="",this.getDependencies=async o=>{const l=await o.resolve();n.done(),l.hasDependencies?t.confirm(l.title,e(l.message),a.info,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{t.dismiss()}},{text:TYPO3.lang["button.resolveDependencies"],btnClass:"btn-info",trigger:()=>{this.getResolveDependenciesAndInstallResult(l.url+"&tx_extensionmanager_tools_extensionmanagerextensionmanager[downloadPath]="+this.downloadPath),t.dismiss()}}]):l.hasErrors?s.error(l.title,l.message,15):this.getResolveDependenciesAndInstallResult(l.url+"&tx_extensionmanager_tools_extensionmanagerextensionmanager[downloadPath]="+this.downloadPath)}}initDom(){n.configure({parent:".module-loading-indicator",showSpinner:!1});const e=document.getElementById("terVersionTable"),t=document.getElementById("terSearchTable");null!==e&&new Tablesort(e),null!==t&&new Tablesort(t),this.bindDownload(),this.bindSearchFieldResetter()}bindDownload(){const e=this;new l("click",(function(t){t.preventDefault();const s=this.closest("form"),a=s.dataset.href;e.downloadPath=s.querySelector("input.downloadPath:checked").value,n.start(),new o(a).get().then(e.getDependencies)})).delegateTo(document,".downloadFromTer form.download button[type=submit]")}getResolveDependenciesAndInstallResult(l){n.start(),new o(l).get().then(async n=>{const o=await n.raw().json();if(o.errorCount>0)t.confirm(o.errorTitle,e(o.errorMessage),a.error,[{text:TYPO3.lang["button.cancel"],active:!0,btnClass:"btn-default",trigger:()=>{t.dismiss()}},{text:TYPO3.lang["button.resolveDependenciesIgnore"],btnClass:"btn-danger disabled t3js-dependencies",trigger:n=>{e(n.currentTarget).hasClass("disabled")||(this.getResolveDependenciesAndInstallResult(o.skipDependencyUri),t.dismiss())}}]),t.currentModal.on("shown.bs.modal",()=>{const n=t.currentModal.find(".t3js-dependencies");e('input[name="unlockDependencyIgnoreButton"]',t.currentModal).on("change",t=>{n.toggleClass("disabled",!e(t.currentTarget).prop("checked"))})});else{let n=TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.message"+o.installationTypeLanguageKey].replace(/\{0\}/g,o.extension);n+="\n"+TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.header"]+": ",e.each(o.result,(t,s)=>{n+="\n\n"+TYPO3.lang["extensionList.dependenciesResolveDownloadSuccess.item"]+" "+t+": ",e.each(s,e=>{n+="\n* "+e})}),s.info(TYPO3.lang["extensionList.dependenciesResolveFlashMessage.title"+o.installationTypeLanguageKey].replace(/\{0\}/g,o.extension),n,15),top.TYPO3.ModuleMenu.App.refreshMenu()}}).finally(()=>{n.done()})}bindSearchFieldResetter(){let e;if(null!==(e=document.querySelector('.typo3-extensionmanager-searchTerForm input[type="text"]'))){const n=""!==e.value;e.clearable({onClear:e=>{n&&e.closest("form").submit()}})}}}}));