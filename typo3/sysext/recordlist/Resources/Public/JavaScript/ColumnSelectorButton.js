/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["lit","lit/decorators","TYPO3/CMS/Backend/Enum/Severity","TYPO3/CMS/Backend/Severity","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Core/lit-helper","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Backend/Notification"],(function(e,t,o,l,r,n,s,c){"use strict";var i,a,d,u=this&&this.__decorate||function(e,t,o,l){var r,n=arguments.length,s=n<3?t:null===l?l=Object.getOwnPropertyDescriptor(t,o):l;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,l);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n<3?r(s):n>3?r(t,o,s):r(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s};!function(e){e.columnsSelector=".t3js-record-column-selector",e.columnsContainerSelector=".t3js-column-selector-container",e.columnsFilterSelector='input[name="columns-filter"]',e.columnsSelectorActionsSelector=".t3js-record-column-selector-actions"}(a||(a={})),function(e){e.toggle="select-toggle",e.all="select-all",e.none="select-none"}(d||(d={}));let p=i=class extends e.LitElement{constructor(){super(),this.title="Show columns",this.ok=n.lll("button.ok")||"Update",this.close=n.lll("button.close")||"Close",this.error="Could not update columns",this.addEventListener("click",e=>{e.preventDefault(),this.showColumnSelectorModal()})}static toggleSelectorActions(e,t,o,l=!1){t.classList.add("disabled");for(let o=0;o<e.length;o++)if(!e[o].disabled&&!e[o].checked&&(l||!i.isColumnHidden(e[o]))){t.classList.remove("disabled");break}o.classList.add("disabled");for(let t=0;t<e.length;t++)if(!e[t].disabled&&e[t].checked&&(l||!i.isColumnHidden(e[t]))){o.classList.remove("disabled");break}}static isColumnHidden(e){var t;return null===(t=e.closest(a.columnsContainerSelector))||void 0===t?void 0:t.classList.contains("hidden")}static filterColumns(e,t){t.forEach(t=>{var o;const l=t.closest(a.columnsContainerSelector);if(!t.disabled&&null!==l){const t=null===(o=l.querySelector(".form-check-label-text"))||void 0===o?void 0:o.textContent;t&&t.length&&l.classList.toggle("hidden",""!==e.value&&!RegExp(e.value,"i").test(t.trim().replace(/\[\]/g,"").replace(/\s+/g," ")))}})}render(){return e.html`<slot></slot>`}showColumnSelectorModal(){this.url&&this.target&&r.advanced({content:this.url,title:this.title,severity:o.SeverityEnum.notice,size:r.sizes.medium,type:r.types.ajax,buttons:[{text:this.close,active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>r.dismiss()},{text:this.ok,btnClass:"btn-"+l.getCssClass(o.SeverityEnum.info),name:"update",trigger:()=>this.proccessSelection(r.currentModal[0])}],ajaxCallback:()=>this.handleModalContentLoaded(r.currentModal[0])})}proccessSelection(e){const t=e.querySelector("form");null!==t?new s(TYPO3.settings.ajaxUrls.record_show_columns).post("",{body:new FormData(t)}).then(async e=>{const t=await e.resolve();!0===t.success?(this.ownerDocument.location.href=this.target,this.ownerDocument.location.reload(!0)):c.error(t.message||"No update was performed"),r.dismiss()}).catch(()=>{this.abortSelection()}):this.abortSelection()}handleModalContentLoaded(e){const t=e.querySelector("form");if(null===t)return;t.addEventListener("submit",e=>{e.preventDefault()});const o=e.querySelectorAll(a.columnsSelector),l=e.querySelector(a.columnsFilterSelector),r=e.querySelector(a.columnsSelectorActionsSelector),n=r.querySelector('button[data-action="'+d.all+'"]'),s=r.querySelector('button[data-action="'+d.none+'"]');o.length&&null!==l&&null!==n&&null!==s&&(i.toggleSelectorActions(o,n,s,!0),o.forEach(e=>{e.addEventListener("change",()=>{i.toggleSelectorActions(o,n,s)})}),l.addEventListener("keydown",e=>{const t=e.target;"Escape"===e.code&&(e.stopImmediatePropagation(),t.value="")}),l.addEventListener("keyup",e=>{i.filterColumns(e.target,o),i.toggleSelectorActions(o,n,s)}),l.addEventListener("search",e=>{i.filterColumns(e.target,o),i.toggleSelectorActions(o,n,s)}),r.querySelectorAll("button[data-action]").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget;if(t.dataset.action){switch(t.dataset.action){case d.toggle:o.forEach(e=>{e.disabled||i.isColumnHidden(e)||(e.checked=!e.checked)});break;case d.all:o.forEach(e=>{e.disabled||i.isColumnHidden(e)||(e.checked=!0)});break;case d.none:o.forEach(e=>{e.disabled||i.isColumnHidden(e)||(e.checked=!1)});break;default:c.warning("Unknown selector action")}i.toggleSelectorActions(o,n,s)}})}))}abortSelection(){c.error(this.error),r.dismiss()}};u([t.property({type:String})],p.prototype,"url",void 0),u([t.property({type:String})],p.prototype,"target",void 0),u([t.property({type:String})],p.prototype,"title",void 0),u([t.property({type:String})],p.prototype,"ok",void 0),u([t.property({type:String})],p.prototype,"close",void 0),u([t.property({type:String})],p.prototype,"error",void 0),p=i=u([t.customElement("typo3-recordlist-column-selector-button")],p)}));