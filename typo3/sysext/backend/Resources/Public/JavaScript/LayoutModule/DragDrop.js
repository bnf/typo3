/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","../AjaxDataHandler","../Icons","jquery-ui/droppable"],(function(e,t,a){"use strict";class n{static get default(){return console.warn("The property .default of module DragDrop has been deprecated, use DragDrop directly."),this}static initialize(){e(n.contentIdentifier).draggable({handle:n.dragHeaderIdentifier,scope:"tt_content",cursor:"move",distance:20,revert:"invalid",zIndex:100,start:t=>{n.onDragStart(e(t.target))},stop:t=>{n.onDragStop(e(t.target))}}),e(n.dropZoneIdentifier).droppable({accept:this.contentIdentifier,scope:"tt_content",tolerance:"pointer",over:(t,a)=>{n.onDropHoverOver(e(a.draggable),e(t.target))},out:(t,a)=>{n.onDropHoverOut(e(a.draggable),e(t.target))},drop:(t,a)=>{n.onDrop(e(a.draggable),e(t.target),t)}})}static onDragStart(t){n.originalStyles=t.get(0).style.cssText,t.children(n.dragIdentifier).addClass("dragitem-shadow"),t.append('<div class="ui-draggable-copy-message">'+TYPO3.lang["dragdrop.copy.message"]+"</div>"),t.children(n.dropZoneIdentifier).addClass("drag-start"),t.closest(n.columnIdentifier).removeClass("active"),t.find(n.dropZoneIdentifier).hide(),e(n.dropZoneIdentifier).each((t,a)=>{const o=e(a);o.parent().find(".t3js-toggle-new-content-element-wizard").length?o.addClass(n.validDropZoneClass):o.closest(n.contentIdentifier).find("> "+n.addContentIdentifier+", > > "+n.addContentIdentifier).show()})}static onDragStop(t){t.children(n.dragIdentifier).removeClass("dragitem-shadow"),t.children(n.dropZoneIdentifier).removeClass("drag-start"),t.closest(n.columnIdentifier).addClass("active"),t.find(n.dropZoneIdentifier).show(),t.find(".ui-draggable-copy-message").remove(),t.get(0).style.cssText=n.originalStyles,e(n.dropZoneIdentifier+"."+n.validDropZoneClass).removeClass(n.validDropZoneClass)}static onDropHoverOver(e,t){t.hasClass(n.validDropZoneClass)&&t.addClass(n.dropPossibleHoverClass)}static onDropHoverOut(e,t){t.removeClass(n.dropPossibleHoverClass)}static onDrop(t,o,s){const r=n.getColumnPositionForElement(o);o.removeClass(n.dropPossibleHoverClass);const d=parseInt(t.data("uid"),10);if("number"==typeof d&&d>0){let i={};const l=o.closest(n.contentIdentifier).data("uid");let c=0;c=void 0===l?parseInt(s.target.offsetParent.getAttribute("data-page"),10):0-parseInt(l,10);let g=parseInt(t.data("language-uid"),10);-1!==g&&(g=parseInt(o.closest("[data-language-uid]").data("language-uid"),10));let p=0;0!==c&&(p=r),i.cmd={tt_content:{}},i.data={tt_content:{}};const f=s&&s.originalEvent.ctrlKey||o.hasClass("t3js-paste-copy");f?i.cmd.tt_content[d]={copy:{action:"paste",target:c,update:{colPos:p,sys_language_uid:g}}}:(i.data.tt_content[d]={colPos:p,sys_language_uid:g},i.cmd.tt_content[d]={move:c}),n.ajaxAction(o,t,i,f).then(()=>{const n=e(`.t3-page-column-lang-name[data-language-uid="${g}"]`);if(0===n.length)return;const o=n.data("flagIdentifier"),s=n.data("languageTitle");t.find(".t3js-language-title").text(s),a.getIcon(o,a.sizes.small).then(e=>{t.find(".t3js-flag").attr("title",s).html(e)})})}}static ajaxAction(e,a,o,s){return t.process(o).then(t=>{if(t.hasErrors)throw t.messages;e.parent().hasClass(n.contentIdentifier.substring(1))?a.detach().css({top:0,left:0}).insertAfter(e.closest(n.contentIdentifier)):a.detach().css({top:0,left:0}).insertAfter(e.closest(n.dropZoneIdentifier)),s&&self.location.reload()})}static getColumnPositionForElement(e){const t=e.closest("[data-colpos]");return!(!t.length||"undefined"===t.data("colpos"))&&t.data("colpos")}}return n.contentIdentifier=".t3js-page-ce",n.dragIdentifier=".t3-page-ce-dragitem",n.dragHeaderIdentifier=".t3js-page-ce-draghandle",n.dropZoneIdentifier=".t3js-page-ce-dropzone-available",n.columnIdentifier=".t3js-page-column",n.validDropZoneClass="active",n.dropPossibleHoverClass="t3-page-ce-dropzone-possible",n.addContentIdentifier=".t3js-page-new-ce",n.originalStyles="",n}));