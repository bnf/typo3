/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import interact from"interactjs";import DocumentService from"@typo3/core/document-service.js";import DataHandler from"@typo3/backend/ajax-data-handler.js";import Icons from"@typo3/backend/icons.js";class DragDrop{constructor(){DocumentService.ready().then((()=>{DragDrop.initialize()}))}static initialize(){interact(DragDrop.draggableContentIdentifier).draggable({allowFrom:DragDrop.draggableContentHandleIdentifier,onstart:DragDrop.onDragStart,onmove:DragDrop.onDragMove,onend:DragDrop.onDragEnd,autoScroll:{interval:10,speed:1250}}).pointerEvents({allowFrom:DragDrop.draggableContentHandleIdentifier}).on("move",(function(e){const t=e.interaction,a=e.currentTarget;if(t.pointerIsDown&&!t.interacting()&&"false"!=a.getAttribute("clone")){const r=a.cloneNode(!0);r.setAttribute("data-dragdrop-clone","true"),r.style.width=a.offsetWidth.toString()+"px",a.parentNode.insertBefore(r,a),t.start({name:"drag"},e.interactable,a)}})),interact(DragDrop.dropZoneIdentifier).dropzone({accept:this.draggableContentIdentifier,ondrop:DragDrop.onDrop}).on("dragenter",(e=>{e.target.classList.add(DragDrop.dropPossibleHoverClass)})).on("dragleave",(e=>{e.target.classList.remove(DragDrop.dropPossibleHoverClass)}))}static onDragStart(e){e.target.classList.add("draggable-dragging");const t=document.createElement("div");t.classList.add("draggable-copy-message"),t.textContent=TYPO3.lang["dragdrop.copy.message"],e.target.append(t),e.target.closest(DragDrop.columnIdentifier).classList.remove("active"),document.querySelectorAll(DragDrop.dropZoneIdentifier).forEach((e=>{const t=e.parentElement.querySelector(DragDrop.addContentIdentifier);null!==t&&(t.hidden=!0,e.classList.add(DragDrop.validDropZoneClass))}))}static onDragMove(e){const t=e.target,a=(parseFloat(t.getAttribute("data-x"))||0)+e.dx,r=(parseFloat(t.getAttribute("data-y"))||0)+e.dy;t.style.transform="translate("+a+"px, "+r+"px)",t.setAttribute("data-x",a.toString()),t.setAttribute("data-y",r.toString())}static onDragEnd(e){e.target.classList.remove("draggable-dragging"),e.target.style.transform="unset",e.target.setAttribute("data-x","0"),e.target.setAttribute("data-y","0"),e.target.closest(DragDrop.columnIdentifier).classList.add("active"),e.target.querySelector(DragDrop.dropZoneIdentifier).hidden=!1,e.target.querySelector(".draggable-copy-message").remove(),document.querySelectorAll(DragDrop.dropZoneIdentifier+"."+DragDrop.validDropZoneClass).forEach((e=>{const t=e.parentElement.querySelector(DragDrop.addContentIdentifier);null!==t&&(t.hidden=!1),e.classList.remove(DragDrop.validDropZoneClass)})),document.querySelectorAll(DragDrop.draggableContentCloneIdentifier).forEach((e=>{e.remove()}))}static onDrop(e){const t=e.target,a=e.relatedTarget,r=DragDrop.getColumnPositionForElement(t),o=parseInt(a.dataset.uid,10);if("number"==typeof o&&o>0){const n={},s=t.closest(DragDrop.contentIdentifier).dataset.uid;let i;i=void 0===s?parseInt(t.closest("[data-page]").dataset.page,10):0-parseInt(s,10);let d=parseInt(a.dataset.languageUid,10);-1!==d&&(d=parseInt(t.closest("[data-language-uid]").dataset.languageUid,10));let g=0;0!==i&&(g=r);const l=e.dragEvent.ctrlKey||t.classList.contains("t3js-paste-copy"),c=l?"copy":"move";n.cmd={tt_content:{[o]:{[c]:{action:"paste",target:i,update:{colPos:g,sys_language_uid:d}}}}},DragDrop.ajaxAction(t,a,n,l).then((()=>{const e=document.querySelector(`.t3-page-column-lang-name[data-language-uid="${d}"]`);if(null===e)return;const t=e.dataset.flagIdentifier,r=e.dataset.languageTitle;Icons.getIcon(t,Icons.sizes.small).then((e=>{const t=a.querySelector(".t3js-flag");t.title=r,t.innerHTML=e}))}))}}static ajaxAction(e,t,a,r){const o=Object.keys(a.cmd).shift(),n=parseInt(Object.keys(a.cmd[o]).shift(),10),s={component:"dragdrop",action:r?"copy":"move",table:o,uid:n},i=document.querySelector(".t3-grid-container");return DataHandler.process(a,s).then((a=>{if(a.hasErrors)throw a.messages;e.parentElement.classList.contains(DragDrop.contentIdentifier.substring(1))?e.closest(DragDrop.contentIdentifier).after(t):e.closest(DragDrop.dropZoneIdentifier).after(t),(r||"1"===i?.dataset.defaultLanguageBinding)&&self.location.reload()}))}static getColumnPositionForElement(e){const t=e.closest("[data-colpos]");return null!==t&&void 0!==t.dataset.colpos&&parseInt(t.dataset.colpos,10)}}DragDrop.contentIdentifier=".t3js-page-ce",DragDrop.draggableContentIdentifier=".t3js-page-ce-sortable",DragDrop.draggableContentHandleIdentifier=".t3js-page-ce-draghandle",DragDrop.draggableContentCloneIdentifier="[data-dragdrop-clone]",DragDrop.dropZoneIdentifier=".t3js-page-ce-dropzone-available",DragDrop.columnIdentifier=".t3js-page-column",DragDrop.validDropZoneClass="active",DragDrop.dropPossibleHoverClass="t3-page-ce-dropzone-possible",DragDrop.addContentIdentifier=".t3js-page-new-ce";export default new DragDrop;