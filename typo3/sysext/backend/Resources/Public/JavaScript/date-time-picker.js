/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import flatpickr from"flatpickr/flatpickr.min.js";import ShortcutButtonsPlugin from"flatpickr/plugins/shortcut-buttons.min.js";import{DateTime}from"luxon";class DateTimePicker{constructor(){this.format=(void 0!==opener?.top?.TYPO3?opener.top:top).TYPO3.settings.DateTimePicker.DateFormat}static formatDateForHiddenField(e,t){return"time"!==t&&"timesec"!==t||(e=e.set({year:1970,month:1,day:1})),e.toISO({suppressMilliseconds:!0})}initialize(e){if(!(e instanceof HTMLInputElement)||void 0!==e.dataset.datepickerInitialized)return;let t=document.documentElement.lang;t&&"en"!==t?"ch"===t&&(t="zh"):t="default",e.dataset.datepickerInitialized="1",import("flatpickr/locales.js").then((()=>{this.initializeField(e,t)}))}initializeField(e,t){const a=this.getDateOptions(e);a.locale=t;const i=flatpickr(e,a);e.addEventListener("input",(()=>{const e=i._input.value,t=i.parseDate(e);e===i.formatDate(t,i.config.dateFormat)&&i.setDate(e)})),e.addEventListener("keyup",(e=>{"Escape"===e.key&&i.close()})),e.addEventListener("change",(t=>{t.stopImmediatePropagation();const a=t.target,i=e.parentElement.parentElement.querySelector('input[type="hidden"]');if(""!==a.value){const e=a.dataset.dateType,t=DateTime.fromFormat(a.value,a._flatpickr.config.dateFormat,{zone:"utc"});t.isValid?i.value=DateTimePicker.formatDateForHiddenField(t,e):a.value=DateTimePicker.formatDateForHiddenField(DateTime.fromISO(i.value,{zone:"utc"}),e)}else i.value="";a.dispatchEvent(new Event("formengine.dp.change"))}))}getDateOptions(e){const t=this.format,a=e.dataset.dateType,i=new Date,n={allowInput:!0,dateFormat:"",defaultDate:e.value,defaultHour:i.getHours(),defaultMinute:i.getMinutes(),enableSeconds:!1,enableTime:!1,formatDate:(e,t)=>DateTime.fromJSDate(e).toFormat(t),parseDate:(e,t)=>DateTime.fromFormat(e,t).toJSDate(),maxDate:"",minDate:"",minuteIncrement:1,noCalendar:!1,weekNumbers:!0,time_24hr:!Intl.DateTimeFormat(navigator.language,{hour:"numeric"}).resolvedOptions().hour12,plugins:[ShortcutButtonsPlugin({theme:"typo3",button:[{label:top.TYPO3.lang["labels.datepicker.today"]||"Today"}],onClick:(e,t)=>{t.setDate(new Date,!0)}})]};switch(a){case"datetime":n.dateFormat=t[1],n.enableTime=!0;break;case"date":n.dateFormat=t[0];break;case"time":n.dateFormat="HH:mm",n.enableTime=!0,n.noCalendar=!0;break;case"timesec":n.dateFormat="HH:mm:ss",n.enableSeconds=!0,n.enableTime=!0,n.noCalendar=!0;break;case"year":n.dateFormat="yyyy"}return"undefined"!==e.dataset.dateMindate&&(n.minDate=e.dataset.dateMindate),"undefined"!==e.dataset.dateMaxdate&&(n.maxDate=e.dataset.dateMaxdate),n}}export default new DateTimePicker;