/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["jquery","./Enum/Severity","TYPO3/CMS/Core/Ajax/AjaxRequest","./Icons","./Wizard"],(function(e,a,t,l,s){"use strict";return new class{constructor(){this.triggerButton=".t3js-localize",this.localizationMode=null,this.sourceLanguage=null,this.records=[],e(()=>{this.initialize()})}initialize(){const t=this;l.getIcon("actions-localize",l.sizes.large).then(i=>{l.getIcon("actions-edit-copy",l.sizes.large).then(o=>{e(t.triggerButton).removeClass("disabled"),e(document).on("click",t.triggerButton,t=>{t.preventDefault();const n=e(t.currentTarget),c=[];let d="";n.data("allowTranslate")&&c.push('<div class="row"><div class="col-sm-3"><label class="btn btn-block btn-default t3js-localization-option" data-helptext=".t3js-helptext-translate">'+i+'<input type="radio" name="mode" id="mode_translate" value="localize" style="display: none"><br>'+TYPO3.lang["localize.wizard.button.translate"]+'</label></div><div class="col-sm-9"><p class="t3js-helptext t3js-helptext-translate text-muted">'+TYPO3.lang["localize.educate.translate"]+"</p></div></div>"),n.data("allowCopy")&&c.push('<div class="row"><div class="col-sm-3"><label class="btn btn-block btn-default t3js-localization-option" data-helptext=".t3js-helptext-copy">'+o+'<input type="radio" name="mode" id="mode_copy" value="copyFromLanguage" style="display: none"><br>'+TYPO3.lang["localize.wizard.button.copy"]+'</label></div><div class="col-sm-9"><p class="t3js-helptext t3js-helptext-copy text-muted">'+TYPO3.lang["localize.educate.copy"]+"</p></div></div>"),0===n.data("allowTranslate")&&0===n.data("allowCopy")&&c.push('<div class="row"><div class="col-sm-12"><div class="alert alert-warning"><div class="media"><div class="media-left"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-exclamation fa-stack-1x"></i></span></div><div class="media-body"><p class="alert-message">'+TYPO3.lang["localize.educate.noTranslate"]+"</p></div></div></div></div></div>"),d+='<div data-bs-toggle="buttons">'+c.join("<hr>")+"</div>",s.addSlide("localize-choose-action",TYPO3.lang["localize.wizard.header_page"].replace("{0}",n.data("page")).replace("{1}",n.data("languageName")),d,a.SeverityEnum.info),s.addSlide("localize-choose-language",TYPO3.lang["localize.view.chooseLanguage"],"",a.SeverityEnum.info,a=>{l.getIcon("spinner-circle-dark",l.sizes.large).then(t=>{a.html('<div class="text-center">'+t+"</div>"),this.loadAvailableLanguages(parseInt(n.data("pageId"),10),parseInt(n.data("languageId"),10)).then(async t=>{const l=await t.resolve();if(1===l.length)return this.sourceLanguage=l[0].uid,void s.unlockNextStep().trigger("click");s.getComponent().on("click",".t3js-language-option",a=>{const t=e(a.currentTarget).find('input[type="radio"]');this.sourceLanguage=t.val(),console.log("Localization.ts@132",this.sourceLanguage),s.unlockNextStep()});const i=e("<div />",{class:"row","data-bs-toggle":"buttons"});for(const a of l)i.append(e("<div />",{class:"col-sm-4"}).append(e("<label />",{class:"btn btn-default btn-block t3js-language-option option"}).text(" "+a.title).prepend(a.flagIcon).prepend(e("<input />",{type:"radio",name:"language",id:"language"+a.uid,value:a.uid,style:"display: none;"}))));a.empty().append(i)})})}),s.addSlide("localize-summary",TYPO3.lang["localize.view.summary"],"",a.SeverityEnum.info,a=>{l.getIcon("spinner-circle-dark",l.sizes.large).then(e=>{a.html('<div class="text-center">'+e+"</div>")}),this.getSummary(parseInt(n.data("pageId"),10),parseInt(n.data("languageId"),10)).then(async t=>{const l=await t.resolve();a.empty(),this.records=[];const i=l.columns.columns;l.columns.columnList.forEach(t=>{if(void 0===l.records[t])return;const s=i[t],o=e("<div />",{class:"row"});l.records[t].forEach(a=>{const t=" ("+a.uid+") "+a.title;this.records.push(a.uid),o.append(e("<div />",{class:"col-sm-6"}).append(e("<div />",{class:"input-group"}).append(e("<span />",{class:"input-group-addon"}).append(e("<input />",{type:"checkbox",class:"t3js-localization-toggle-record",id:"record-uid-"+a.uid,checked:"checked","data-uid":a.uid,"aria-label":t})),e("<label />",{class:"form-control",for:"record-uid-"+a.uid}).text(t).prepend(a.icon))))}),a.append(e("<fieldset />",{class:"localization-fieldset"}).append(e("<label />").text(s).prepend(e("<input />",{class:"t3js-localization-toggle-column",type:"checkbox",checked:"checked"})),o))}),s.unlockNextStep(),s.getComponent().on("change",".t3js-localization-toggle-record",a=>{const t=e(a.currentTarget),l=t.data("uid"),i=t.closest("fieldset"),o=i.find(".t3js-localization-toggle-column");if(t.is(":checked"))this.records.push(l);else{const e=this.records.indexOf(l);e>-1&&this.records.splice(e,1)}const n=i.find(".t3js-localization-toggle-record"),c=i.find(".t3js-localization-toggle-record:checked");o.prop("checked",c.length>0),o.prop("indeterminate",c.length>0&&c.length<n.length),this.records.length>0?s.unlockNextStep():s.lockNextStep()}).on("change",".t3js-localization-toggle-column",a=>{const t=e(a.currentTarget),l=t.closest("fieldset").find(".t3js-localization-toggle-record");l.prop("checked",t.is(":checked")),l.trigger("change")})})}),s.addFinalProcessingSlide(()=>{this.localizeRecords(parseInt(n.data("pageId"),10),parseInt(n.data("languageId"),10),this.records).then(()=>{s.dismiss(),document.location.reload()})}).then(()=>{s.show(),s.getComponent().on("click",".t3js-localization-option",a=>{const t=e(a.currentTarget),l=t.find('input[type="radio"]');if(t.data("helptext")){const l=e(a.delegateTarget);l.find(".t3js-localization-option").removeClass("active"),l.find(".t3js-helptext").addClass("text-muted"),t.addClass("active"),l.find(t.data("helptext")).removeClass("text-muted")}this.localizationMode=l.val(),s.unlockNextStep()})})})})})}loadAvailableLanguages(e,a){return new t(TYPO3.settings.ajaxUrls.page_languages).withQueryArguments({pageId:e,languageId:a}).get()}getSummary(e,a){return new t(TYPO3.settings.ajaxUrls.records_localize_summary).withQueryArguments({pageId:e,destLanguageId:a,languageId:this.sourceLanguage}).get()}localizeRecords(e,a,l){return new t(TYPO3.settings.ajaxUrls.records_localize).withQueryArguments({pageId:e,srcLanguageId:this.sourceLanguage,destLanguageId:a,action:this.localizationMode,uidList:l}).get()}}}));