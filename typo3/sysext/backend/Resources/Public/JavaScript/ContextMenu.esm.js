/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import AjaxRequest from"TYPO3/CMS/Core/Ajax/AjaxRequest";import ContextMenuActions from"TYPO3/CMS/Backend/ContextMenuActions";import ThrottleEvent from"TYPO3/CMS/Core/Event/ThrottleEvent";class ContextMenu{constructor(){this.mousePos={X:null,Y:null},this.delayContextMenuHide=!1,this.record={uid:null,table:null},this.eventSources=[],this.closeMenuTimeout={},this.storeMousePositionEvent=t=>{this.mousePos={X:t.pageX,Y:t.pageY},this.mouseOutFromMenu("#contentMenu0"),this.mouseOutFromMenu("#contentMenu1")},$(document).on("click contextmenu",".t3js-contextmenutrigger",t=>{const e=$(t.currentTarget);e.prop("onclick")&&"click"===t.type||(t.preventDefault(),this.show(e.data("table"),e.data("uid"),e.data("context"),e.data("iteminfo"),e.data("parameters"),t.target))}),new ThrottleEvent("mousemove",this.storeMousePositionEvent.bind(this),50).bindTo(document)}static drawActionItem(t){const e=t.additionalAttributes||{};let s="";for(const t of Object.entries(e)){const[e,i]=t;s+=" "+e+'="'+i+'"'}return'<li role="menuitem" class="list-group-item" tabindex="-1" data-callback-action="'+t.callbackAction+'"'+s+'><span class="list-group-item-icon">'+t.icon+"</span> "+t.label+"</li>"}static within(t,e,s){const i=t.offset();return s>=i.top&&s<i.top+t.height()&&e>=i.left&&e<i.left+t.width()}static initializeContextMenuContainer(){if(0===$("#contentMenu0").length){const t='<div id="contentMenu0" class="context-menu" style="display: none;"></div><div id="contentMenu1" class="context-menu" style="display: none;"></div>';$("body").append(t)}}show(t,e,s,i,n,o=null){this.hideAll(),this.closeMenuTimeout={},this.record={table:t,uid:e};const u=o.matches("a, button, [tabindex]")?o:o.closest("a, button, [tabindex]");this.eventSources.push(u);let l="";void 0!==t&&(l+="table="+encodeURIComponent(t)),void 0!==e&&(l+=(l.length>0?"&":"")+"uid="+e),void 0!==s&&(l+=(l.length>0?"&":"")+"context="+s),void 0!==i&&(l+=(l.length>0?"&":"")+"enDisItems="+i),void 0!==n&&(l+=(l.length>0?"&":"")+"addParams="+n),this.fetch(l)}fetch(t){const e=TYPO3.settings.ajaxUrls.contextmenu;new AjaxRequest(e).withQueryArguments(t).get().then(async t=>{const e=await t.resolve();void 0!==t&&Object.keys(t).length>0&&this.populateData(e,0)})}populateData(t,e){ContextMenu.initializeContextMenuContainer();const s=$("#contentMenu"+e);if(s.length&&(0===e||$("#contentMenu"+(e-1)).is(":visible"))){const i=this.drawMenu(t,e);s.html('<ul class="list-group" role="menu">'+i+"</ul>"),$("li.list-group-item",s).on("click",t=>{t.preventDefault();const s=$(t.currentTarget);if(s.hasClass("list-group-item-submenu"))return void this.openSubmenu(e,s,!1);const i=s.data("callback-action"),n=s.data("callback-module");s.data("callback-module")?import(n).then(({default:t})=>{t[i].bind(s)(this.record.table,this.record.uid)}):ContextMenuActions&&"function"==typeof ContextMenuActions[i]?ContextMenuActions[i].bind(s)(this.record.table,this.record.uid):console.log("action: "+i+" not found"),this.hideAll()}),$("li.list-group-item",s).on("keydown",t=>{const s=$(t.currentTarget);switch(t.key){case"Down":case"ArrowDown":this.setFocusToNextItem(s.get(0));break;case"Up":case"ArrowUp":this.setFocusToPreviousItem(s.get(0));break;case"Right":case"ArrowRight":if(!s.hasClass("list-group-item-submenu"))return;this.openSubmenu(e,s,!0);break;case"Home":this.setFocusToFirstItem(s.get(0));break;case"End":this.setFocusToLastItem(s.get(0));break;case"Enter":case"Space":s.click();break;case"Esc":case"Escape":case"Left":case"ArrowLeft":this.hide("#"+s.parents(".context-menu").first().attr("id"));break;case"Tab":this.hideAll();break;default:return}t.preventDefault()}),s.css(this.getPosition(s,!1)).show(),$("li.list-group-item[tabindex=-1]",s).first().focus()}}setFocusToPreviousItem(t){let e=this.getItemBackward(t.previousElementSibling);e||(e=this.getLastItem(t)),e.focus()}setFocusToNextItem(t){let e=this.getItemForward(t.nextElementSibling);e||(e=this.getFirstItem(t)),e.focus()}setFocusToFirstItem(t){let e=this.getFirstItem(t);e&&e.focus()}setFocusToLastItem(t){let e=this.getLastItem(t);e&&e.focus()}getItemBackward(t){for(;t&&(!t.classList.contains("list-group-item")||"-1"!==t.getAttribute("tabindex"));)t=t.previousElementSibling;return t}getItemForward(t){for(;t&&(!t.classList.contains("list-group-item")||"-1"!==t.getAttribute("tabindex"));)t=t.nextElementSibling;return t}getFirstItem(t){return this.getItemForward(t.parentElement.firstElementChild)}getLastItem(t){return this.getItemBackward(t.parentElement.lastElementChild)}openSubmenu(t,e,s){this.eventSources.push(e[0]);const i=$("#contentMenu"+(t+1)).html("");e.next().find(".list-group").clone(!0).appendTo(i),i.css(this.getPosition(i,s)).show(),$(".list-group-item[tabindex=-1]",i).first().focus()}getPosition(t,e){let s=0,i=0;if(this.eventSources.length&&(null===this.mousePos.X||e)){const t=this.eventSources[this.eventSources.length-1].getBoundingClientRect();s=this.eventSources.length>1?t.right:t.x,i=t.y}else s=this.mousePos.X,i=this.mousePos.Y;const n=$(window).width()-20,o=$(window).height(),u=t.width(),l=t.height(),a=s-$(document).scrollLeft(),c=i-$(document).scrollTop();return o-l<c&&(c>l?i-=l-10:i+=o-l-c),n-u<a&&(a>u?s-=u-10:n-u-a<$(document).scrollLeft()?s=$(document).scrollLeft():s+=n-u-a),{left:s+"px",top:i+"px"}}drawMenu(t,e){let s="";for(const i of Object.values(t))if("item"===i.type)s+=ContextMenu.drawActionItem(i);else if("divider"===i.type)s+='<li role="separator" class="list-group-item list-group-item-divider"></li>';else if("submenu"===i.type||i.childItems){s+='<li role="menuitem" aria-haspopup="true" class="list-group-item list-group-item-submenu" tabindex="-1"><span class="list-group-item-icon">'+i.icon+"</span> "+i.label+'&nbsp;&nbsp;<span class="fa fa-caret-right"></span></li>';s+='<div class="context-menu contentMenu'+(e+1)+'" style="display:none;"><ul role="menu" class="list-group">'+this.drawMenu(i.childItems,1)+"</ul></div>"}return s}mouseOutFromMenu(t){const e=$(t);e.length>0&&e.is(":visible")&&!ContextMenu.within(e,this.mousePos.X,this.mousePos.Y)?this.hide(t):e.length>0&&e.is(":visible")&&(this.delayContextMenuHide=!0,window.clearTimeout(this.closeMenuTimeout[t]))}hide(t,e=!0){this.delayContextMenuHide=!1,window.clearTimeout(this.closeMenuTimeout[t]);const s=()=>{if(!this.delayContextMenuHide){$(t).hide();const e=this.eventSources.pop();e&&$(e).focus()}};e?this.closeMenuTimeout[t]=window.setTimeout(s,500):s()}hideAll(){this.hide("#contentMenu0",!1),this.hide("#contentMenu1",!1)}}export default new ContextMenu;