/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var Identifiers,Sizes,Styles,Types,__decorate=function(t,e,a,o){var n,s=arguments.length,i=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,a):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,a,o);else for(var l=t.length-1;l>=0;l--)(n=t[l])&&(i=(s<3?n(i):s>3?n(e,a,i):n(e,a))||i);return s>3&&i&&Object.defineProperty(e,a,i),i};import{Modal as BootstrapModal}from"bootstrap";import{html,nothing,LitElement}from"lit";import{customElement,property,state}from"lit/decorators.js";import{unsafeHTML}from"lit/directives/unsafe-html.js";import{styleMap}from"lit/directives/style-map.js";import{ifDefined}from"lit/directives/if-defined.js";import RegularEvent from"@typo3/core/event/regular-event.js";import"@typo3/backend/element/icon-element.js";import"@typo3/backend/element/spinner-element.js";import $ from"jquery";import{SeverityEnum}from"@typo3/backend/enum/severity.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import SecurityUtility from"@typo3/core/security-utility.js";import Severity from"@typo3/backend/severity.js";!function(t){t.modal=".t3js-modal",t.content=".t3js-modal-content",t.close=".t3js-modal-close",t.body=".t3js-modal-body",t.footer=".t3js-modal-footer"}(Identifiers||(Identifiers={})),function(t){t.small="small",t.default="default",t.medium="medium",t.large="large",t.full="full"}(Sizes||(Sizes={})),function(t){t.default="default",t.light="light",t.dark="dark"}(Styles||(Styles={})),function(t){t.default="default",t.string="string",t.ajax="ajax",t.iframe="iframe"}(Types||(Types={}));const securityUtility=new SecurityUtility;let ModalElement=class extends LitElement{constructor(){super(...arguments),this.title="",this.content="",this.type=Types.default,this.severity=SeverityEnum.notice,this.variant=Styles.default,this.size=Sizes.default,this.zindex=null,this.additionalCssClasses=[],this.buttons=[],this.activeButton=null,this.ajaxContent=null,this.bootstrapModal=null,this.callback=null,this.ajaxCallback=null,this.userData={}}hideModal(){this.bootstrapModal&&this.bootstrapModal.hide()}trigger(t){this.dispatchEvent(new CustomEvent(t,{bubbles:!0}))}createRenderRoot(){return this}firstUpdated(){this.bootstrapModal=new BootstrapModal(this.renderRoot.querySelector(".t3js-modal"),{}),this.bootstrapModal.show(),this.callback&&this.callback(this)}render(){const t={};return null!==this.zindex&&(t.zIndex=this.zindex),html`
      <div style=${styleMap(t)} class="t3js-modal modal fade ${this.additionalCssClasses.join(" ")} modal-type-${this.type} modal-severity-${Severity.getCssClass(this.severity)} modal-style-${this.variant} modal-size-${this.size}" tabindex="-1">
          <div class="modal-dialog">
              <div class="t3js-modal-content modal-content">
                  <div class="modal-header">
                      <h4 class="t3js-modal-title modal-title">${this.title}</h4>
                      <button class="t3js-modal-close close" @click=${()=>this.bootstrapModal.hide()}>
                          <span aria-hidden="true">
                              <typo3-backend-icon identifier="actions-close" size="small"></typo3-backend-icon>
                          </span>
                          <span class="sr-only"></span>
                      </button>
                  </div>
                  <div class="t3js-modal-body modal-body">${this.renderModalBody()}</div>
                  ${0===this.buttons.length?nothing:html`
                    <div class="t3js-modal-footer modal-footer">
                      ${this.buttons.map(t=>this.renderModalButton(t))}
                    </div>
                  `}
              </div>
          </div>
      </div>
    `}_buttonClick(t,e){e.action?(this.activeButton=e,e.action.execute(t.currentTarget).then(()=>this.bootstrapModal.hide())):e.trigger&&e.trigger(t),t.currentTarget.dispatchEvent(new CustomEvent("button.clicked",{bubbles:!0}))}renderAjaxBody(){return null===this.ajaxContent?(new AjaxRequest(this.content).get().then(async t=>{const e=await t.raw().text();this.ajaxContent=html`${unsafeHTML(e)}`,this.updateComplete.then(()=>{this.ajaxCallback&&this.ajaxCallback(this),this.dispatchEvent(new CustomEvent("modal-loaded"))})}).catch(async t=>{const e=await t.raw().text();this.ajaxContent=e?html`${unsafeHTML(e)}`:html`<p><strong>Oops, received a ${t.response.status} response from </strong> <span class="text-break">${this.content}</span>.</p>`}),html`<typo3-backend-spinner></typo3-backend-spinner>`):this.ajaxContent}renderModalBody(){return"ajax"===this.type?this.renderAjaxBody():"iframe"===this.type?html`<iframe src="${this.content}" name="modal_frame" class="modal-iframe t3js-modal-iframe" @load=${t=>this.title=t.currentTarget.contentDocument.title}></iframe>`:"string"===this.type||"default"===this.type?html`<p>${unsafeHTML(securityUtility.encodeHtml(this.content))}</p>`:html``}renderModalButton(t){return html`
      <!-- @todo: this breaks buttons.dataAttributes -->
      <button
          class="btn ${t.btnClass} ${t.active?"t3js-active":""} ${this.activeButton&&this.activeButton!==t?"disabled":""}"
          name=${ifDefined(t.name||void 0)}
          @click=${e=>this._buttonClick(e,t)}>

          <!-- @todo: why have button texts been added with this.securityUtility.encodeHtml(button.text, false) instead of .textContent? -->
          ${t.icon?html`<typo3-backend-icon identifier="${t.icon}"></typo3-backend-icon>`:nothing}
          <span>${t.text}</span>

      </button>
    `}};__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"title",void 0),__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"content",void 0),__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"type",void 0),__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"severity",void 0),__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"variant",void 0),__decorate([property({type:String,reflect:!0})],ModalElement.prototype,"size",void 0),__decorate([property({type:Number,reflect:!0})],ModalElement.prototype,"zindex",void 0),__decorate([property({type:Array})],ModalElement.prototype,"additionalCssClasses",void 0),__decorate([property({type:Array,attribute:!1})],ModalElement.prototype,"buttons",void 0),__decorate([state()],ModalElement.prototype,"activeButton",void 0),__decorate([state()],ModalElement.prototype,"ajaxContent",void 0),ModalElement=__decorate([customElement("typo3-backend-modal")],ModalElement);export{ModalElement};class Modal{constructor(){this.sizes=Sizes,this.styles=Styles,this.types=Types,this.currentModal=null,this.instances=[],this.defaultConfiguration={type:Types.default,title:"Information",content:"No content provided, please check your <code>Modal</code> configuration.",severity:SeverityEnum.notice,buttons:[],style:Styles.default,size:Sizes.default,additionalCssClasses:[],callback:$.noop(),ajaxCallback:$.noop(),ajaxTarget:null},document.addEventListener("modal-dismiss",this.dismiss),this.initializeMarkupTrigger(document)}static resolveEventNameTargetElement(t){const e=t.target,a=t.currentTarget;return e.dataset&&e.dataset.eventName?e:a.dataset&&a.dataset.eventName?a:null}static createModalResponseEventFromElement(t,e){return t&&t.dataset.eventName?new CustomEvent(t.dataset.eventName,{bubbles:!0,detail:{result:e,payload:t.dataset.eventPayload||null}}):null}dismiss(){this.currentModal&&this.currentModal.bootstrapModal.hide()}get currentModalJQuery(){return $(this.currentModal)}confirm(t,e,a=SeverityEnum.warning,o=[],n){return 0===o.length&&o.push({text:$(this).data("button-close-text")||TYPO3.lang["button.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:$(this).data("button-ok-text")||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+Severity.getCssClass(a),name:"ok"}),this.advanced({title:t,content:e,severity:a,buttons:o,additionalCssClasses:n,callback:t=>{t.addEventListener("button.clicked",e=>{"cancel"===e.target.getAttribute("name")?t.dispatchEvent(new CustomEvent("confirm.button.cancel",{bubbles:!0})):"ok"===e.target.getAttribute("name")&&t.dispatchEvent(new CustomEvent("confirm.button.ok",{bubbles:!0}))})}})}loadUrl(t,e=SeverityEnum.info,a,o,n,s){return this.advanced({type:Types.ajax,title:t,severity:e,buttons:a,ajaxCallback:n,ajaxTarget:s,content:o})}show(t,e,a=SeverityEnum.info,o,n){return this.advanced({type:Types.default,title:t,content:e,severity:a,buttons:o,additionalCssClasses:n})}advanced(t){return t.type="string"==typeof t.type&&t.type in Types?t.type:this.defaultConfiguration.type,t.title="string"==typeof t.title?t.title:this.defaultConfiguration.title,t.content="string"==typeof t.content||"object"==typeof t.content?t.content:this.defaultConfiguration.content,t.severity=void 0!==t.severity?t.severity:this.defaultConfiguration.severity,t.buttons=t.buttons||this.defaultConfiguration.buttons,t.size="string"==typeof t.size&&t.size in Sizes?t.size:this.defaultConfiguration.size,t.style="string"==typeof t.style&&t.style in Styles?t.style:this.defaultConfiguration.style,t.additionalCssClasses=t.additionalCssClasses||this.defaultConfiguration.additionalCssClasses,t.callback="function"==typeof t.callback?t.callback:this.defaultConfiguration.callback,t.ajaxCallback="function"==typeof t.ajaxCallback?t.ajaxCallback:this.defaultConfiguration.ajaxCallback,t.ajaxTarget="string"==typeof t.ajaxTarget?t.ajaxTarget:this.defaultConfiguration.ajaxTarget,this.generate(t)}setButtons(t){return this.currentModal.buttons=t,this.currentModal}initializeMarkupTrigger(t){new RegularEvent("click",(t,e)=>{t.preventDefault();const a=e.dataset.bsContent||"Are you sure?",o=void 0!==SeverityEnum[e.dataset.severity]?SeverityEnum[e.dataset.severity]:SeverityEnum.info;let n=e.dataset.url||null;if(null!==n){const t=n.includes("?")?"&":"?";n=n+t+$.param({data:e.dataset})}this.advanced({type:null!==n?Types.ajax:Types.default,title:e.dataset.title||"Alert",content:null!==n?n:a,severity:o,buttons:[{text:e.dataset.buttonCloseText||TYPO3.lang["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:()=>{this.currentModal.hideModal();const e=Modal.resolveEventNameTargetElement(t),a=Modal.createModalResponseEventFromElement(e,!1);null!==a&&e.dispatchEvent(a)}},{text:e.dataset.buttonOkText||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+Severity.getCssClass(o),trigger:()=>{this.currentModal.hideModal();const a=Modal.resolveEventNameTargetElement(t),o=Modal.createModalResponseEventFromElement(a,!0);null!==o&&a.dispatchEvent(o);let n=e.dataset.uri||e.dataset.href||e.getAttribute("href");n&&"#"!==n&&(t.target.ownerDocument.location.href=n),"submit"===e.getAttribute("type")&&(e.closest("form")?.submit(),"BUTTON"===e.tagName&&e.hasAttribute("form")&&t.target.ownerDocument.querySelector("form#"+e.getAttribute("form"))?.submit()),e.dataset.targetForm&&t.target.ownerDocument.querySelector("form#"+e.dataset.targetForm)?.submit()}}]})}).delegateTo(t,".t3js-modal-trigger")}generate(t){const e=document.createElement("typo3-backend-modal");return e.type=t.type,"string"==typeof t.content?e.content=t.content:e.content=t.content.html(),e.severity=t.severity,e.variant=t.style,e.size=t.size,e.title=t.title,e.additionalCssClasses=t.additionalCssClasses,e.buttons=t.buttons,t.callback&&(e.callback=t.callback),t.ajaxCallback&&(e.ajaxCallback=t.ajaxCallback),e.addEventListener("shown.bs.modal",t=>{t.currentTarget;const a=$(e).siblings(".modal-backdrop"),o=1e3+10*this.instances.length,n=o-10;e.zindex=o,a.css("z-index",n),e.querySelector(Identifiers.footer+" .t3js-active")?.focus()}),e.addEventListener("hide.bs.modal",()=>{if(this.instances.length>0){const t=this.instances.length-1;this.instances.splice(t,1),this.currentModal=this.instances[t-1]}}),e.addEventListener("hidden.bs.modal",t=>{e.trigger("modal-destroyed"),$(t.currentTarget).remove(),this.instances.length>0&&$("body").addClass("modal-open")}),document.body.appendChild(e),e.addEventListener("show.bs.modal",t=>{this.currentModal=t.currentTarget,this.instances.push(this.currentModal)}),e.addEventListener("modal-dismiss",()=>{e.hideModal()}),e}}let modalObject=null;try{parent&&parent.window.TYPO3&&parent.window.TYPO3.Modal?(parent.window.TYPO3.Modal.initializeMarkupTrigger(document),modalObject=parent.window.TYPO3.Modal):top&&top.TYPO3.Modal&&(top.TYPO3.Modal.initializeMarkupTrigger(document),modalObject=top.TYPO3.Modal)}catch{}modalObject||(modalObject=new Modal,TYPO3.Modal=modalObject);export default modalObject;