/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["TYPO3/CMS/Backend/Enum/Severity","jquery","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Utility","./Workspaces","TYPO3/CMS/Core/Event/ThrottleEvent"],(function(e,t,i,s,n,a){"use strict";var o;!function(e){e.topbar="#typo3-topbar",e.workspacePanel=".workspace-panel",e.liveView="#live-view",e.stageSlider="#workspace-stage-slider",e.workspaceView="#workspace-view",e.sendToStageAction='[data-action="send-to-stage"]',e.discardAction='[data-action="discard"]',e.stageButtonsContainer=".t3js-stage-buttons",e.previewModeContainer=".t3js-preview-mode",e.activePreviewMode=".t3js-active-preview-mode",e.workspacePreview=".t3js-workspace-preview"}(o||(o={}));class r extends n{constructor(){super(),this.currentSlidePosition=100,this.elements={},this.updateSlidePosition=e=>{this.currentSlidePosition=parseInt(e.target.value,10),this.resizeViews()},this.renderDiscardWindow=()=>{const t=i.confirm(TYPO3.lang["window.discardAll.title"],TYPO3.lang["window.discardAll.message"],e.SeverityEnum.warning,[{text:TYPO3.lang.cancel,active:!0,btnClass:"btn-default",name:"cancel",trigger:()=>{t.modal("hide")}},{text:TYPO3.lang.ok,btnClass:"btn-warning",name:"ok"}]);t.on("button.clicked",e=>{"ok"===e.target.name&&this.sendRemoteRequest([this.generateRemoteActionsPayload("discardStagesFromPage",[TYPO3.settings.Workspaces.id]),this.generateRemoteActionsPayload("updateStageChangeButtons",[TYPO3.settings.Workspaces.id])]).then(async e=>{t.modal("hide"),this.renderStageButtons((await e.resolve())[1].result),this.elements.$workspaceView.attr("src",this.elements.$workspaceView.attr("src"))})})},this.renderSendPageToStageWindow=e=>{const t=e.currentTarget,i=t.dataset.direction;let n;if("prev"===i)n="sendPageToPreviousStage";else{if("next"!==i)throw"Invalid direction "+i+" requested.";n="sendPageToNextStage"}this.sendRemoteRequest(this.generateRemoteActionsPayload(n,[TYPO3.settings.Workspaces.id])).then(async e=>{const i=await e.resolve(),n=this.renderSendToStageWindow(i);n.on("button.clicked",e=>{if("ok"===e.target.name){const a=s.convertFormToObject(e.currentTarget.querySelector("form"));a.affects=i[0].result.affects,a.stageId=t.dataset.stageId,this.sendRemoteRequest([this.generateRemoteActionsPayload("sentCollectionToStage",[a]),this.generateRemoteActionsPayload("updateStageChangeButtons",[TYPO3.settings.Workspaces.id])]).then(async e=>{n.modal("hide"),this.renderStageButtons((await e.resolve())[1].result)})}})})},this.changePreviewMode=e=>{e.preventDefault();const i=t(e.currentTarget),s=this.elements.$activePreviewMode.data("activePreviewMode"),n=i.data("previewMode");this.elements.$activePreviewMode.text(i.text()).data("activePreviewMode",n),this.elements.$workspacePreview.parent().removeClass("preview-mode-"+s).addClass("preview-mode-"+n),"slider"===n?(this.elements.$stageSlider.parent().toggle(!0),this.resizeViews()):(this.elements.$stageSlider.parent().toggle(!1),"vbox"===n?this.elements.$liveView.height("100%"):this.elements.$liveView.height("50%"))},t(()=>{this.getElements(),this.resizeViews(),this.adjustPreviewModeSelectorWidth(),this.registerEvents()})}static getAvailableSpace(){return t(window).height()-t(o.topbar).outerHeight()}getElements(){this.elements.$liveView=t(o.liveView),this.elements.$workspacePanel=t(o.workspacePanel),this.elements.$stageSlider=t(o.stageSlider),this.elements.$workspaceView=t(o.workspaceView),this.elements.$stageButtonsContainer=t(o.stageButtonsContainer),this.elements.$previewModeContainer=t(o.previewModeContainer),this.elements.$activePreviewMode=t(o.activePreviewMode),this.elements.$workspacePreview=t(o.workspacePreview)}registerEvents(){new a("resize",()=>{this.resizeViews()},50).bindTo(window),t(document).on("click",o.discardAction,this.renderDiscardWindow).on("click",o.sendToStageAction,this.renderSendPageToStageWindow).on("click",".t3js-workspace-recipients-selectall",()=>{t(".t3js-workspace-recipient",window.top.document).not(":disabled").prop("checked",!0)}).on("click",".t3js-workspace-recipients-deselectall",()=>{t(".t3js-workspace-recipient",window.top.document).not(":disabled").prop("checked",!1)}),new a("input",this.updateSlidePosition,25).bindTo(document.querySelector(o.stageSlider)),this.elements.$previewModeContainer.find("[data-preview-mode]").on("click",this.changePreviewMode)}renderStageButtons(e){this.elements.$stageButtonsContainer.html(e)}resizeViews(){const e=r.getAvailableSpace(),t=-1*(this.currentSlidePosition-100),i=Math.round(Math.abs(e*t/100)),s=this.elements.$liveView.outerHeight()-this.elements.$liveView.height();this.elements.$workspacePreview.height(e),"slider"===this.elements.$activePreviewMode.data("activePreviewMode")&&this.elements.$liveView.height(i-s)}adjustPreviewModeSelectorWidth(){const e=this.elements.$previewModeContainer.find(".dropdown-menu");let i=0;e.addClass("show"),this.elements.$previewModeContainer.find("li > a > span").each((e,s)=>{const n=t(s).width();i<n&&(i=n)}),e.removeClass("show"),this.elements.$activePreviewMode.width(i)}}return new r}));