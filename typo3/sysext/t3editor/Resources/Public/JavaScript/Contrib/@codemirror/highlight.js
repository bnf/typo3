import{NodeProp,NodeType}from"@lezer/common";import{StyleModule}from"style-mod";import{EditorView,ViewPlugin,Decoration}from"@codemirror/view";import{Facet,Prec}from"@codemirror/state";import{syntaxTree}from"@codemirror/language";import{RangeSetBuilder}from"@codemirror/rangeset";let nextTagID=0;class Tag{constructor(t,e,a){this.set=t,this.base=e,this.modified=a,this.id=nextTagID++}static define(t){if(null==t?void 0:t.base)throw new Error("Can not derive from a modified tag");let e=new Tag([],null,[]);if(e.set.push(e),t)for(let a of t.set)e.set.push(a);return e}static defineModifier(){let t=new Modifier;return e=>e.modified.indexOf(t)>-1?e:Modifier.get(e.base||e,e.modified.concat(t).sort((t,e)=>t.id-e.id))}}let nextModifierID=0;class Modifier{constructor(){this.instances=[],this.id=nextModifierID++}static get(t,e){if(!e.length)return t;let a=e[0].instances.find(a=>a.base==t&&sameArray(e,a.modified));if(a)return a;let i=[],r=new Tag(i,t,e);for(let t of e)t.instances.push(r);let o=permute(e);for(let e of t.set)for(let t of o)i.push(Modifier.get(e,t));return r}}function sameArray(t,e){return t.length==e.length&&t.every((t,a)=>t==e[a])}function permute(t){let e=[t];for(let a=0;a<t.length;a++)for(let i of permute(t.slice(0,a).concat(t.slice(a+1))))e.push(i);return e}function styleTags(t){let e=Object.create(null);for(let a in t){let i=t[a];Array.isArray(i)||(i=[i]);for(let t of a.split(" "))if(t){let a=[],r=2,o=t;for(let e=0;;){if("..."==o&&e>0&&e+3==t.length){r=1;break}let i=/^"(?:[^"\\]|\\.)*?"|[^\/!]+/.exec(o);if(!i)throw new RangeError("Invalid path: "+t);if(a.push("*"==i[0]?null:'"'==i[0][0]?JSON.parse(i[0]):i[0]),e+=i[0].length,e==t.length)break;let s=t[e++];if(e==t.length&&"!"==s){r=0;break}if("/"!=s)throw new RangeError("Invalid path: "+t);o=t.slice(e)}let s=a.length-1,l=a[s];if(!l)throw new RangeError("Invalid path: "+t);let n=new Rule(i,r,s>0?a.slice(0,s):null);e[l]=n.sort(e[l])}}return ruleNodeProp.add(e)}const ruleNodeProp=new NodeProp,highlightStyle=Facet.define({combine:t=>t.length?HighlightStyle.combinedMatch(t):null}),fallbackHighlightStyle=Facet.define({combine:t=>t.length?t[0].match:null});function getHighlightStyle(t){return t.facet(highlightStyle)||t.facet(fallbackHighlightStyle)}class Rule{constructor(t,e,a,i){this.tags=t,this.mode=e,this.context=a,this.next=i}sort(t){return!t||t.depth<this.depth?(this.next=t,this):(t.next=this.sort(t.next),t)}get depth(){return this.context?this.context.length:0}}class HighlightStyle{constructor(t,e){let a;function i(t){let e=StyleModule.newName();return(a||(a=Object.create(null)))["."+e]=t,e}this.map=Object.create(null),this.all="string"==typeof e.all?e.all:e.all?i(e.all):null;for(let e of t){let t=(e.class||i(Object.assign({},e,{tag:null})))+(this.all?" "+this.all:""),a=e.tag;if(Array.isArray(a))for(let e of a)this.map[e.id]=t;else this.map[a.id]=t}this.module=a?new StyleModule(a):null,this.scope=e.scope||null,this.match=this.match.bind(this);let r=[treeHighlighter];this.module&&r.push(EditorView.styleModule.of(this.module)),this.extension=r.concat(highlightStyle.of(this)),this.fallback=r.concat(fallbackHighlightStyle.of(this))}match(t,e){if(this.scope&&e!=this.scope)return null;for(let e of t.set){let a=this.map[e.id];if(void 0!==a)return e!=t&&(this.map[t.id]=a),a}return this.map[t.id]=this.all}static combinedMatch(t){if(1==t.length)return t[0].match;let e=t.some(t=>t.scope)?void 0:Object.create(null);return(a,i)=>{let r=e&&e[a.id];if(void 0!==r)return r;let o=null;for(let e of t){let t=e.match(a,i);t&&(o=o?o+" "+t:t)}return e&&(e[a.id]=o),o}}static define(t,e){return new HighlightStyle(t,e||{})}static get(t,e,a){let i=getHighlightStyle(t);return i&&i(e,a||NodeType.none)}}function highlightTree(t,e,a,i=0,r=t.length){highlightTreeRange(t,i,r,e,a)}class TreeHighlighter{constructor(t){this.markCache=Object.create(null),this.tree=syntaxTree(t.state),this.decorations=this.buildDeco(t,getHighlightStyle(t.state))}update(t){let e=syntaxTree(t.state),a=getHighlightStyle(t.state),i=a!=t.startState.facet(highlightStyle);e.length<t.view.viewport.to&&!i&&e.type==this.tree.type?this.decorations=this.decorations.map(t.changes):(e!=this.tree||t.viewportChanged||i)&&(this.tree=e,this.decorations=this.buildDeco(t.view,a))}buildDeco(t,e){if(!e||!this.tree.length)return Decoration.none;let a=new RangeSetBuilder;for(let{from:i,to:r}of t.visibleRanges)highlightTreeRange(this.tree,i,r,e,(t,e,i)=>{a.add(t,e,this.markCache[i]||(this.markCache[i]=Decoration.mark({class:i})))});return a.finish()}}const treeHighlighter=Prec.high(ViewPlugin.fromClass(TreeHighlighter,{decorations:t=>t.decorations})),nodeStack=[""];class HighlightBuilder{constructor(t,e,a){this.at=t,this.style=e,this.span=a,this.class=""}startSpan(t,e){e!=this.class&&(this.flush(t),t>this.at&&(this.at=t),this.class=e)}flush(t){t>this.at&&this.class&&this.span(this.at,t,this.class)}highlightRange(t,e,a,i,r,o){let{type:s,from:l,to:n}=t;if(l>=a||n<=e)return;nodeStack[r]=s.name,s.isTop&&(o=s);let g=i,c=s.prop(ruleNodeProp),h=!1;for(;c;){if(!c.context||matchContext(c.context,nodeStack,r)){for(let t of c.tags){let e=this.style(t,o);e&&(g&&(g+=" "),g+=e,1==c.mode?i+=(i?" ":"")+e:0==c.mode&&(h=!0))}break}c=c.next}if(this.startSpan(t.from,g),h)return;let m=t.tree&&t.tree.prop(NodeProp.mounted);if(m&&m.overlay){let s=t.node.enter(m.overlay[0].from+l,1),c=t.firstChild();for(let h=0,d=l;;h++){let f=h<m.overlay.length?m.overlay[h]:null,p=f?f.from+l:n,u=Math.max(e,d),y=Math.min(a,p);if(u<y&&c)for(;t.from<y&&(this.highlightRange(t,u,y,i,r+1,o),this.startSpan(Math.min(a,t.to),g),!(t.to>=p)&&t.nextSibling()););if(!f||p>a)break;d=f.to+l,d>e&&(this.highlightRange(s.cursor,Math.max(e,f.from+l),Math.min(a,d),i,r,m.tree.type),this.startSpan(d,g))}c&&t.parent()}else if(t.firstChild()){do{if(!(t.to<=e)){if(t.from>=a)break;this.highlightRange(t,e,a,i,r+1,o),this.startSpan(Math.min(a,t.to),g)}}while(t.nextSibling());t.parent()}}}function highlightTreeRange(t,e,a,i,r){let o=new HighlightBuilder(e,i,r);o.highlightRange(t.cursor(),e,a,"",0,t.type),o.flush(a)}function matchContext(t,e,a){if(t.length>a-1)return!1;for(let i=a-1,r=t.length-1;r>=0;r--,i--){let a=t[r];if(a&&a!=e[i])return!1}return!0}const t=Tag.define,comment=t(),name=t(),typeName=t(name),propertyName=t(name),literal=t(),string=t(literal),number=t(literal),content=t(),heading=t(content),keyword=t(),operator=t(),punctuation=t(),bracket=t(punctuation),meta=t(),tags={comment,lineComment:t(comment),blockComment:t(comment),docComment:t(comment),name,variableName:t(name),typeName,tagName:t(typeName),propertyName,attributeName:t(propertyName),className:t(name),labelName:t(name),namespace:t(name),macroName:t(name),literal,string,docString:t(string),character:t(string),attributeValue:t(string),number,integer:t(number),float:t(number),bool:t(literal),regexp:t(literal),escape:t(literal),color:t(literal),url:t(literal),keyword,self:t(keyword),null:t(keyword),atom:t(keyword),unit:t(keyword),modifier:t(keyword),operatorKeyword:t(keyword),controlKeyword:t(keyword),definitionKeyword:t(keyword),moduleKeyword:t(keyword),operator,derefOperator:t(operator),arithmeticOperator:t(operator),logicOperator:t(operator),bitwiseOperator:t(operator),compareOperator:t(operator),updateOperator:t(operator),definitionOperator:t(operator),typeOperator:t(operator),controlOperator:t(operator),punctuation,separator:t(punctuation),bracket,angleBracket:t(bracket),squareBracket:t(bracket),paren:t(bracket),brace:t(bracket),content,heading,heading1:t(heading),heading2:t(heading),heading3:t(heading),heading4:t(heading),heading5:t(heading),heading6:t(heading),contentSeparator:t(content),list:t(content),quote:t(content),emphasis:t(content),strong:t(content),link:t(content),monospace:t(content),strikethrough:t(content),inserted:t(),deleted:t(),changed:t(),invalid:t(),meta,documentMeta:t(meta),annotation:t(meta),processingInstruction:t(meta),definition:Tag.defineModifier(),constant:Tag.defineModifier(),function:Tag.defineModifier(),standard:Tag.defineModifier(),local:Tag.defineModifier(),special:Tag.defineModifier()},defaultHighlightStyle=HighlightStyle.define([{tag:tags.link,textDecoration:"underline"},{tag:tags.heading,textDecoration:"underline",fontWeight:"bold"},{tag:tags.emphasis,fontStyle:"italic"},{tag:tags.strong,fontWeight:"bold"},{tag:tags.strikethrough,textDecoration:"line-through"},{tag:tags.keyword,color:"#708"},{tag:[tags.atom,tags.bool,tags.url,tags.contentSeparator,tags.labelName],color:"#219"},{tag:[tags.literal,tags.inserted],color:"#164"},{tag:[tags.string,tags.deleted],color:"#a11"},{tag:[tags.regexp,tags.escape,tags.special(tags.string)],color:"#e40"},{tag:tags.definition(tags.variableName),color:"#00f"},{tag:tags.local(tags.variableName),color:"#30a"},{tag:[tags.typeName,tags.namespace],color:"#085"},{tag:tags.className,color:"#167"},{tag:[tags.special(tags.variableName),tags.macroName],color:"#256"},{tag:tags.definition(tags.propertyName),color:"#00c"},{tag:tags.comment,color:"#940"},{tag:tags.meta,color:"#7a757a"},{tag:tags.invalid,color:"#f00"}]),classHighlightStyle=HighlightStyle.define([{tag:tags.link,class:"cmt-link"},{tag:tags.heading,class:"cmt-heading"},{tag:tags.emphasis,class:"cmt-emphasis"},{tag:tags.strong,class:"cmt-strong"},{tag:tags.keyword,class:"cmt-keyword"},{tag:tags.atom,class:"cmt-atom"},{tag:tags.bool,class:"cmt-bool"},{tag:tags.url,class:"cmt-url"},{tag:tags.labelName,class:"cmt-labelName"},{tag:tags.inserted,class:"cmt-inserted"},{tag:tags.deleted,class:"cmt-deleted"},{tag:tags.literal,class:"cmt-literal"},{tag:tags.string,class:"cmt-string"},{tag:tags.number,class:"cmt-number"},{tag:[tags.regexp,tags.escape,tags.special(tags.string)],class:"cmt-string2"},{tag:tags.variableName,class:"cmt-variableName"},{tag:tags.local(tags.variableName),class:"cmt-variableName cmt-local"},{tag:tags.definition(tags.variableName),class:"cmt-variableName cmt-definition"},{tag:tags.special(tags.variableName),class:"cmt-variableName2"},{tag:tags.definition(tags.propertyName),class:"cmt-propertyName cmt-definition"},{tag:tags.typeName,class:"cmt-typeName"},{tag:tags.namespace,class:"cmt-namespace"},{tag:tags.className,class:"cmt-className"},{tag:tags.macroName,class:"cmt-macroName"},{tag:tags.propertyName,class:"cmt-propertyName"},{tag:tags.operator,class:"cmt-operator"},{tag:tags.comment,class:"cmt-comment"},{tag:tags.meta,class:"cmt-meta"},{tag:tags.invalid,class:"cmt-invalid"},{tag:tags.punctuation,class:"cmt-punctuation"}]);export{HighlightStyle,Tag,classHighlightStyle,defaultHighlightStyle,highlightTree,styleTags,tags};