import{MapMode,Text as Text$1,Facet,StateEffect,ChangeSet,EditorSelection,CharCategory,EditorState,Transaction,Prec,combineConfig,StateField}from"@codemirror/state";import{StyleModule}from"style-mod";import{RangeSet,RangeValue,RangeSetBuilder}from"@codemirror/rangeset";export{Range}from"@codemirror/rangeset";import{Text,findClusterBreak,findColumn,codePointAt,countColumn}from"@codemirror/text";import{keyName,base}from"w3c-keyname";function getSelection(e){let t;return t=11==e.nodeType?e.getSelection?e:e.ownerDocument:e,t.getSelection()}function contains(e,t){return!!t&&e.contains(1!=t.nodeType?t.parentNode:t)}function deepActiveElement(){let e=document.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function hasSelection(e,t){if(!t.anchorNode)return!1;try{return contains(e,t.anchorNode)}catch(e){return!1}}function clientRectsFor(e){return 3==e.nodeType?textRange(e,0,e.nodeValue.length).getClientRects():1==e.nodeType?e.getClientRects():[]}function isEquivalentPosition(e,t,i,o){return!!i&&(scanFor(e,t,i,o,-1)||scanFor(e,t,i,o,1))}function domIndex(e){for(var t=0;;t++)if(!(e=e.previousSibling))return t}function scanFor(e,t,i,o,s){for(;;){if(e==i&&t==o)return!0;if(t==(s<0?0:maxOffset(e))){if("DIV"==e.nodeName)return!1;let i=e.parentNode;if(!i||1!=i.nodeType)return!1;t=domIndex(e)+(s<0?0:1),e=i}else{if(1!=e.nodeType)return!1;if(1==(e=e.childNodes[t+(s<0?-1:0)]).nodeType&&"false"==e.contentEditable)return!1;t=s<0?maxOffset(e):0}}}function maxOffset(e){return 3==e.nodeType?e.nodeValue.length:e.childNodes.length}const Rect0={left:0,right:0,top:0,bottom:0};function flattenRect(e,t){let i=t?e.left:e.right;return{left:i,right:i,top:e.top,bottom:e.bottom}}function windowRect(e){return{left:0,right:e.innerWidth,top:0,bottom:e.innerHeight}}function scrollRectIntoView(e,t,i,o,s,n,r,l){let a=e.ownerDocument,h=a.defaultView;for(let c=e;c;)if(1==c.nodeType){let e,d=c==a.body;if(d)e=windowRect(h);else{if(c.scrollHeight<=c.clientHeight&&c.scrollWidth<=c.clientWidth){c=c.parentNode;continue}let t=c.getBoundingClientRect();e={left:t.left,right:t.left+c.clientWidth,top:t.top,bottom:t.top+c.clientHeight}}let u=0,p=0;if("nearest"==s)t.top<e.top?(p=-(e.top-t.top+r),i>0&&t.bottom>e.bottom+p&&(p=t.bottom-e.bottom+p+r)):t.bottom>e.bottom&&(p=t.bottom-e.bottom+r,i<0&&t.top-p<e.top&&(p=-(e.top+p-t.top+r)));else{let o=t.bottom-t.top,n=e.bottom-e.top;p=("center"==s&&o<=n?t.top+o/2-n/2:"start"==s||"center"==s&&i<0?t.top-r:t.bottom-n+r)-e.top}if("nearest"==o)t.left<e.left?(u=-(e.left-t.left+n),i>0&&t.right>e.right+u&&(u=t.right-e.right+u+n)):t.right>e.right&&(u=t.right-e.right+n,i<0&&t.left<e.left+u&&(u=-(e.left+u-t.left+n)));else{u=("center"==o?t.left+(t.right-t.left)/2-(e.right-e.left)/2:"start"==o==l?t.left-n:t.right-(e.right-e.left)+n)-e.left}if(u||p)if(d)h.scrollBy(u,p);else{if(p){let e=c.scrollTop;c.scrollTop+=p,p=c.scrollTop-e}if(u){let e=c.scrollLeft;c.scrollLeft+=u,u=c.scrollLeft-e}t={left:t.left-u,top:t.top-p,right:t.right-u,bottom:t.bottom-p}}if(d)break;c=c.assignedSlot||c.parentNode,o=s="nearest"}else{if(11!=c.nodeType)break;c=c.host}}class DOMSelectionState{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}eq(e){return this.anchorNode==e.anchorNode&&this.anchorOffset==e.anchorOffset&&this.focusNode==e.focusNode&&this.focusOffset==e.focusOffset}setRange(e){this.set(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)}set(e,t,i,o){this.anchorNode=e,this.anchorOffset=t,this.focusNode=i,this.focusOffset=o}}let scratchRange,preventScrollSupported=null;function focusPreventScroll(e){if(e.setActive)return e.setActive();if(preventScrollSupported)return e.focus(preventScrollSupported);let t=[];for(let i=e;i&&(t.push(i,i.scrollTop,i.scrollLeft),i!=i.ownerDocument);i=i.parentNode);if(e.focus(null==preventScrollSupported?{get preventScroll(){return preventScrollSupported={preventScroll:!0},!0}}:void 0),!preventScrollSupported){preventScrollSupported=!1;for(let e=0;e<t.length;){let i=t[e++],o=t[e++],s=t[e++];i.scrollTop!=o&&(i.scrollTop=o),i.scrollLeft!=s&&(i.scrollLeft=s)}}}function textRange(e,t,i=t){let o=scratchRange||(scratchRange=document.createRange());return o.setEnd(e,i),o.setStart(e,t),o}function dispatchKey(e,t,i){let o={key:t,code:t,keyCode:i,which:i,cancelable:!0},s=new KeyboardEvent("keydown",o);s.synthetic=!0,e.dispatchEvent(s);let n=new KeyboardEvent("keyup",o);return n.synthetic=!0,e.dispatchEvent(n),s.defaultPrevented||n.defaultPrevented}function getRoot(e){for(;e;){if(e&&(9==e.nodeType||11==e.nodeType&&e.host))return e;e=e.assignedSlot||e.parentNode}return null}function clearAttributes(e){for(;e.attributes.length;)e.removeAttributeNode(e.attributes[0])}class DOMPos{constructor(e,t,i=!0){this.node=e,this.offset=t,this.precise=i}static before(e,t){return new DOMPos(e.parentNode,domIndex(e),t)}static after(e,t){return new DOMPos(e.parentNode,domIndex(e)+1,t)}}const noChildren=[];class ContentView{constructor(){this.parent=null,this.dom=null,this.dirty=2}get editorView(){if(!this.parent)throw new Error("Accessing view in orphan content view");return this.parent.editorView}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(e){let t=this.posAtStart;for(let i of this.children){if(i==e)return t;t+=i.length+i.breakAfter}throw new RangeError("Invalid child in posBefore")}posAfter(e){return this.posBefore(e)+e.length}coordsAt(e,t){return null}sync(e){if(2&this.dirty){let t=this.dom,i=t.firstChild;for(let o of this.children){if(o.dirty){if(!o.dom&&i){let e=ContentView.get(i);e&&(e.parent||e.constructor!=o.constructor)||o.reuseDOM(i)}o.sync(e),o.dirty=0}if(e&&!e.written&&e.node==t&&i!=o.dom&&(e.written=!0),o.dom.parentNode==t){for(;i&&i!=o.dom;)i=rm(i);i=o.dom.nextSibling}else t.insertBefore(o.dom,i)}for(i&&e&&e.node==t&&(e.written=!0);i;)i=rm(i)}else if(1&this.dirty)for(let t of this.children)t.dirty&&(t.sync(e),t.dirty=0)}reuseDOM(e){}localPosFromDOM(e,t){let i;if(e==this.dom)i=this.dom.childNodes[t];else{let o=0==maxOffset(e)?0:0==t?-1:1;for(;;){let t=e.parentNode;if(t==this.dom)break;0==o&&t.firstChild!=t.lastChild&&(o=e==t.firstChild?-1:1),e=t}i=o<0?e:e.nextSibling}if(i==this.dom.firstChild)return 0;for(;i&&!ContentView.get(i);)i=i.nextSibling;if(!i)return this.length;for(let e=0,t=0;;e++){let o=this.children[e];if(o.dom==i)return t;t+=o.length+o.breakAfter}}domBoundsAround(e,t,i=0){let o=-1,s=-1,n=-1,r=-1;for(let l=0,a=i,h=i;l<this.children.length;l++){let i=this.children[l],c=a+i.length;if(a<e&&c>t)return i.domBoundsAround(e,t,a);if(c>=e&&-1==o&&(o=l,s=a),a>t&&i.dom.parentNode==this.dom){n=l,r=h;break}h=c,a=c+i.breakAfter}return{from:s,to:r<0?i+this.length:r,startDOM:(o?this.children[o-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:n<this.children.length&&n>=0?this.children[n].dom:null}}markDirty(e=!1){this.dirty|=2,this.markParentsDirty(e)}markParentsDirty(e){for(let t=this.parent;t;t=t.parent){if(e&&(t.dirty|=2),1&t.dirty)return;t.dirty|=1,e=!1}}setParent(e){this.parent!=e&&(this.parent=e,this.dirty&&this.markParentsDirty(!0))}setDOM(e){this.dom&&(this.dom.cmView=null),this.dom=e,e.cmView=this}get rootView(){for(let e=this;;){let t=e.parent;if(!t)return e;e=t}}replaceChildren(e,t,i=noChildren){this.markDirty();for(let i=e;i<t;i++){let e=this.children[i];e.parent==this&&e.destroy()}this.children.splice(e,t-e,...i);for(let e=0;e<i.length;e++)i[e].setParent(this)}ignoreMutation(e){return!1}ignoreEvent(e){return!1}childCursor(e=this.length){return new ChildCursor(this.children,e,this.children.length)}childPos(e,t=1){return this.childCursor().findPos(e,t)}toString(){let e=this.constructor.name.replace("View","");return e+(this.children.length?"("+this.children.join()+")":this.length?"["+("Text"==e?this.text:this.length)+"]":"")+(this.breakAfter?"#":"")}static get(e){return e.cmView}get isEditable(){return!0}merge(e,t,i,o,s,n){return!1}become(e){return!1}getSide(){return 0}destroy(){this.parent=null}}function rm(e){let t=e.nextSibling;return e.parentNode.removeChild(e),t}ContentView.prototype.breakAfter=0;class ChildCursor{constructor(e,t,i){this.children=e,this.pos=t,this.i=i,this.off=0}findPos(e,t=1){for(;;){if(e>this.pos||e==this.pos&&(t>0||0==this.i||this.children[this.i-1].breakAfter))return this.off=e-this.pos,this;let i=this.children[--this.i];this.pos-=i.length+i.breakAfter}}}function replaceRange(e,t,i,o,s,n,r,l,a){let{children:h}=e,c=h.length?h[t]:null,d=n.length?n[n.length-1]:null,u=d?d.breakAfter:r;if(!(t==o&&c&&!r&&!u&&n.length<2&&c.merge(i,s,n.length?d:null,0==i,l,a))){if(o<h.length){let e=h[o];e&&s<e.length?(t==o&&(e=e.split(s),s=0),!u&&d&&e.merge(0,s,d,!0,0,a)?n[n.length-1]=e:(s&&e.merge(0,s,null,!1,0,a),n.push(e))):(null==e?void 0:e.breakAfter)&&(d?d.breakAfter=1:r=1),o++}for(c&&(c.breakAfter=r,i>0&&(!r&&n.length&&c.merge(i,c.length,n[0],!1,l,0)?c.breakAfter=n.shift().breakAfter:(i<c.length||c.children.length&&0==c.children[c.children.length-1].length)&&c.merge(i,c.length,null,!1,l,0),t++));t<o&&n.length;)if(h[o-1].become(n[n.length-1]))o--,n.pop(),a=n.length?0:l;else{if(!h[t].become(n[0]))break;t++,n.shift(),l=n.length?0:a}!n.length&&t&&o<h.length&&!h[t-1].breakAfter&&h[o].merge(0,0,h[t-1],!1,l,a)&&t--,(t<o||n.length)&&e.replaceChildren(t,o,n)}}function mergeChildrenInto(e,t,i,o,s,n){let r=e.childCursor(),{i:l,off:a}=r.findPos(i,1),{i:h,off:c}=r.findPos(t,-1),d=t-i;for(let e of o)d+=e.length;e.length+=d,replaceRange(e,h,c,l,a,o,0,s,n)}let[nav,doc]="undefined"!=typeof navigator?[navigator,document]:[{userAgent:"",vendor:"",platform:""},{documentElement:{style:{}}}];const ie_edge=/Edge\/(\d+)/.exec(nav.userAgent),ie_upto10=/MSIE \d/.test(nav.userAgent),ie_11up=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(nav.userAgent),ie=!!(ie_upto10||ie_11up||ie_edge),gecko=!ie&&/gecko\/(\d+)/i.test(nav.userAgent),chrome=!ie&&/Chrome\/(\d+)/.exec(nav.userAgent),webkit="webkitFontSmoothing"in doc.documentElement.style,safari=!ie&&/Apple Computer/.test(nav.vendor),ios=safari&&(/Mobile\/\w+/.test(nav.userAgent)||nav.maxTouchPoints>2);var browser={mac:ios||/Mac/.test(nav.platform),windows:/Win/.test(nav.platform),linux:/Linux|X11/.test(nav.platform),ie,ie_version:ie_upto10?doc.documentMode||6:ie_11up?+ie_11up[1]:ie_edge?+ie_edge[1]:0,gecko,gecko_version:gecko?+(/Firefox\/(\d+)/.exec(nav.userAgent)||[0,0])[1]:0,chrome:!!chrome,chrome_version:chrome?+chrome[1]:0,ios,android:/Android\b/.test(nav.userAgent),webkit,safari,webkit_version:webkit?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0,tabSize:null!=doc.documentElement.style.tabSize?"tab-size":"-moz-tab-size"};const MaxJoinLen=256;class TextView extends ContentView{constructor(e){super(),this.text=e}get length(){return this.text.length}createDOM(e){this.setDOM(e||document.createTextNode(this.text))}sync(e){this.dom||this.createDOM(),this.dom.nodeValue!=this.text&&(e&&e.node==this.dom&&(e.written=!0),this.dom.nodeValue=this.text)}reuseDOM(e){3==e.nodeType&&this.createDOM(e)}merge(e,t,i){return(!i||i instanceof TextView&&!(this.length-(t-e)+i.length>256))&&(this.text=this.text.slice(0,e)+(i?i.text:"")+this.text.slice(t),this.markDirty(),!0)}split(e){let t=new TextView(this.text.slice(e));return this.text=this.text.slice(0,e),this.markDirty(),t}localPosFromDOM(e,t){return e==this.dom?t:t?this.text.length:0}domAtPos(e){return new DOMPos(this.dom,e)}domBoundsAround(e,t,i){return{from:i,to:i+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(e,t){return textCoords(this.dom,e,t)}}class MarkView extends ContentView{constructor(e,t=[],i=0){super(),this.mark=e,this.children=t,this.length=i;for(let e of t)e.setParent(this)}setAttrs(e){if(clearAttributes(e),this.mark.class&&(e.className=this.mark.class),this.mark.attrs)for(let t in this.mark.attrs)e.setAttribute(t,this.mark.attrs[t]);return e}reuseDOM(e){e.nodeName==this.mark.tagName.toUpperCase()&&(this.setDOM(e),this.dirty|=6)}sync(e){this.dom?4&this.dirty&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName))),super.sync(e)}merge(e,t,i,o,s,n){return(!i||!(!(i instanceof MarkView&&i.mark.eq(this.mark))||e&&s<=0||t<this.length&&n<=0))&&(mergeChildrenInto(this,e,t,i?i.children:[],s-1,n-1),this.markDirty(),!0)}split(e){let t=[],i=0,o=-1,s=0;for(let n of this.children){let r=i+n.length;r>e&&t.push(i<e?n.split(e-i):n),o<0&&i>=e&&(o=s),i=r,s++}let n=this.length-e;return this.length=e,o>-1&&(this.children.length=o,this.markDirty()),new MarkView(this.mark,t,n)}domAtPos(e){return inlineDOMAtPos(this.dom,this.children,e)}coordsAt(e,t){return coordsInChildren(this,e,t)}}function textCoords(e,t,i){let o=e.nodeValue.length;t>o&&(t=o);let s=t,n=t,r=0;0==t&&i<0||t==o&&i>=0?browser.chrome||browser.gecko||(t?(s--,r=1):(n++,r=-1)):i<0?s--:n++;let l=textRange(e,s,n).getClientRects();if(!l.length)return Rect0;let a=l[(r?r<0:i>=0)?0:l.length-1];return browser.safari&&!r&&0==a.width&&(a=Array.prototype.find.call(l,e=>e.width)||a),r?flattenRect(a,r<0):a||null}class WidgetView extends ContentView{constructor(e,t,i){super(),this.widget=e,this.length=t,this.side=i}static create(e,t,i){return new(e.customView||WidgetView)(e,t,i)}split(e){let t=WidgetView.create(this.widget,this.length-e,this.side);return this.length-=e,t}sync(){this.dom&&this.widget.updateDOM(this.dom)||(this.setDOM(this.widget.toDOM(this.editorView)),this.dom.contentEditable="false")}getSide(){return this.side}merge(e,t,i,o,s,n){return!(i&&(!(i instanceof WidgetView&&this.widget.compare(i.widget))||e>0&&s<=0||t<this.length&&n<=0))&&(this.length=e+(i?i.length:0)+(this.length-t),!0)}become(e){return e.length==this.length&&e instanceof WidgetView&&e.side==this.side&&this.widget.constructor==e.widget.constructor&&(this.widget.eq(e.widget)||this.markDirty(!0),this.widget=e.widget,!0)}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get overrideDOMText(){if(0==this.length)return Text.empty;let e=this;for(;e.parent;)e=e.parent;let t=e.editorView,i=t&&t.state.doc,o=this.posAtStart;return i?i.slice(o,o+this.length):Text.empty}domAtPos(e){return 0==e?DOMPos.before(this.dom):DOMPos.after(this.dom,e==this.length)}domBoundsAround(){return null}coordsAt(e,t){let i=this.dom.getClientRects(),o=null;if(!i.length)return Rect0;for(let t=e>0?i.length-1:0;o=i[t],!(e>0?0==t:t==i.length-1||o.top<o.bottom);t+=e>0?-1:1);return 0==e&&t>0||e==this.length&&t<=0?o:flattenRect(o,0==e)}get isEditable(){return!1}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class CompositionView extends WidgetView{domAtPos(e){return new DOMPos(this.widget.text,e)}sync(){this.setDOM(this.widget.toDOM())}localPosFromDOM(e,t){return t?3==e.nodeType?Math.min(t,this.length):this.length:0}ignoreMutation(){return!1}get overrideDOMText(){return null}coordsAt(e,t){return textCoords(this.widget.text,e,t)}get isEditable(){return!0}}const ZeroWidthSpace=browser.android?"​​":"​";class WidgetBufferView extends ContentView{constructor(e){super(),this.side=e}get length(){return 0}merge(){return!1}become(e){return e instanceof WidgetBufferView&&e.side==this.side}split(){return new WidgetBufferView(this.side)}sync(){this.dom?this.dirty&&this.dom.nodeValue!=ZeroWidthSpace&&(this.dom.nodeValue=ZeroWidthSpace):this.setDOM(document.createTextNode(ZeroWidthSpace))}getSide(){return this.side}domAtPos(e){return DOMPos.before(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(e){let t=clientRectsFor(this.dom);return t[t.length-1]||null}get overrideDOMText(){return Text.of([this.dom.nodeValue.replace(/\u200b/g,"")])}}function inlineDOMAtPos(e,t,i){let o=0;for(let s=0;o<t.length;o++){let n=t[o],r=s+n.length;if(!(r==s&&n.getSide()<=0)){if(i>s&&i<r&&n.dom.parentNode==e)return n.domAtPos(i-s);if(i<=s)break;s=r}}for(;o>0;o--){let i=t[o-1].dom;if(i.parentNode==e)return DOMPos.after(i)}return new DOMPos(e,0)}function joinInlineInto(e,t,i){let o,{children:s}=e;i>0&&t instanceof MarkView&&s.length&&(o=s[s.length-1])instanceof MarkView&&o.mark.eq(t.mark)?joinInlineInto(o,t.children[0],i-1):(s.push(t),t.setParent(e)),e.length+=t.length}function coordsInChildren(e,t,i){for(let o=0,s=0;s<e.children.length;s++){let n,r=e.children[s],l=o+r.length;if((i<=0||l==e.length||r.getSide()>0?l>=t:l>t)&&(t<l||s+1==e.children.length||(n=e.children[s+1]).length||n.getSide()>0)){let e=0;if(l==o){if(r.getSide()<=0)continue;e=i=-r.getSide()}let s=r.coordsAt(t-o,i);return e&&s?flattenRect(s,i<0):s}o=l}let o=e.dom.lastChild;if(!o)return e.dom.getBoundingClientRect();let s=clientRectsFor(o);return s[s.length-1]||null}function combineAttrs(e,t){for(let i in e)"class"==i&&t.class?t.class+=" "+e.class:"style"==i&&t.style?t.style+=";"+e.style:t[i]=e[i];return t}function attrsEq(e,t){if(e==t)return!0;if(!e||!t)return!1;let i=Object.keys(e),o=Object.keys(t);if(i.length!=o.length)return!1;for(let s of i)if(-1==o.indexOf(s)||e[s]!==t[s])return!1;return!0}function updateAttrs(e,t,i){if(t)for(let o in t)i&&o in i||e.removeAttribute(o);if(i)for(let o in i)t&&t[o]==i[o]||e.setAttribute(o,i[o])}TextView.prototype.children=WidgetView.prototype.children=WidgetBufferView.prototype.children=noChildren;class WidgetType{eq(e){return!1}updateDOM(e){return!1}compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}get estimatedHeight(){return-1}ignoreEvent(e){return!0}get customView(){return null}destroy(e){}}var BlockType=function(e){return e[e.Text=0]="Text",e[e.WidgetBefore=1]="WidgetBefore",e[e.WidgetAfter=2]="WidgetAfter",e[e.WidgetRange=3]="WidgetRange",e}(BlockType||(BlockType={}));class Decoration extends RangeValue{constructor(e,t,i,o){super(),this.startSide=e,this.endSide=t,this.widget=i,this.spec=o}get heightRelevant(){return!1}static mark(e){return new MarkDecoration(e)}static widget(e){let t=e.side||0,i=!!e.block;return t+=i?t>0?3e8:-4e8:t>0?1e8:-1e8,new PointDecoration(e,t,t,i,e.widget||null,!1)}static replace(e){let t=!!e.block,{start:i,end:o}=getInclusive(e,t);return new PointDecoration(e,t?i?-3e8:-1:4e8,t?o?2e8:1:-5e8,t,e.widget||null,!0)}static line(e){return new LineDecoration(e)}static set(e,t=!1){return RangeSet.of(e,t)}hasHeight(){return!!this.widget&&this.widget.estimatedHeight>-1}}Decoration.none=RangeSet.empty;class MarkDecoration extends Decoration{constructor(e){let{start:t,end:i}=getInclusive(e);super(t?-1:4e8,i?1:-5e8,null,e),this.tagName=e.tagName||"span",this.class=e.class||"",this.attrs=e.attributes||null}eq(e){return this==e||e instanceof MarkDecoration&&this.tagName==e.tagName&&this.class==e.class&&attrsEq(this.attrs,e.attrs)}range(e,t=e){if(e>=t)throw new RangeError("Mark decorations may not be empty");return super.range(e,t)}}MarkDecoration.prototype.point=!1;class LineDecoration extends Decoration{constructor(e){super(-2e8,-2e8,null,e)}eq(e){return e instanceof LineDecoration&&attrsEq(this.spec.attributes,e.spec.attributes)}range(e,t=e){if(t!=e)throw new RangeError("Line decoration ranges must be zero-length");return super.range(e,t)}}LineDecoration.prototype.mapMode=MapMode.TrackBefore,LineDecoration.prototype.point=!0;class PointDecoration extends Decoration{constructor(e,t,i,o,s,n){super(t,i,s,e),this.block=o,this.isReplace=n,this.mapMode=o?t<=0?MapMode.TrackBefore:MapMode.TrackAfter:MapMode.TrackDel}get type(){return this.startSide<this.endSide?BlockType.WidgetRange:this.startSide<=0?BlockType.WidgetBefore:BlockType.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&this.widget.estimatedHeight>=5}eq(e){return e instanceof PointDecoration&&widgetsEq(this.widget,e.widget)&&this.block==e.block&&this.startSide==e.startSide&&this.endSide==e.endSide}range(e,t=e){if(this.isReplace&&(e>t||e==t&&this.startSide>0&&this.endSide<=0))throw new RangeError("Invalid range for replacement decoration");if(!this.isReplace&&t!=e)throw new RangeError("Widget decorations can only have zero-length ranges");return super.range(e,t)}}function getInclusive(e,t=!1){let{inclusiveStart:i,inclusiveEnd:o}=e;return null==i&&(i=e.inclusive),null==o&&(o=e.inclusive),{start:null!=i?i:t,end:null!=o?o:t}}function widgetsEq(e,t){return e==t||!!(e&&t&&e.compare(t))}function addRange(e,t,i,o=0){let s=i.length-1;s>=0&&i[s]+o>e?i[s]=Math.max(i[s],t):i.push(e,t)}PointDecoration.prototype.point=!0;class LineView extends ContentView{constructor(){super(...arguments),this.children=[],this.length=0,this.prevAttrs=void 0,this.attrs=null,this.breakAfter=0}merge(e,t,i,o,s,n){if(i){if(!(i instanceof LineView))return!1;this.dom||i.transferDOM(this)}return o&&this.setDeco(i?i.attrs:null),mergeChildrenInto(this,e,t,i?i.children:[],s,n),!0}split(e){let t=new LineView;if(t.breakAfter=this.breakAfter,0==this.length)return t;let{i,off:o}=this.childPos(e);o&&(t.append(this.children[i].split(o),0),this.children[i].merge(o,this.children[i].length,null,!1,0,0),i++);for(let e=i;e<this.children.length;e++)t.append(this.children[e],0);for(;i>0&&0==this.children[i-1].length;)this.children[--i].destroy();return this.children.length=i,this.markDirty(),this.length=e,t}transferDOM(e){this.dom&&(e.setDOM(this.dom),e.prevAttrs=void 0===this.prevAttrs?this.attrs:this.prevAttrs,this.prevAttrs=void 0,this.dom=null)}setDeco(e){attrsEq(this.attrs,e)||(this.dom&&(this.prevAttrs=this.attrs,this.markDirty()),this.attrs=e)}append(e,t){joinInlineInto(this,e,t)}addLineDeco(e){let t=e.spec.attributes,i=e.spec.class;t&&(this.attrs=combineAttrs(t,this.attrs||{})),i&&(this.attrs=combineAttrs({class:i},this.attrs||{}))}domAtPos(e){return inlineDOMAtPos(this.dom,this.children,e)}reuseDOM(e){"DIV"==e.nodeName&&(this.setDOM(e),this.dirty|=6)}sync(e){var t;this.dom?4&this.dirty&&(clearAttributes(this.dom),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0):(this.setDOM(document.createElement("div")),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0),void 0!==this.prevAttrs&&(updateAttrs(this.dom,this.prevAttrs,this.attrs),this.dom.classList.add("cm-line"),this.prevAttrs=void 0),super.sync(e);let i=this.dom.lastChild;for(;i&&ContentView.get(i)instanceof MarkView;)i=i.lastChild;if(!i||"BR"!=i.nodeName&&0==(null===(t=ContentView.get(i))||void 0===t?void 0:t.isEditable)&&(!browser.ios||!this.children.some(e=>e instanceof TextView))){let e=document.createElement("BR");e.cmIgnore=!0,this.dom.appendChild(e)}}measureTextSize(){if(0==this.children.length||this.length>20)return null;let e=0;for(let t of this.children){if(!(t instanceof TextView))return null;let i=clientRectsFor(t.dom);if(1!=i.length)return null;e+=i[0].width}return{lineHeight:this.dom.getBoundingClientRect().height,charWidth:e/this.length}}coordsAt(e,t){return coordsInChildren(this,e,t)}become(e){return!1}get type(){return BlockType.Text}static find(e,t){for(let i=0,o=0;i<e.children.length;i++){let s=e.children[i],n=o+s.length;if(n>=t){if(s instanceof LineView)return s;if(n>t)break}o=n+s.breakAfter}return null}}class BlockWidgetView extends ContentView{constructor(e,t,i){super(),this.widget=e,this.length=t,this.type=i,this.breakAfter=0}merge(e,t,i,o,s,n){return!(i&&(!(i instanceof BlockWidgetView&&this.widget.compare(i.widget))||e>0&&s<=0||t<this.length&&n<=0))&&(this.length=e+(i?i.length:0)+(this.length-t),!0)}domAtPos(e){return 0==e?DOMPos.before(this.dom):DOMPos.after(this.dom,e==this.length)}split(e){let t=this.length-e;this.length=e;let i=new BlockWidgetView(this.widget,t,this.type);return i.breakAfter=this.breakAfter,i}get children(){return noChildren}sync(){this.dom&&this.widget.updateDOM(this.dom)||(this.setDOM(this.widget.toDOM(this.editorView)),this.dom.contentEditable="false")}get overrideDOMText(){return this.parent?this.parent.view.state.doc.slice(this.posAtStart,this.posAtEnd):Text$1.empty}domBoundsAround(){return null}become(e){return e instanceof BlockWidgetView&&e.type==this.type&&e.widget.constructor==this.widget.constructor&&(e.widget.eq(this.widget)||this.markDirty(!0),this.widget=e.widget,this.length=e.length,this.breakAfter=e.breakAfter,!0)}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class ContentBuilder{constructor(e,t,i,o){this.doc=e,this.pos=t,this.end=i,this.disallowBlockEffectsBelow=o,this.content=[],this.curLine=null,this.breakAtStart=0,this.pendingBuffer=0,this.atCursorPos=!0,this.openStart=-1,this.openEnd=-1,this.text="",this.textOff=0,this.cursor=e.iter(),this.skip=t}posCovered(){if(0==this.content.length)return!this.breakAtStart&&this.doc.lineAt(this.pos).from!=this.pos;let e=this.content[this.content.length-1];return!(e.breakAfter||e instanceof BlockWidgetView&&e.type==BlockType.WidgetBefore)}getLine(){return this.curLine||(this.content.push(this.curLine=new LineView),this.atCursorPos=!0),this.curLine}flushBuffer(e){this.pendingBuffer&&(this.curLine.append(wrapMarks(new WidgetBufferView(-1),e),e.length),this.pendingBuffer=0)}addBlockWidget(e){this.flushBuffer([]),this.curLine=null,this.content.push(e)}finish(e){e?this.pendingBuffer=0:this.flushBuffer([]),this.posCovered()||this.getLine()}buildText(e,t,i){for(;e>0;){if(this.textOff==this.text.length){let{value:t,lineBreak:i,done:o}=this.cursor.next(this.skip);if(this.skip=0,o)throw new Error("Ran out of text content when drawing inline views");if(i){this.posCovered()||this.getLine(),this.content.length?this.content[this.content.length-1].breakAfter=1:this.breakAtStart=1,this.flushBuffer([]),this.curLine=null,e--;continue}this.text=t,this.textOff=0}let o=Math.min(this.text.length-this.textOff,e,512);this.flushBuffer(t),this.getLine().append(wrapMarks(new TextView(this.text.slice(this.textOff,this.textOff+o)),t),i),this.atCursorPos=!0,this.textOff+=o,e-=o,i=0}}span(e,t,i,o){this.buildText(t-e,i,o),this.pos=t,this.openStart<0&&(this.openStart=o)}point(e,t,i,o,s){let n=t-e;if(i instanceof PointDecoration)if(i.block){let{type:e}=i;e!=BlockType.WidgetAfter||this.posCovered()||this.getLine(),this.addBlockWidget(new BlockWidgetView(i.widget||new NullWidget("div"),n,e))}else{let r=WidgetView.create(i.widget||new NullWidget("span"),n,i.startSide),l=this.atCursorPos&&!r.isEditable&&s<=o.length&&(e<t||i.startSide>0),a=!r.isEditable&&(e<t||i.startSide<=0),h=this.getLine();2!=this.pendingBuffer||l||(this.pendingBuffer=0),this.flushBuffer(o),l&&(h.append(wrapMarks(new WidgetBufferView(1),o),s),s=o.length+Math.max(0,s-o.length)),h.append(wrapMarks(r,o),s),this.atCursorPos=a,this.pendingBuffer=a?e<t?1:2:0}else this.doc.lineAt(this.pos).from==this.pos&&this.getLine().addLineDeco(i);n&&(this.textOff+n<=this.text.length?this.textOff+=n:(this.skip+=n-(this.text.length-this.textOff),this.text="",this.textOff=0),this.pos=t),this.openStart<0&&(this.openStart=s)}filterPoint(e,t,i,o){if(o>=this.disallowBlockEffectsBelow||!(i instanceof PointDecoration))return!0;if(i.block)throw new RangeError("Block decorations may not be specified via plugins");return t<=this.doc.lineAt(this.pos).to}static build(e,t,i,o,s){let n=new ContentBuilder(e,t,i,s);return n.openEnd=RangeSet.spans(o,t,i,n),n.openStart<0&&(n.openStart=n.openEnd),n.finish(n.openEnd),n}}function wrapMarks(e,t){for(let i of t)e=new MarkView(i,[e],e.length);return e}class NullWidget extends WidgetType{constructor(e){super(),this.tag=e}eq(e){return e.tag==this.tag}toDOM(){return document.createElement(this.tag)}updateDOM(e){return e.nodeName.toLowerCase()==this.tag}}const none=[],clickAddsSelectionRange=Facet.define(),dragMovesSelection$1=Facet.define(),mouseSelectionStyle=Facet.define(),exceptionSink=Facet.define(),updateListener=Facet.define(),inputHandler=Facet.define(),scrollTo=StateEffect.define({map:(e,t)=>e.map(t)}),centerOn=StateEffect.define({map:(e,t)=>e.map(t)});class ScrollTarget{constructor(e,t="nearest",i="nearest",o=5,s=5){this.range=e,this.y=t,this.x=i,this.yMargin=o,this.xMargin=s}map(e){return e.empty?this:new ScrollTarget(this.range.map(e),this.y,this.x,this.yMargin,this.xMargin)}}const scrollIntoView=StateEffect.define({map:(e,t)=>e.map(t)});function logException(e,t,i){let o=e.facet(exceptionSink);o.length?o[0](t):window.onerror?window.onerror(String(t),i,void 0,void 0,t):i?console.error(i+":",t):console.error(t)}const editable=Facet.define({combine:e=>!e.length||e[0]});class PluginFieldProvider{constructor(e,t){this.field=e,this.get=t}}class PluginField{from(e){return new PluginFieldProvider(this,e)}static define(){return new PluginField}}PluginField.decorations=PluginField.define(),PluginField.atomicRanges=PluginField.define(),PluginField.scrollMargins=PluginField.define();let nextPluginID=0;const viewPlugin=Facet.define();class ViewPlugin{constructor(e,t,i){this.id=e,this.create=t,this.fields=i,this.extension=viewPlugin.of(this)}static define(e,t){let{eventHandlers:i,provide:o,decorations:s}=t||{},n=[];if(o)for(let e of Array.isArray(o)?o:[o])n.push(e);return i&&n.push(domEventHandlers.from(e=>({plugin:e,handlers:i}))),s&&n.push(PluginField.decorations.from(s)),new ViewPlugin(nextPluginID++,e,n)}static fromClass(e,t){return ViewPlugin.define(t=>new e(t),t)}}const domEventHandlers=PluginField.define();class PluginInstance{constructor(e){this.spec=e,this.mustUpdate=null,this.value=null}takeField(e,t){if(this.spec)for(let{field:i,get:o}of this.spec.fields)i==e&&t.push(o(this.value))}update(e){if(this.value){if(this.mustUpdate){let e=this.mustUpdate;if(this.mustUpdate=null,this.value.update)try{this.value.update(e)}catch(t){if(logException(e.state,t,"CodeMirror plugin crashed"),this.value.destroy)try{this.value.destroy()}catch(e){}this.deactivate()}}}else if(this.spec)try{this.value=this.spec.create(e)}catch(t){logException(e.state,t,"CodeMirror plugin crashed"),this.deactivate()}return this}destroy(e){var t;if(null===(t=this.value)||void 0===t?void 0:t.destroy)try{this.value.destroy()}catch(t){logException(e.state,t,"CodeMirror plugin crashed")}}deactivate(){this.spec=this.value=null}}const editorAttributes=Facet.define(),contentAttributes=Facet.define(),decorations=Facet.define(),styleModule=Facet.define();class ChangedRange{constructor(e,t,i,o){this.fromA=e,this.toA=t,this.fromB=i,this.toB=o}join(e){return new ChangedRange(Math.min(this.fromA,e.fromA),Math.max(this.toA,e.toA),Math.min(this.fromB,e.fromB),Math.max(this.toB,e.toB))}addToSet(e){let t=e.length,i=this;for(;t>0;t--){let o=e[t-1];if(!(o.fromA>i.toA)){if(o.toA<i.fromA)break;i=i.join(o),e.splice(t-1,1)}}return e.splice(t,0,i),e}static extendWithRanges(e,t){if(0==t.length)return e;let i=[];for(let o=0,s=0,n=0,r=0;;o++){let l=o==e.length?null:e[o],a=n-r,h=l?l.fromB:1e9;for(;s<t.length&&t[s]<h;){let e=t[s],o=t[s+1],n=Math.max(r,e),l=Math.min(h,o);if(n<=l&&new ChangedRange(n+a,l+a,n,l).addToSet(i),o>h)break;s+=2}if(!l)return i;new ChangedRange(l.fromA,l.toA,l.fromB,l.toB).addToSet(i),n=l.toA,r=l.toB}}}class ViewUpdate{constructor(e,t,i=none){this.view=e,this.state=t,this.transactions=i,this.flags=0,this.startState=e.state,this.changes=ChangeSet.empty(this.startState.doc.length);for(let e of i)this.changes=this.changes.compose(e.changes);let o=[];this.changes.iterChangedRanges((e,t,i,s)=>o.push(new ChangedRange(e,t,i,s))),this.changedRanges=o;let s=e.hasFocus;s!=e.inputState.notifiedFocused&&(e.inputState.notifiedFocused=s,this.flags|=1)}get viewportChanged(){return(4&this.flags)>0}get heightChanged(){return(2&this.flags)>0}get geometryChanged(){return this.docChanged||(10&this.flags)>0}get focusChanged(){return(1&this.flags)>0}get docChanged(){return!this.changes.empty}get selectionSet(){return this.transactions.some(e=>e.selection)}get empty(){return 0==this.flags&&0==this.transactions.length}}var Direction=function(e){return e[e.LTR=0]="LTR",e[e.RTL=1]="RTL",e}(Direction||(Direction={}));const LTR=Direction.LTR,RTL=Direction.RTL;function dec(e){let t=[];for(let i=0;i<e.length;i++)t.push(1<<+e[i]);return t}const LowTypes=dec("88888888888888888888888888888888888666888888787833333333337888888000000000000000000000000008888880000000000000000000000000088888888888888888888888888888888888887866668888088888663380888308888800000000000000000000000800000000000000000000000000000008"),ArabicTypes=dec("4444448826627288999999999992222222222222222222222222222222222222222222222229999999999999999999994444444444644222822222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222999999949999999229989999223333333333"),Brackets=Object.create(null),BracketStack=[];for(let e of["()","[]","{}"]){let t=e.charCodeAt(0),i=e.charCodeAt(1);Brackets[t]=i,Brackets[i]=-t}function charType(e){return e<=247?LowTypes[e]:1424<=e&&e<=1524?2:1536<=e&&e<=1785?ArabicTypes[e-1536]:1774<=e&&e<=2220?4:8192<=e&&e<=8203||8204==e?256:1}const BidiRE=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;class BidiSpan{constructor(e,t,i){this.from=e,this.to=t,this.level=i}get dir(){return this.level%2?RTL:LTR}side(e,t){return this.dir==t==e?this.to:this.from}static find(e,t,i,o){let s=-1;for(let n=0;n<e.length;n++){let r=e[n];if(r.from<=t&&r.to>=t){if(r.level==i)return n;(s<0||(0!=o?o<0?r.from<t:r.to>t:e[s].level>r.level))&&(s=n)}}if(s<0)throw new RangeError("Index out of range");return s}}const types=[];function computeOrder(e,t){let i=e.length,o=t==LTR?1:2,s=t==LTR?2:1;if(!e||1==o&&!BidiRE.test(e))return trivialOrder(i);for(let t=0,s=o,n=o;t<i;t++){let i=charType(e.charCodeAt(t));512==i?i=s:8==i&&4==n&&(i=16),types[t]=4==i?2:i,7&i&&(n=i),s=i}for(let e=0,t=o,s=o;e<i;e++){let o=types[e];if(128==o)e<i-1&&t==types[e+1]&&24&t?o=types[e]=t:types[e]=256;else if(64==o){let o=e+1;for(;o<i&&64==types[o];)o++;let n=e&&8==t||o<i&&8==types[o]?1==s?1:8:256;for(let t=e;t<o;t++)types[t]=n;e=o-1}else 8==o&&1==s&&(types[e]=1);t=o,7&o&&(s=o)}for(let t,n,r,l=0,a=0,h=0;l<i;l++)if(n=Brackets[t=e.charCodeAt(l)])if(n<0){for(let e=a-3;e>=0;e-=3)if(BracketStack[e+1]==-n){let t=BracketStack[e+2],i=2&t?o:4&t?1&t?s:o:0;i&&(types[l]=types[BracketStack[e]]=i),a=e;break}}else{if(189==BracketStack.length)break;BracketStack[a++]=l,BracketStack[a++]=t,BracketStack[a++]=h}else if(2==(r=types[l])||1==r){let e=r==o;h=e?0:1;for(let t=a-3;t>=0;t-=3){let i=BracketStack[t+2];if(2&i)break;if(e)BracketStack[t+2]|=2;else{if(4&i)break;BracketStack[t+2]|=4}}}for(let e=0;e<i;e++)if(256==types[e]){let t=e+1;for(;t<i&&256==types[t];)t++;let s=1==(e?types[e-1]:o),n=s==(1==(t<i?types[t]:o))?s?1:2:o;for(let i=e;i<t;i++)types[i]=n;e=t-1}let n=[];if(1==o)for(let e=0;e<i;){let t=e,o=1!=types[e++];for(;e<i&&o==(1!=types[e]);)e++;if(o)for(let i=e;i>t;){let e=i,o=2!=types[--i];for(;i>t&&o==(2!=types[i-1]);)i--;n.push(new BidiSpan(i,e,o?2:1))}else n.push(new BidiSpan(t,e,0))}else for(let e=0;e<i;){let t=e,o=2==types[e++];for(;e<i&&o==(2==types[e]);)e++;n.push(new BidiSpan(t,e,o?1:2))}return n}function trivialOrder(e){return[new BidiSpan(0,e,0)]}let movedOver="";function moveVisually(e,t,i,o,s){var n;let r=o.head-e.from,l=-1;if(0==r){if(!s||!e.length)return null;t[0].level!=i&&(r=t[0].side(!1,i),l=0)}else if(r==e.length){if(s)return null;let e=t[t.length-1];e.level!=i&&(r=e.side(!0,i),l=t.length-1)}l<0&&(l=BidiSpan.find(t,r,null!==(n=o.bidiLevel)&&void 0!==n?n:-1,o.assoc));let a=t[l];r==a.side(s,i)&&(a=t[l+=s?1:-1],r=a.side(!s,i));let h=s==(a.dir==i),c=findClusterBreak(e.text,r,h);if(movedOver=e.text.slice(Math.min(r,c),Math.max(r,c)),c!=a.side(s,i))return EditorSelection.cursor(c+e.from,h?-1:1,a.level);let d=l==(s?t.length-1:0)?null:t[l+(s?1:-1)];return d||a.level==i?d&&d.level<a.level?EditorSelection.cursor(d.side(!s,i)+e.from,s?1:-1,d.level):EditorSelection.cursor(c+e.from,s?-1:1,a.level):EditorSelection.cursor(s?e.to:e.from,s?-1:1,i)}class DOMReader{constructor(e,t){this.points=e,this.view=t,this.text="",this.lineBreak=t.state.lineBreak}readRange(e,t){if(!e)return this;let i=e.parentNode;for(let o=e;;){this.findPointBefore(i,o),this.readNode(o);let e=o.nextSibling;if(e==t)break;let s=ContentView.get(o),n=ContentView.get(e);(s&&n?s.breakAfter:(s?s.breakAfter:isBlockElement(o))||isBlockElement(e)&&("BR"!=o.nodeName||o.cmIgnore))&&(this.text+=this.lineBreak),o=e}return this.findPointBefore(i,t),this}readNode(e){if(e.cmIgnore)return;let t,i=ContentView.get(e),o=i&&i.overrideDOMText;null!=o?t=o.sliceString(0,void 0,this.lineBreak):3==e.nodeType?t=e.nodeValue:"BR"==e.nodeName?t=e.nextSibling?this.lineBreak:"":1==e.nodeType&&this.readRange(e.firstChild,null),null!=t&&(this.findPointIn(e,t.length),this.text+=t,browser.chrome&&13==this.view.inputState.lastKeyCode&&!e.nextSibling&&/\n\n$/.test(this.text)&&(this.text=this.text.slice(0,-1)))}findPointBefore(e,t){for(let i of this.points)i.node==e&&e.childNodes[i.offset]==t&&(i.pos=this.text.length)}findPointIn(e,t){for(let i of this.points)i.node==e&&(i.pos=this.text.length+Math.min(i.offset,t))}}function isBlockElement(e){return 1==e.nodeType&&/^(DIV|P|LI|UL|OL|BLOCKQUOTE|DD|DT|H\d|SECTION|PRE)$/.test(e.nodeName)}class DOMPoint{constructor(e,t){this.node=e,this.offset=t,this.pos=-1}}class DocView extends ContentView{constructor(e){super(),this.view=e,this.compositionDeco=Decoration.none,this.decorations=[],this.pluginDecorationLength=0,this.minWidth=0,this.minWidthFrom=0,this.minWidthTo=0,this.impreciseAnchor=null,this.impreciseHead=null,this.forceSelection=!1,this.lastUpdate=Date.now(),this.setDOM(e.contentDOM),this.children=[new LineView],this.children[0].setParent(this),this.updateDeco(),this.updateInner([new ChangedRange(0,0,0,e.state.doc.length)],0)}get root(){return this.view.root}get editorView(){return this.view}get length(){return this.view.state.doc.length}update(e){let t=e.changedRanges;this.minWidth>0&&t.length&&(t.every(({fromA:e,toA:t})=>t<this.minWidthFrom||e>this.minWidthTo)?(this.minWidthFrom=e.changes.mapPos(this.minWidthFrom,1),this.minWidthTo=e.changes.mapPos(this.minWidthTo,1)):this.minWidth=this.minWidthFrom=this.minWidthTo=0),this.view.inputState.composing<0?this.compositionDeco=Decoration.none:(e.transactions.length||this.dirty)&&(this.compositionDeco=computeCompositionDeco(this.view,e.changes)),(browser.ie||browser.chrome)&&!this.compositionDeco.size&&e&&e.state.doc.lines!=e.startState.doc.lines&&(this.forceSelection=!0);let i=findChangedDeco(this.decorations,this.updateDeco(),e.changes);return t=ChangedRange.extendWithRanges(t,i),(0!=this.dirty||0!=t.length)&&(this.updateInner(t,e.startState.doc.length),e.transactions.length&&(this.lastUpdate=Date.now()),!0)}updateInner(e,t){this.view.viewState.mustMeasureContent=!0,this.updateChildren(e,t);let{observer:i}=this.view;i.ignore(()=>{this.dom.style.height=this.view.viewState.contentHeight+"px",this.dom.style.minWidth=this.minWidth?this.minWidth+"px":"";let e=browser.chrome||browser.ios?{node:i.selectionRange.focusNode,written:!1}:void 0;this.sync(e),this.dirty=0,e&&(e.written||i.selectionRange.focusNode!=e.node)&&(this.forceSelection=!0),this.dom.style.height=""});let o=[];if(this.view.viewport.from||this.view.viewport.to<this.view.state.doc.length)for(let e of this.children)e instanceof BlockWidgetView&&e.widget instanceof BlockGapWidget&&o.push(e.dom);i.updateGaps(o)}updateChildren(e,t){let i=this.childCursor(t);for(let t=e.length-1;;t--){let o=t>=0?e[t]:null;if(!o)break;let{fromA:s,toA:n,fromB:r,toB:l}=o,{content:a,breakAtStart:h,openStart:c,openEnd:d}=ContentBuilder.build(this.view.state.doc,r,l,this.decorations,this.pluginDecorationLength),{i:u,off:p}=i.findPos(n,1),{i:f,off:g}=i.findPos(s,-1);replaceRange(this,f,g,u,p,a,h,c,d)}}updateSelection(e=!1,t=!1){if(e&&this.view.observer.readSelectionRange(),!t&&!this.mayControlSelection()||browser.ios&&this.view.inputState.rapidCompositionStart)return;let i=this.forceSelection;this.forceSelection=!1;let o=this.view.state.selection.main,s=this.domAtPos(o.anchor),n=o.empty?s:this.domAtPos(o.head);if(browser.gecko&&o.empty&&betweenUneditable(s)){let e=document.createTextNode("");this.view.observer.ignore(()=>s.node.insertBefore(e,s.node.childNodes[s.offset]||null)),s=n=new DOMPos(e,0),i=!0}let r=this.view.observer.selectionRange;!i&&r.focusNode&&isEquivalentPosition(s.node,s.offset,r.anchorNode,r.anchorOffset)&&isEquivalentPosition(n.node,n.offset,r.focusNode,r.focusOffset)||(this.view.observer.ignore(()=>{browser.android&&browser.chrome&&this.dom.contains(r.focusNode)&&inUneditable(r.focusNode,this.dom)&&(this.dom.blur(),this.dom.focus({preventScroll:!0}));let e=getSelection(this.root);if(o.empty){if(browser.gecko){let e=nextToUneditable(s.node,s.offset);if(e&&3!=e){let t=nearbyTextNode(s.node,s.offset,1==e?1:-1);t&&(s=new DOMPos(t,1==e?0:t.nodeValue.length))}}e.collapse(s.node,s.offset),null!=o.bidiLevel&&null!=r.cursorBidiLevel&&(r.cursorBidiLevel=o.bidiLevel)}else if(e.extend)e.collapse(s.node,s.offset),e.extend(n.node,n.offset);else{let t=document.createRange();o.anchor>o.head&&([s,n]=[n,s]),t.setEnd(n.node,n.offset),t.setStart(s.node,s.offset),e.removeAllRanges(),e.addRange(t)}}),this.view.observer.setSelectionRange(s,n)),this.impreciseAnchor=s.precise?null:new DOMPos(r.anchorNode,r.anchorOffset),this.impreciseHead=n.precise?null:new DOMPos(r.focusNode,r.focusOffset)}enforceCursorAssoc(){if(this.compositionDeco.size)return;let e=this.view.state.selection.main,t=getSelection(this.root);if(!e.empty||!e.assoc||!t.modify)return;let i=LineView.find(this,e.head);if(!i)return;let o=i.posAtStart;if(e.head==o||e.head==o+i.length)return;let s=this.coordsAt(e.head,-1),n=this.coordsAt(e.head,1);if(!s||!n||s.bottom>n.top)return;let r=this.domAtPos(e.head+e.assoc);t.collapse(r.node,r.offset),t.modify("move",e.assoc<0?"forward":"backward","lineboundary")}mayControlSelection(){return this.view.state.facet(editable)?this.root.activeElement==this.dom:hasSelection(this.dom,this.view.observer.selectionRange)}nearest(e){for(let t=e;t;){let e=ContentView.get(t);if(e&&e.rootView==this)return e;t=t.parentNode}return null}posFromDOM(e,t){let i=this.nearest(e);if(!i)throw new RangeError("Trying to find position for a DOM position outside of the document");return i.localPosFromDOM(e,t)+i.posAtStart}domAtPos(e){let{i:t,off:i}=this.childCursor().findPos(e,-1);for(;t<this.children.length-1;){let e=this.children[t];if(i<e.length||e instanceof LineView)break;t++,i=0}return this.children[t].domAtPos(i)}coordsAt(e,t){for(let i=this.length,o=this.children.length-1;;o--){let s=this.children[o],n=i-s.breakAfter-s.length;if(e>n||e==n&&s.type!=BlockType.WidgetBefore&&s.type!=BlockType.WidgetAfter&&(!o||2==t||this.children[o-1].breakAfter||this.children[o-1].type==BlockType.WidgetBefore&&t>-2))return s.coordsAt(e-n,t);i=n}}measureVisibleLineHeights(){let e=[],{from:t,to:i}=this.view.viewState.viewport,o=this.view.contentDOM.clientWidth,s=o>Math.max(this.view.scrollDOM.clientWidth,this.minWidth)+1,n=-1;for(let r=0,l=0;l<this.children.length;l++){let a=this.children[l],h=r+a.length;if(h>i)break;if(r>=t){let t=a.dom.getBoundingClientRect();if(e.push(t.height),s){let e=a.dom.lastChild,i=e?clientRectsFor(e):[];if(i.length){let e=i[i.length-1],s=this.view.textDirection==Direction.LTR?e.right-t.left:t.right-e.left;s>n&&(n=s,this.minWidth=o,this.minWidthFrom=r,this.minWidthTo=h)}}}r=h+a.breakAfter}return e}measureTextSize(){for(let e of this.children)if(e instanceof LineView){let t=e.measureTextSize();if(t)return t}let e,t,i=document.createElement("div");return i.className="cm-line",i.textContent="abc def ghi jkl mno pqr stu",this.view.observer.ignore(()=>{this.dom.appendChild(i);let o=clientRectsFor(i.firstChild)[0];e=i.getBoundingClientRect().height,t=o?o.width/27:7,i.remove()}),{lineHeight:e,charWidth:t}}childCursor(e=this.length){let t=this.children.length;return t&&(e-=this.children[--t].length),new ChildCursor(this.children,e,t)}computeBlockGapDeco(){let e=[],t=this.view.viewState;for(let i=0,o=0;;o++){let s=o==t.viewports.length?null:t.viewports[o],n=s?s.from-1:this.length;if(n>i){let o=t.lineBlockAt(n).bottom-t.lineBlockAt(i).top;e.push(Decoration.replace({widget:new BlockGapWidget(o),block:!0,inclusive:!0}).range(i,n))}if(!s)break;i=s.to+1}return Decoration.set(e)}updateDeco(){let e=this.view.pluginField(PluginField.decorations);return this.pluginDecorationLength=e.length,this.decorations=[...e,...this.view.state.facet(decorations),this.compositionDeco,this.computeBlockGapDeco(),this.view.viewState.lineGapDeco]}scrollIntoView(e){let t,{range:i}=e,o=this.coordsAt(i.head,i.empty?i.assoc:i.head>i.anchor?-1:1);if(!o)return;!i.empty&&(t=this.coordsAt(i.anchor,i.anchor>i.head?-1:1))&&(o={left:Math.min(o.left,t.left),top:Math.min(o.top,t.top),right:Math.max(o.right,t.right),bottom:Math.max(o.bottom,t.bottom)});let s=0,n=0,r=0,l=0;for(let e of this.view.pluginField(PluginField.scrollMargins))if(e){let{left:t,right:i,top:o,bottom:a}=e;null!=t&&(s=Math.max(s,t)),null!=i&&(n=Math.max(n,i)),null!=o&&(r=Math.max(r,o)),null!=a&&(l=Math.max(l,a))}let a={left:o.left-s,top:o.top-r,right:o.right+n,bottom:o.bottom+l};scrollRectIntoView(this.view.scrollDOM,a,i.head<i.anchor?-1:1,e.x,e.y,e.xMargin,e.yMargin,this.view.textDirection==Direction.LTR)}}function betweenUneditable(e){return 1==e.node.nodeType&&e.node.firstChild&&(0==e.offset||"false"==e.node.childNodes[e.offset-1].contentEditable)&&(e.offset==e.node.childNodes.length||"false"==e.node.childNodes[e.offset].contentEditable)}class BlockGapWidget extends WidgetType{constructor(e){super(),this.height=e}toDOM(){let e=document.createElement("div");return this.updateDOM(e),e}eq(e){return e.height==this.height}updateDOM(e){return e.style.height=this.height+"px",!0}get estimatedHeight(){return this.height}}function computeCompositionDeco(e,t){let i=e.observer.selectionRange,o=i.focusNode&&nearbyTextNode(i.focusNode,i.focusOffset,0);if(!o)return Decoration.none;let s=e.docView.nearest(o);if(!s)return Decoration.none;let n,r,l=o;if(s instanceof LineView){for(;l.parentNode!=s.dom;)l=l.parentNode;let e=l.previousSibling;for(;e&&!ContentView.get(e);)e=e.previousSibling;n=r=e?ContentView.get(e).posAtEnd:s.posAtStart}else{for(;;){let{parent:e}=s;if(!e)return Decoration.none;if(e instanceof LineView)break;s=e}n=s.posAtStart,r=n+s.length,l=s.dom}let a=t.mapPos(n,1),h=Math.max(a,t.mapPos(r,-1)),{state:c}=e,d=3==l.nodeType?l.nodeValue:new DOMReader([],e).readRange(l.firstChild,null).text;if(h-a<d.length)if(c.sliceDoc(a,Math.min(c.doc.length,a+d.length))==d)h=a+d.length;else{if(c.sliceDoc(Math.max(0,h-d.length),h)!=d)return Decoration.none;a=h-d.length}else if(c.sliceDoc(a,h)!=d)return Decoration.none;return Decoration.set(Decoration.replace({widget:new CompositionWidget(l,o)}).range(a,h))}class CompositionWidget extends WidgetType{constructor(e,t){super(),this.top=e,this.text=t}eq(e){return this.top==e.top&&this.text==e.text}toDOM(){return this.top}ignoreEvent(){return!1}get customView(){return CompositionView}}function nearbyTextNode(e,t,i){for(;;){if(3==e.nodeType)return e;if(1==e.nodeType&&t>0&&i<=0)t=maxOffset(e=e.childNodes[t-1]);else{if(!(1==e.nodeType&&t<e.childNodes.length&&i>=0))return null;e=e.childNodes[t],t=0}}}function nextToUneditable(e,t){return 1!=e.nodeType?0:(t&&"false"==e.childNodes[t-1].contentEditable?1:0)|(t<e.childNodes.length&&"false"==e.childNodes[t].contentEditable?2:0)}class DecorationComparator$1{constructor(){this.changes=[]}compareRange(e,t){addRange(e,t,this.changes)}comparePoint(e,t){addRange(e,t,this.changes)}}function findChangedDeco(e,t,i){let o=new DecorationComparator$1;return RangeSet.compare(e,t,i,o),o.changes}function inUneditable(e,t){for(let i=e;i&&i!=t;i=i.assignedSlot||i.parentNode)if(1==i.nodeType&&"false"==i.contentEditable)return!0;return!1}function groupAt(e,t,i=1){let o=e.charCategorizer(t),s=e.doc.lineAt(t),n=t-s.from;if(0==s.length)return EditorSelection.cursor(t);0==n?i=1:n==s.length&&(i=-1);let r=n,l=n;i<0?r=findClusterBreak(s.text,n,!1):l=findClusterBreak(s.text,n);let a=o(s.text.slice(r,l));for(;r>0;){let e=findClusterBreak(s.text,r,!1);if(o(s.text.slice(e,r))!=a)break;r=e}for(;l<s.length;){let e=findClusterBreak(s.text,l);if(o(s.text.slice(l,e))!=a)break;l=e}return EditorSelection.range(r+s.from,l+s.from)}function getdx(e,t){return t.left>e?t.left-e:Math.max(0,e-t.right)}function getdy(e,t){return t.top>e?t.top-e:Math.max(0,e-t.bottom)}function yOverlap(e,t){return e.top<t.bottom-1&&e.bottom>t.top+1}function upTop(e,t){return t<e.top?{top:t,left:e.left,right:e.right,bottom:e.bottom}:e}function upBot(e,t){return t>e.bottom?{top:e.top,left:e.left,right:e.right,bottom:t}:e}function domPosAtCoords(e,t,i){let o,s,n,r,l,a,h,c;for(let d=e.firstChild;d;d=d.nextSibling){let e=clientRectsFor(d);for(let u=0;u<e.length;u++){let p=e[u];s&&yOverlap(s,p)&&(p=upTop(upBot(p,s.bottom),s.top));let f=getdx(t,p),g=getdy(i,p);if(0==f&&0==g)return 3==d.nodeType?domPosInText(d,t,i):domPosAtCoords(d,t,i);(!o||r>g||r==g&&n>f)&&(o=d,s=p,n=f,r=g),0==f?i>p.bottom&&(!h||h.bottom<p.bottom)?(l=d,h=p):i<p.top&&(!c||c.top>p.top)&&(a=d,c=p):h&&yOverlap(h,p)?h=upBot(h,p.bottom):c&&yOverlap(c,p)&&(c=upTop(c,p.top))}}if(h&&h.bottom>=i?(o=l,s=h):c&&c.top<=i&&(o=a,s=c),!o)return{node:e,offset:0};let d=Math.max(s.left,Math.min(s.right,t));return 3==o.nodeType?domPosInText(o,d,i):n||"true"!=o.contentEditable?{node:e,offset:Array.prototype.indexOf.call(e.childNodes,o)+(t>=(s.left+s.right)/2?1:0)}:domPosAtCoords(o,d,i)}function domPosInText(e,t,i){let o=e.nodeValue.length,s=-1,n=1e9,r=0;for(let l=0;l<o;l++){let o=textRange(e,l,l+1).getClientRects();for(let a=0;a<o.length;a++){let h=o[a];if(h.top==h.bottom)continue;r||(r=t-h.left);let c=(h.top>i?h.top-i:i-h.bottom)-1;if(h.left-1<=t&&h.right+1>=t&&c<n){let i=t>=(h.left+h.right)/2,o=i;if(browser.chrome||browser.gecko){textRange(e,l).getBoundingClientRect().left==h.right&&(o=!i)}if(c<=0)return{node:e,offset:l+(o?1:0)};s=l+(o?1:0),n=c}}}return{node:e,offset:s>-1?s:r>0?e.nodeValue.length:0}}function posAtCoords(e,{x:t,y:i},o,s=-1){var n;let r,l=e.contentDOM.getBoundingClientRect(),a=l.top+e.viewState.paddingTop,{docHeight:h}=e.viewState,c=i-a;if(c<0)return 0;if(c>h)return e.state.doc.length;for(let t=e.defaultLineHeight/2,i=!1;r=e.elementAtHeight(c),r.type!=BlockType.Text;)for(;c=s>0?r.bottom+t:r.top-t,!(c>=0&&c<=h);){if(i)return o?null:0;i=!0,s=-s}i=a+c;let d=r.from;if(d<e.viewport.from)return 0==e.viewport.from?0:o?null:posAtCoordsImprecise(e,l,r,t,i);if(d>e.viewport.to)return e.viewport.to==e.state.doc.length?e.state.doc.length:o?null:posAtCoordsImprecise(e,l,r,t,i);let u=e.dom.ownerDocument,p=e.root.elementFromPoint?e.root:u,f=p.elementFromPoint(t,i);f&&!e.contentDOM.contains(f)&&(f=null),f||(t=Math.max(l.left+1,Math.min(l.right-1,t)),f=p.elementFromPoint(t,i),f&&!e.contentDOM.contains(f)&&(f=null));let g,m=-1;if(f&&0!=(null===(n=e.docView.nearest(f))||void 0===n?void 0:n.isEditable))if(u.caretPositionFromPoint){let e=u.caretPositionFromPoint(t,i);e&&({offsetNode:g,offset:m}=e)}else if(u.caretRangeFromPoint){let e=u.caretRangeFromPoint(t,i);e&&(({startContainer:g,startOffset:m}=e),browser.safari&&isSuspiciousCaretResult(g,m,t)&&(g=void 0))}if(!g||!e.docView.dom.contains(g)){let o=LineView.find(e.docView,d);if(!o)return c>r.top+r.height/2?r.to:r.from;({node:g,offset:m}=domPosAtCoords(o.dom,t,i))}return e.docView.posFromDOM(g,m)}function posAtCoordsImprecise(e,t,i,o,s){let n=Math.round((o-t.left)*e.defaultCharacterWidth);if(e.lineWrapping&&i.height>1.5*e.defaultLineHeight){n+=Math.floor((s-i.top)/e.defaultLineHeight)*e.viewState.heightOracle.lineLength}let r=e.state.sliceDoc(i.from,i.to);return i.from+findColumn(r,n,e.state.tabSize)}function isSuspiciousCaretResult(e,t,i){let o;if(3!=e.nodeType||t!=(o=e.nodeValue.length))return!1;for(let t=e.nextSibling;t;t=t.nextSibling)if(1!=t.nodeType||"BR"!=t.nodeName)return!1;return textRange(e,o-1,o).getBoundingClientRect().left>i}function moveToLineBoundary(e,t,i,o){let s=e.state.doc.lineAt(t.head),n=o&&e.lineWrapping?e.coordsAtPos(t.assoc<0&&t.head>s.from?t.head-1:t.head):null;if(n){let t=e.dom.getBoundingClientRect(),o=e.posAtCoords({x:i==(e.textDirection==Direction.LTR)?t.right-1:t.left+1,y:(n.top+n.bottom)/2});if(null!=o)return EditorSelection.cursor(o,i?-1:1)}let r=LineView.find(e.docView,t.head),l=r?i?r.posAtEnd:r.posAtStart:i?s.to:s.from;return EditorSelection.cursor(l,i?-1:1)}function moveByChar(e,t,i,o){let s=e.state.doc.lineAt(t.head),n=e.bidiSpans(s);for(let r=t,l=null;;){let t=moveVisually(s,n,e.textDirection,r,i),a=movedOver;if(!t){if(s.number==(i?e.state.doc.lines:1))return r;a="\n",s=e.state.doc.line(s.number+(i?1:-1)),n=e.bidiSpans(s),t=EditorSelection.cursor(i?s.from:s.to)}if(l){if(!l(a))return r}else{if(!o)return t;l=o(a)}r=t}}function byGroup(e,t,i){let o=e.state.charCategorizer(t),s=o(i);return e=>{let t=o(e);return s==CharCategory.Space&&(s=t),s==t}}function moveVertically(e,t,i,o){let s=t.head,n=i?1:-1;if(s==(i?e.state.doc.length:0))return EditorSelection.cursor(s);let r,l=t.goalColumn,a=e.contentDOM.getBoundingClientRect(),h=e.coordsAtPos(s),c=e.documentTop;if(h)null==l&&(l=h.left-a.left),r=n<0?h.top:h.bottom;else{let t=e.viewState.lineBlockAt(s-c);null==l&&(l=Math.min(a.right-a.left,e.defaultCharacterWidth*(s-t.from))),r=(n<0?t.top:t.bottom)+c}let d=a.left+l,u=null!=o?o:e.defaultLineHeight>>1;for(let t=0;;t+=10){let i=r+(u+t)*n,o=posAtCoords(e,{x:d,y:i},!1,n);if(i<a.top||i>a.bottom||(n<0?o<s:o>s))return EditorSelection.cursor(o,void 0,void 0,l)}}function skipAtoms(e,t,i){let o=e.pluginField(PluginField.atomicRanges);for(;;){let e=!1;for(let s of o)s.between(i.from-1,i.from+1,(o,s,n)=>{i.from>o&&i.from<s&&(i=t.from>i.from?EditorSelection.cursor(o,1):EditorSelection.cursor(s,-1),e=!0)});if(!e)return i}}class InputState{constructor(e){this.lastKeyCode=0,this.lastKeyTime=0,this.pendingIOSKey=void 0,this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastEscPress=0,this.lastContextMenu=0,this.scrollHandlers=[],this.registeredEvents=[],this.customHandlers=[],this.composing=-1,this.compositionFirstChange=null,this.compositionEndedAt=0,this.rapidCompositionStart=!1,this.mouseSelection=null;for(let t in handlers){let i=handlers[t];e.contentDOM.addEventListener(t,o=>{"keydown"==t&&this.keydown(e,o)||eventBelongsToEditor(e,o)&&!this.ignoreDuringComposition(o)&&(this.mustFlushObserver(o)&&e.observer.forceFlush(),this.runCustomHandlers(t,e,o)?o.preventDefault():i(e,o))}),this.registeredEvents.push(t)}this.notifiedFocused=e.hasFocus,this.ensureHandlers(e),browser.safari&&e.contentDOM.addEventListener("input",()=>null)}setSelectionOrigin(e){this.lastSelectionOrigin=e,this.lastSelectionTime=Date.now()}ensureHandlers(e){let t=this.customHandlers=e.pluginField(domEventHandlers);for(let i of t)for(let t in i.handlers)this.registeredEvents.indexOf(t)<0&&"scroll"!=t&&(this.registeredEvents.push(t),e.contentDOM.addEventListener(t,i=>{eventBelongsToEditor(e,i)&&this.runCustomHandlers(t,e,i)&&i.preventDefault()}))}runCustomHandlers(e,t,i){for(let o of this.customHandlers){let s=o.handlers[e];if(s)try{if(s.call(o.plugin,i,t)||i.defaultPrevented)return!0}catch(e){logException(t.state,e)}}return!1}runScrollHandlers(e,t){for(let i of this.customHandlers){let o=i.handlers.scroll;if(o)try{o.call(i.plugin,t,e)}catch(t){logException(e.state,t)}}}keydown(e,t){if(this.lastKeyCode=t.keyCode,this.lastKeyTime=Date.now(),this.screenKeyEvent(e,t))return!0;if(browser.android&&browser.chrome&&!t.synthetic&&(13==t.keyCode||8==t.keyCode))return e.observer.delayAndroidKey(t.key,t.keyCode),!0;let i;return!(!browser.ios||!(i=PendingKeys.find(e=>e.keyCode==t.keyCode))||t.ctrlKey||t.altKey||t.metaKey||t.synthetic)&&(this.pendingIOSKey=i,setTimeout(()=>this.flushIOSKey(e),250),!0)}flushIOSKey(e){let t=this.pendingIOSKey;return!!t&&(this.pendingIOSKey=void 0,dispatchKey(e.contentDOM,t.key,t.keyCode))}ignoreDuringComposition(e){return!!/^key/.test(e.type)&&(this.composing>0||!!(browser.safari&&Date.now()-this.compositionEndedAt<500)&&(this.compositionEndedAt=0,!0))}screenKeyEvent(e,t){let i=9==t.keyCode&&Date.now()<this.lastEscPress+2e3;return 27==t.keyCode?this.lastEscPress=Date.now():modifierCodes.indexOf(t.keyCode)<0&&(this.lastEscPress=0),i}mustFlushObserver(e){return"keydown"==e.type&&229!=e.keyCode||"compositionend"==e.type&&!browser.ios}startMouseSelection(e){this.mouseSelection&&this.mouseSelection.destroy(),this.mouseSelection=e}update(e){this.mouseSelection&&this.mouseSelection.update(e),e.transactions.length&&(this.lastKeyCode=this.lastSelectionTime=0)}destroy(){this.mouseSelection&&this.mouseSelection.destroy()}}const PendingKeys=[{key:"Backspace",keyCode:8,inputType:"deleteContentBackward"},{key:"Enter",keyCode:13,inputType:"insertParagraph"},{key:"Delete",keyCode:46,inputType:"deleteContentForward"}],modifierCodes=[16,17,18,20,91,92,224,225];class MouseSelection{constructor(e,t,i,o){this.view=e,this.style=i,this.mustSelect=o,this.lastEvent=t;let s=e.contentDOM.ownerDocument;s.addEventListener("mousemove",this.move=this.move.bind(this)),s.addEventListener("mouseup",this.up=this.up.bind(this)),this.extend=t.shiftKey,this.multiple=e.state.facet(EditorState.allowMultipleSelections)&&addsSelectionRange(e,t),this.dragMove=dragMovesSelection(e,t),this.dragging=!(!isInPrimarySelection(e,t)||1!=getClickType(t))&&null,!1===this.dragging&&(t.preventDefault(),this.select(t))}move(e){if(0==e.buttons)return this.destroy();!1===this.dragging&&this.select(this.lastEvent=e)}up(e){null==this.dragging&&this.select(this.lastEvent),this.dragging||e.preventDefault(),this.destroy()}destroy(){let e=this.view.contentDOM.ownerDocument;e.removeEventListener("mousemove",this.move),e.removeEventListener("mouseup",this.up),this.view.inputState.mouseSelection=null}select(e){let t=this.style.get(e,this.extend,this.multiple);!this.mustSelect&&t.eq(this.view.state.selection)&&t.main.assoc==this.view.state.selection.main.assoc||this.view.dispatch({selection:t,userEvent:"select.pointer",scrollIntoView:!0}),this.mustSelect=!1}update(e){e.docChanged&&this.dragging&&(this.dragging=this.dragging.map(e.changes)),this.style.update(e)&&setTimeout(()=>this.select(this.lastEvent),20)}}function addsSelectionRange(e,t){let i=e.state.facet(clickAddsSelectionRange);return i.length?i[0](t):browser.mac?t.metaKey:t.ctrlKey}function dragMovesSelection(e,t){let i=e.state.facet(dragMovesSelection$1);return i.length?i[0](t):browser.mac?!t.altKey:!t.ctrlKey}function isInPrimarySelection(e,t){let{main:i}=e.state.selection;if(i.empty)return!1;let o=getSelection(e.root);if(0==o.rangeCount)return!0;let s=o.getRangeAt(0).getClientRects();for(let e=0;e<s.length;e++){let i=s[e];if(i.left<=t.clientX&&i.right>=t.clientX&&i.top<=t.clientY&&i.bottom>=t.clientY)return!0}return!1}function eventBelongsToEditor(e,t){if(!t.bubbles)return!0;if(t.defaultPrevented)return!1;for(let i,o=t.target;o!=e.contentDOM;o=o.parentNode)if(!o||11==o.nodeType||(i=ContentView.get(o))&&i.ignoreEvent(t))return!1;return!0}const handlers=Object.create(null),brokenClipboardAPI=browser.ie&&browser.ie_version<15||browser.ios&&browser.webkit_version<604;function capturePaste(e){let t=e.dom.parentNode;if(!t)return;let i=t.appendChild(document.createElement("textarea"));i.style.cssText="position: fixed; left: -10000px; top: 10px",i.focus(),setTimeout(()=>{e.focus(),i.remove(),doPaste(e,i.value)},50)}function doPaste(e,t){let i,{state:o}=e,s=1,n=o.toText(t),r=n.lines==o.selection.ranges.length;if(null!=lastLinewiseCopy&&o.selection.ranges.every(e=>e.empty)&&lastLinewiseCopy==n.toString()){let e=-1;i=o.changeByRange(i=>{let l=o.doc.lineAt(i.from);if(l.from==e)return{range:i};e=l.from;let a=o.toText((r?n.line(s++).text:t)+o.lineBreak);return{changes:{from:l.from,insert:a},range:EditorSelection.cursor(i.from+a.length)}})}else i=r?o.changeByRange(e=>{let t=n.line(s++);return{changes:{from:e.from,to:e.to,insert:t.text},range:EditorSelection.cursor(e.from+t.length)}}):o.replaceSelection(n);e.dispatch(i,{userEvent:"input.paste",scrollIntoView:!0})}handlers.keydown=(e,t)=>{e.inputState.setSelectionOrigin("select")};let lastTouch=0;function rangeForClick(e,t,i,o){if(1==o)return EditorSelection.cursor(t,i);if(2==o)return groupAt(e.state,t,i);{let i=LineView.find(e.docView,t),o=e.state.doc.lineAt(i?i.posAtEnd:t),s=i?i.posAtStart:o.from,n=i?i.posAtEnd:o.to;return n<e.state.doc.length&&n==o.to&&n++,EditorSelection.range(s,n)}}handlers.touchstart=(e,t)=>{lastTouch=Date.now(),e.inputState.setSelectionOrigin("select.pointer")},handlers.touchmove=e=>{e.inputState.setSelectionOrigin("select.pointer")},handlers.mousedown=(e,t)=>{if(e.observer.flush(),lastTouch>Date.now()-2e3&&1==getClickType(t))return;let i=null;for(let o of e.state.facet(mouseSelectionStyle))if(i=o(e,t),i)break;if(i||0!=t.button||(i=basicMouseSelection(e,t)),i){let o=e.root.activeElement!=e.contentDOM;o&&e.observer.ignore(()=>focusPreventScroll(e.contentDOM)),e.inputState.startMouseSelection(new MouseSelection(e,t,i,o))}};let insideY=(e,t)=>e>=t.top&&e<=t.bottom,inside=(e,t,i)=>insideY(t,i)&&e>=i.left&&e<=i.right;function findPositionSide(e,t,i,o){let s=LineView.find(e.docView,t);if(!s)return 1;let n=t-s.posAtStart;if(0==n)return 1;if(n==s.length)return-1;let r=s.coordsAt(n,-1);if(r&&inside(i,o,r))return-1;let l=s.coordsAt(n,1);return l&&inside(i,o,l)?1:r&&insideY(o,r)?-1:1}function queryPos(e,t){let i=e.posAtCoords({x:t.clientX,y:t.clientY},!1);return{pos:i,bias:findPositionSide(e,i,t.clientX,t.clientY)}}const BadMouseDetail=browser.ie&&browser.ie_version<=11;let lastMouseDown=null,lastMouseDownCount=0,lastMouseDownTime=0;function getClickType(e){if(!BadMouseDetail)return e.detail;let t=lastMouseDown,i=lastMouseDownTime;return lastMouseDown=e,lastMouseDownTime=Date.now(),lastMouseDownCount=!t||i>Date.now()-400&&Math.abs(t.clientX-e.clientX)<2&&Math.abs(t.clientY-e.clientY)<2?(lastMouseDownCount+1)%3:1}function basicMouseSelection(e,t){let i=queryPos(e,t),o=getClickType(t),s=e.state.selection,n=i,r=t;return{update(e){e.docChanged&&(i&&(i.pos=e.changes.mapPos(i.pos)),s=s.map(e.changes),r=null)},get(t,l,a){let h;if(r&&t.clientX==r.clientX&&t.clientY==r.clientY?h=n:(h=n=queryPos(e,t),r=t),!h||!i)return s;let c=rangeForClick(e,h.pos,h.bias,o);if(i.pos!=h.pos&&!l){let t=rangeForClick(e,i.pos,i.bias,o),s=Math.min(t.from,c.from),n=Math.max(t.to,c.to);c=s<c.from?EditorSelection.range(s,n):EditorSelection.range(n,s)}return l?s.replaceRange(s.main.extend(c.from,c.to)):a?s.addRange(c):EditorSelection.create([c])}}}function dropText(e,t,i,o){if(!i)return;let s=e.posAtCoords({x:t.clientX,y:t.clientY},!1);t.preventDefault();let{mouseSelection:n}=e.inputState,r=o&&n&&n.dragging&&n.dragMove?{from:n.dragging.from,to:n.dragging.to}:null,l={from:s,insert:i},a=e.state.changes(r?[r,l]:l);e.focus(),e.dispatch({changes:a,selection:{anchor:a.mapPos(s,-1),head:a.mapPos(s,1)},userEvent:r?"move.drop":"input.drop"})}function captureCopy(e,t){let i=e.dom.parentNode;if(!i)return;let o=i.appendChild(document.createElement("textarea"));o.style.cssText="position: fixed; left: -10000px; top: 10px",o.value=t,o.focus(),o.selectionEnd=t.length,o.selectionStart=0,setTimeout(()=>{o.remove(),e.focus()},50)}function copiedRange(e){let t=[],i=[],o=!1;for(let o of e.selection.ranges)o.empty||(t.push(e.sliceDoc(o.from,o.to)),i.push(o));if(!t.length){let s=-1;for(let{from:o}of e.selection.ranges){let n=e.doc.lineAt(o);n.number>s&&(t.push(n.text),i.push({from:n.from,to:Math.min(e.doc.length,n.to+1)})),s=n.number}o=!0}return{text:t.join(e.lineBreak),ranges:i,linewise:o}}handlers.dragstart=(e,t)=>{let{selection:{main:i}}=e.state,{mouseSelection:o}=e.inputState;o&&(o.dragging=i),t.dataTransfer&&(t.dataTransfer.setData("Text",e.state.sliceDoc(i.from,i.to)),t.dataTransfer.effectAllowed="copyMove")},handlers.drop=(e,t)=>{if(!t.dataTransfer)return;if(e.state.readOnly)return t.preventDefault();let i=t.dataTransfer.files;if(i&&i.length){t.preventDefault();let o=Array(i.length),s=0,n=()=>{++s==i.length&&dropText(e,t,o.filter(e=>null!=e).join(e.state.lineBreak),!1)};for(let e=0;e<i.length;e++){let t=new FileReader;t.onerror=n,t.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(t.result)||(o[e]=t.result),n()},t.readAsText(i[e])}}else dropText(e,t,t.dataTransfer.getData("Text"),!0)},handlers.paste=(e,t)=>{if(e.state.readOnly)return t.preventDefault();e.observer.flush();let i=brokenClipboardAPI?null:t.clipboardData;i?(doPaste(e,i.getData("text/plain")),t.preventDefault()):capturePaste(e)};let lastLinewiseCopy=null;function forceClearComposition(e,t){if(e.docView.compositionDeco.size){e.inputState.rapidCompositionStart=t;try{e.update([])}finally{e.inputState.rapidCompositionStart=!1}}}handlers.copy=handlers.cut=(e,t)=>{let{text:i,ranges:o,linewise:s}=copiedRange(e.state);if(!i&&!s)return;lastLinewiseCopy=s?i:null;let n=brokenClipboardAPI?null:t.clipboardData;n?(t.preventDefault(),n.clearData(),n.setData("text/plain",i)):captureCopy(e,i),"cut"!=t.type||e.state.readOnly||e.dispatch({changes:o,scrollIntoView:!0,userEvent:"delete.cut"})},handlers.focus=handlers.blur=e=>{setTimeout(()=>{e.hasFocus!=e.inputState.notifiedFocused&&e.update([])},10)},handlers.beforeprint=e=>{e.viewState.printing=!0,e.requestMeasure(),setTimeout(()=>{e.viewState.printing=!1,e.requestMeasure()},2e3)},handlers.compositionstart=handlers.compositionupdate=e=>{null==e.inputState.compositionFirstChange&&(e.inputState.compositionFirstChange=!0),e.inputState.composing<0&&(e.inputState.composing=0,e.docView.compositionDeco.size&&(e.observer.flush(),forceClearComposition(e,!0)))},handlers.compositionend=e=>{e.inputState.composing=-1,e.inputState.compositionEndedAt=Date.now(),e.inputState.compositionFirstChange=null,setTimeout(()=>{e.inputState.composing<0&&forceClearComposition(e,!1)},50)},handlers.contextmenu=e=>{e.inputState.lastContextMenu=Date.now()},handlers.beforeinput=(e,t)=>{var i;let o;if(browser.chrome&&browser.android&&(o=PendingKeys.find(e=>e.inputType==t.inputType))&&(e.observer.delayAndroidKey(o.key,o.keyCode),"Backspace"==o.key||"Delete"==o.key)){let t=(null===(i=window.visualViewport)||void 0===i?void 0:i.height)||0;setTimeout(()=>{var i;((null===(i=window.visualViewport)||void 0===i?void 0:i.height)||0)>t+10&&e.hasFocus&&(e.contentDOM.blur(),e.focus())},100)}};const wrappingWhiteSpace=["pre-wrap","normal","pre-line","break-spaces"];class HeightOracle{constructor(){this.doc=Text.empty,this.lineWrapping=!1,this.direction=Direction.LTR,this.heightSamples={},this.lineHeight=14,this.charWidth=7,this.lineLength=30,this.heightChanged=!1}heightForGap(e,t){let i=this.doc.lineAt(t).number-this.doc.lineAt(e).number+1;return this.lineWrapping&&(i+=Math.ceil((t-e-i*this.lineLength*.5)/this.lineLength)),this.lineHeight*i}heightForLine(e){if(!this.lineWrapping)return this.lineHeight;return(1+Math.max(0,Math.ceil((e-this.lineLength)/(this.lineLength-5))))*this.lineHeight}setDoc(e){return this.doc=e,this}mustRefreshForStyle(e,t){return wrappingWhiteSpace.indexOf(e)>-1!=this.lineWrapping||this.direction!=t}mustRefreshForHeights(e){let t=!1;for(let i=0;i<e.length;i++){let o=e[i];o<0?i++:this.heightSamples[Math.floor(10*o)]||(t=!0,this.heightSamples[Math.floor(10*o)]=!0)}return t}refresh(e,t,i,o,s,n){let r=wrappingWhiteSpace.indexOf(e)>-1,l=Math.round(i)!=Math.round(this.lineHeight)||this.lineWrapping!=r||this.direction!=t;if(this.lineWrapping=r,this.direction=t,this.lineHeight=i,this.charWidth=o,this.lineLength=s,l){this.heightSamples={};for(let e=0;e<n.length;e++){let t=n[e];t<0?e++:this.heightSamples[Math.floor(10*t)]=!0}}return l}}class MeasuredHeights{constructor(e,t){this.from=e,this.heights=t,this.index=0}get more(){return this.index<this.heights.length}}class BlockInfo{constructor(e,t,i,o,s){this.from=e,this.length=t,this.top=i,this.height=o,this.type=s}get to(){return this.from+this.length}get bottom(){return this.top+this.height}join(e){let t=(Array.isArray(this.type)?this.type:[this]).concat(Array.isArray(e.type)?e.type:[e]);return new BlockInfo(this.from,this.length+e.length,this.top,this.height+e.height,t)}moveY(e){return e?new BlockInfo(this.from,this.length,this.top+e,this.height,Array.isArray(this.type)?this.type.map(t=>t.moveY(e)):this.type):this}}var QueryType=function(e){return e[e.ByPos=0]="ByPos",e[e.ByHeight=1]="ByHeight",e[e.ByPosNoHeight=2]="ByPosNoHeight",e}(QueryType||(QueryType={}));const Epsilon=.001;class HeightMap{constructor(e,t,i=2){this.length=e,this.height=t,this.flags=i}get outdated(){return(2&this.flags)>0}set outdated(e){this.flags=(e?2:0)|-3&this.flags}setHeight(e,t){this.height!=t&&(Math.abs(this.height-t)>.001&&(e.heightChanged=!0),this.height=t)}replace(e,t,i){return HeightMap.of(i)}decomposeLeft(e,t){t.push(this)}decomposeRight(e,t){t.push(this)}applyChanges(e,t,i,o){let s=this;for(let n=o.length-1;n>=0;n--){let{fromA:r,toA:l,fromB:a,toB:h}=o[n],c=s.lineAt(r,QueryType.ByPosNoHeight,t,0,0),d=c.to>=l?c:s.lineAt(l,QueryType.ByPosNoHeight,t,0,0);for(h+=d.to-l,l=d.to;n>0&&c.from<=o[n-1].toA;)r=o[n-1].fromA,a=o[n-1].fromB,n--,r<c.from&&(c=s.lineAt(r,QueryType.ByPosNoHeight,t,0,0));a+=c.from-r,r=c.from;let u=NodeBuilder.build(i,e,a,h);s=s.replace(r,l,u)}return s.updateHeight(i,0)}static empty(){return new HeightMapText(0,0)}static of(e){if(1==e.length)return e[0];let t=0,i=e.length,o=0,s=0;for(;;)if(t==i)if(o>2*s){let s=e[t-1];s.break?e.splice(--t,1,s.left,null,s.right):e.splice(--t,1,s.left,s.right),i+=1+s.break,o-=s.size}else{if(!(s>2*o))break;{let t=e[i];t.break?e.splice(i,1,t.left,null,t.right):e.splice(i,1,t.left,t.right),i+=2+t.break,s-=t.size}}else if(o<s){let i=e[t++];i&&(o+=i.size)}else{let t=e[--i];t&&(s+=t.size)}let n=0;return null==e[t-1]?(n=1,t--):null==e[t]&&(n=1,i++),new HeightMapBranch(HeightMap.of(e.slice(0,t)),n,HeightMap.of(e.slice(i)))}}HeightMap.prototype.size=1;class HeightMapBlock extends HeightMap{constructor(e,t,i){super(e,t),this.type=i}blockAt(e,t,i,o){return new BlockInfo(o,this.length,i,this.height,this.type)}lineAt(e,t,i,o,s){return this.blockAt(0,i,o,s)}forEachLine(e,t,i,o,s,n){n(this.blockAt(0,i,o,s))}updateHeight(e,t=0,i=!1,o){return o&&o.from<=t&&o.more&&this.setHeight(e,o.heights[o.index++]),this.outdated=!1,this}toString(){return`block(${this.length})`}}class HeightMapText extends HeightMapBlock{constructor(e,t){super(e,t,BlockType.Text),this.collapsed=0,this.widgetHeight=0}replace(e,t,i){let o=i[0];return 1==i.length&&(o instanceof HeightMapText||o instanceof HeightMapGap&&4&o.flags)&&Math.abs(this.length-o.length)<10?(o instanceof HeightMapGap?o=new HeightMapText(o.length,this.height):o.height=this.height,this.outdated||(o.outdated=!1),o):HeightMap.of(i)}updateHeight(e,t=0,i=!1,o){return o&&o.from<=t&&o.more?this.setHeight(e,o.heights[o.index++]):(i||this.outdated)&&this.setHeight(e,Math.max(this.widgetHeight,e.heightForLine(this.length-this.collapsed))),this.outdated=!1,this}toString(){return`line(${this.length}${this.collapsed?-this.collapsed:""}${this.widgetHeight?":"+this.widgetHeight:""})`}}class HeightMapGap extends HeightMap{constructor(e){super(e,0)}lines(e,t){let i=e.lineAt(t).number,o=e.lineAt(t+this.length).number;return{firstLine:i,lastLine:o,lineHeight:this.height/(o-i+1)}}blockAt(e,t,i,o){let{firstLine:s,lastLine:n,lineHeight:r}=this.lines(t,o),l=Math.max(0,Math.min(n-s,Math.floor((e-i)/r))),{from:a,length:h}=t.line(s+l);return new BlockInfo(a,h,i+r*l,r,BlockType.Text)}lineAt(e,t,i,o,s){if(t==QueryType.ByHeight)return this.blockAt(e,i,o,s);if(t==QueryType.ByPosNoHeight){let{from:t,to:o}=i.lineAt(e);return new BlockInfo(t,o-t,0,0,BlockType.Text)}let{firstLine:n,lineHeight:r}=this.lines(i,s),{from:l,length:a,number:h}=i.lineAt(e);return new BlockInfo(l,a,o+r*(h-n),r,BlockType.Text)}forEachLine(e,t,i,o,s,n){let{firstLine:r,lineHeight:l}=this.lines(i,s);for(let a=Math.max(e,s),h=Math.min(s+this.length,t);a<=h;){let t=i.lineAt(a);a==e&&(o+=l*(t.number-r)),n(new BlockInfo(t.from,t.length,o,l,BlockType.Text)),o+=l,a=t.to+1}}replace(e,t,i){let o=this.length-t;if(o>0){let e=i[i.length-1];e instanceof HeightMapGap?i[i.length-1]=new HeightMapGap(e.length+o):i.push(null,new HeightMapGap(o-1))}if(e>0){let t=i[0];t instanceof HeightMapGap?i[0]=new HeightMapGap(e+t.length):i.unshift(new HeightMapGap(e-1),null)}return HeightMap.of(i)}decomposeLeft(e,t){t.push(new HeightMapGap(e-1),null)}decomposeRight(e,t){t.push(null,new HeightMapGap(this.length-e-1))}updateHeight(e,t=0,i=!1,o){let s=t+this.length;if(o&&o.from<=t+this.length&&o.more){let i=[],n=Math.max(t,o.from),r=-1,l=e.heightChanged;for(o.from>t&&i.push(new HeightMapGap(o.from-t-1).updateHeight(e,t));n<=s&&o.more;){let t=e.doc.lineAt(n).length;i.length&&i.push(null);let s=o.heights[o.index++];-1==r?r=s:Math.abs(s-r)>=.001&&(r=-2);let l=new HeightMapText(t,s);l.outdated=!1,i.push(l),n+=t+1}n<=s&&i.push(null,new HeightMapGap(s-n).updateHeight(e,n));let a=HeightMap.of(i);return e.heightChanged=l||r<0||Math.abs(a.height-this.height)>=.001||Math.abs(r-this.lines(e.doc,t).lineHeight)>=.001,a}return(i||this.outdated)&&(this.setHeight(e,e.heightForGap(t,t+this.length)),this.outdated=!1),this}toString(){return`gap(${this.length})`}}class HeightMapBranch extends HeightMap{constructor(e,t,i){super(e.length+t+i.length,e.height+i.height,t|(e.outdated||i.outdated?2:0)),this.left=e,this.right=i,this.size=e.size+i.size}get break(){return 1&this.flags}blockAt(e,t,i,o){let s=i+this.left.height;return e<s?this.left.blockAt(e,t,i,o):this.right.blockAt(e,t,s,o+this.left.length+this.break)}lineAt(e,t,i,o,s){let n=o+this.left.height,r=s+this.left.length+this.break,l=t==QueryType.ByHeight?e<n:e<r,a=l?this.left.lineAt(e,t,i,o,s):this.right.lineAt(e,t,i,n,r);if(this.break||(l?a.to<r:a.from>r))return a;let h=t==QueryType.ByPosNoHeight?QueryType.ByPosNoHeight:QueryType.ByPos;return l?a.join(this.right.lineAt(r,h,i,n,r)):this.left.lineAt(r,h,i,o,s).join(a)}forEachLine(e,t,i,o,s,n){let r=o+this.left.height,l=s+this.left.length+this.break;if(this.break)e<l&&this.left.forEachLine(e,t,i,o,s,n),t>=l&&this.right.forEachLine(e,t,i,r,l,n);else{let a=this.lineAt(l,QueryType.ByPos,i,o,s);e<a.from&&this.left.forEachLine(e,a.from-1,i,o,s,n),a.to>=e&&a.from<=t&&n(a),t>a.to&&this.right.forEachLine(a.to+1,t,i,r,l,n)}}replace(e,t,i){let o=this.left.length+this.break;if(t<o)return this.balanced(this.left.replace(e,t,i),this.right);if(e>this.left.length)return this.balanced(this.left,this.right.replace(e-o,t-o,i));let s=[];e>0&&this.decomposeLeft(e,s);let n=s.length;for(let e of i)s.push(e);if(e>0&&mergeGaps(s,n-1),t<this.length){let e=s.length;this.decomposeRight(t,s),mergeGaps(s,e)}return HeightMap.of(s)}decomposeLeft(e,t){let i=this.left.length;if(e<=i)return this.left.decomposeLeft(e,t);t.push(this.left),this.break&&(i++,e>=i&&t.push(null)),e>i&&this.right.decomposeLeft(e-i,t)}decomposeRight(e,t){let i=this.left.length,o=i+this.break;if(e>=o)return this.right.decomposeRight(e-o,t);e<i&&this.left.decomposeRight(e,t),this.break&&e<o&&t.push(null),t.push(this.right)}balanced(e,t){return e.size>2*t.size||t.size>2*e.size?HeightMap.of(this.break?[e,null,t]:[e,t]):(this.left=e,this.right=t,this.height=e.height+t.height,this.outdated=e.outdated||t.outdated,this.size=e.size+t.size,this.length=e.length+this.break+t.length,this)}updateHeight(e,t=0,i=!1,o){let{left:s,right:n}=this,r=t+s.length+this.break,l=null;return o&&o.from<=t+s.length&&o.more?l=s=s.updateHeight(e,t,i,o):s.updateHeight(e,t,i),o&&o.from<=r+n.length&&o.more?l=n=n.updateHeight(e,r,i,o):n.updateHeight(e,r,i),l?this.balanced(s,n):(this.height=this.left.height+this.right.height,this.outdated=!1,this)}toString(){return this.left+(this.break?" ":"-")+this.right}}function mergeGaps(e,t){let i,o;null==e[t]&&(i=e[t-1])instanceof HeightMapGap&&(o=e[t+1])instanceof HeightMapGap&&e.splice(t-1,3,new HeightMapGap(i.length+1+o.length))}const relevantWidgetHeight=5;class NodeBuilder{constructor(e,t){this.pos=e,this.oracle=t,this.nodes=[],this.lineStart=-1,this.lineEnd=-1,this.covering=null,this.writtenTo=e}get isCovered(){return this.covering&&this.nodes[this.nodes.length-1]==this.covering}span(e,t){if(this.lineStart>-1){let e=Math.min(t,this.lineEnd),i=this.nodes[this.nodes.length-1];i instanceof HeightMapText?i.length+=e-this.pos:(e>this.pos||!this.isCovered)&&this.nodes.push(new HeightMapText(e-this.pos,-1)),this.writtenTo=e,t>e&&(this.nodes.push(null),this.writtenTo++,this.lineStart=-1)}this.pos=t}point(e,t,i){if(e<t||i.heightRelevant){let o=i.widget?i.widget.estimatedHeight:0;o<0&&(o=this.oracle.lineHeight);let s=t-e;i.block?this.addBlock(new HeightMapBlock(s,o,i.type)):(s||o>=5)&&this.addLineDeco(o,s)}else t>e&&this.span(e,t);this.lineEnd>-1&&this.lineEnd<this.pos&&(this.lineEnd=this.oracle.doc.lineAt(this.pos).to)}enterLine(){if(this.lineStart>-1)return;let{from:e,to:t}=this.oracle.doc.lineAt(this.pos);this.lineStart=e,this.lineEnd=t,this.writtenTo<e&&((this.writtenTo<e-1||null==this.nodes[this.nodes.length-1])&&this.nodes.push(this.blankContent(this.writtenTo,e-1)),this.nodes.push(null)),this.pos>e&&this.nodes.push(new HeightMapText(this.pos-e,-1)),this.writtenTo=this.pos}blankContent(e,t){let i=new HeightMapGap(t-e);return this.oracle.doc.lineAt(e).to==t&&(i.flags|=4),i}ensureLine(){this.enterLine();let e=this.nodes.length?this.nodes[this.nodes.length-1]:null;if(e instanceof HeightMapText)return e;let t=new HeightMapText(0,-1);return this.nodes.push(t),t}addBlock(e){this.enterLine(),e.type!=BlockType.WidgetAfter||this.isCovered||this.ensureLine(),this.nodes.push(e),this.writtenTo=this.pos=this.pos+e.length,e.type!=BlockType.WidgetBefore&&(this.covering=e)}addLineDeco(e,t){let i=this.ensureLine();i.length+=t,i.collapsed+=t,i.widgetHeight=Math.max(i.widgetHeight,e),this.writtenTo=this.pos=this.pos+t}finish(e){let t=0==this.nodes.length?null:this.nodes[this.nodes.length-1];!(this.lineStart>-1)||t instanceof HeightMapText||this.isCovered?(this.writtenTo<this.pos||null==t)&&this.nodes.push(this.blankContent(this.writtenTo,this.pos)):this.nodes.push(new HeightMapText(0,-1));let i=e;for(let e of this.nodes)e instanceof HeightMapText&&e.updateHeight(this.oracle,i),i+=e?e.length:1;return this.nodes}static build(e,t,i,o){let s=new NodeBuilder(i,e);return RangeSet.spans(t,i,o,s,0),s.finish(i)}}function heightRelevantDecoChanges(e,t,i){let o=new DecorationComparator;return RangeSet.compare(e,t,i,o,0),o.changes}class DecorationComparator{constructor(){this.changes=[]}compareRange(){}comparePoint(e,t,i,o){(e<t||i&&i.heightRelevant||o&&o.heightRelevant)&&addRange(e,t,this.changes,5)}}function visiblePixelRange(e,t){let i=e.getBoundingClientRect(),o=Math.max(0,i.left),s=Math.min(innerWidth,i.right),n=Math.max(0,i.top),r=Math.min(innerHeight,i.bottom),l=e.ownerDocument.body;for(let t=e.parentNode;t&&t!=l;)if(1==t.nodeType){let e=t,i=window.getComputedStyle(e);if((e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth)&&"visible"!=i.overflow){let t=e.getBoundingClientRect();o=Math.max(o,t.left),s=Math.min(s,t.right),n=Math.max(n,t.top),r=Math.min(r,t.bottom)}t="absolute"==i.position||"fixed"==i.position?e.offsetParent:e.parentNode}else{if(11!=t.nodeType)break;t=t.host}return{left:o-i.left,right:Math.max(o,s)-i.left,top:n-(i.top+t),bottom:Math.max(n,r)-(i.top+t)}}class LineGap{constructor(e,t,i){this.from=e,this.to=t,this.size=i}static same(e,t){if(e.length!=t.length)return!1;for(let i=0;i<e.length;i++){let o=e[i],s=t[i];if(o.from!=s.from||o.to!=s.to||o.size!=s.size)return!1}return!0}draw(e){return Decoration.replace({widget:new LineGapWidget(this.size,e)}).range(this.from,this.to)}}class LineGapWidget extends WidgetType{constructor(e,t){super(),this.size=e,this.vertical=t}eq(e){return e.size==this.size&&e.vertical==this.vertical}toDOM(){let e=document.createElement("div");return this.vertical?e.style.height=this.size+"px":(e.style.width=this.size+"px",e.style.height="2px",e.style.display="inline-block"),e}get estimatedHeight(){return this.vertical?this.size:-1}}class ViewState{constructor(e){this.state=e,this.pixelViewport={left:0,right:window.innerWidth,top:0,bottom:0},this.inView=!0,this.paddingTop=0,this.paddingBottom=0,this.contentDOMWidth=0,this.contentDOMHeight=0,this.editorHeight=0,this.editorWidth=0,this.heightOracle=new HeightOracle,this.scaler=IdScaler,this.scrollTarget=null,this.printing=!1,this.mustMeasureContent=!0,this.visibleRanges=[],this.mustEnforceCursorAssoc=!1,this.heightMap=HeightMap.empty().applyChanges(e.facet(decorations),Text.empty,this.heightOracle.setDoc(e.doc),[new ChangedRange(0,0,0,e.doc.length)]),this.viewport=this.getViewport(0,null),this.updateViewportLines(),this.updateForViewport(),this.lineGaps=this.ensureLineGaps([]),this.lineGapDeco=Decoration.set(this.lineGaps.map(e=>e.draw(!1))),this.computeVisibleRanges()}updateForViewport(){let e=[this.viewport],{main:t}=this.state.selection;for(let i=0;i<=1;i++){let o=i?t.head:t.anchor;if(!e.some(({from:e,to:t})=>o>=e&&o<=t)){let{from:t,to:i}=this.lineBlockAt(o);e.push(new Viewport(t,i))}}this.viewports=e.sort((e,t)=>e.from-t.from),this.scaler=this.heightMap.height<=7e6?IdScaler:new BigScaler(this.heightOracle.doc,this.heightMap,this.viewports)}updateViewportLines(){this.viewportLines=[],this.heightMap.forEachLine(this.viewport.from,this.viewport.to,this.state.doc,0,0,e=>{this.viewportLines.push(1==this.scaler.scale?e:scaleBlock(e,this.scaler))})}update(e,t=null){let i=this.state;this.state=e.state;let o=this.state.facet(decorations),s=e.changedRanges,n=ChangedRange.extendWithRanges(s,heightRelevantDecoChanges(e.startState.facet(decorations),o,e?e.changes:ChangeSet.empty(this.state.doc.length))),r=this.heightMap.height;this.heightMap=this.heightMap.applyChanges(o,i.doc,this.heightOracle.setDoc(this.state.doc),n),this.heightMap.height!=r&&(e.flags|=2);let l=n.length?this.mapViewport(this.viewport,e.changes):this.viewport;(t&&(t.range.head<l.from||t.range.head>l.to)||!this.viewportIsAppropriate(l))&&(l=this.getViewport(0,t));let a=!e.changes.empty||2&e.flags||l.from!=this.viewport.from||l.to!=this.viewport.to;this.viewport=l,this.updateForViewport(),a&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(this.mapLineGaps(this.lineGaps,e.changes))),e.flags|=this.computeVisibleRanges(),t&&(this.scrollTarget=t),!this.mustEnforceCursorAssoc&&e.selectionSet&&e.view.lineWrapping&&e.state.selection.main.empty&&e.state.selection.main.assoc&&(this.mustEnforceCursorAssoc=!0)}measure(e){let t=e.contentDOM,i=window.getComputedStyle(t),o=this.heightOracle,s=i.whiteSpace,n="rtl"==i.direction?Direction.RTL:Direction.LTR,r=this.heightOracle.mustRefreshForStyle(s,n),l=r||this.mustMeasureContent||this.contentDOMHeight!=t.clientHeight,a=0,h=0;if(l){this.mustMeasureContent=!1,this.contentDOMHeight=t.clientHeight;let e=parseInt(i.paddingTop)||0,o=parseInt(i.paddingBottom)||0;this.paddingTop==e&&this.paddingBottom==o||(a|=8,this.paddingTop=e,this.paddingBottom=o)}let c=this.printing?{top:-1e8,bottom:1e8,left:-1e8,right:1e8}:visiblePixelRange(t,this.paddingTop),d=c.top-this.pixelViewport.top,u=c.bottom-this.pixelViewport.bottom;this.pixelViewport=c;let p=this.pixelViewport.bottom>this.pixelViewport.top&&this.pixelViewport.right>this.pixelViewport.left;if(p!=this.inView&&(this.inView=p,p&&(l=!0)),!this.inView)return 0;let f=t.clientWidth;if(this.contentDOMWidth==f&&this.editorHeight==e.scrollDOM.clientHeight&&this.editorWidth==e.scrollDOM.clientWidth||(this.contentDOMWidth=f,this.editorHeight=e.scrollDOM.clientHeight,this.editorWidth=e.scrollDOM.clientWidth,a|=8),l){let t=e.docView.measureVisibleLineHeights();if(o.mustRefreshForHeights(t)&&(r=!0),r||o.lineWrapping&&Math.abs(f-this.contentDOMWidth)>o.charWidth){let{lineHeight:i,charWidth:l}=e.docView.measureTextSize();r=o.refresh(s,n,i,l,f/l,t),r&&(e.docView.minWidth=0,a|=8)}d>0&&u>0?h=Math.max(d,u):d<0&&u<0&&(h=Math.min(d,u)),o.heightChanged=!1,this.heightMap=this.heightMap.updateHeight(o,0,r,new MeasuredHeights(this.viewport.from,t)),o.heightChanged&&(a|=2)}let g=!this.viewportIsAppropriate(this.viewport,h)||this.scrollTarget&&(this.scrollTarget.range.head<this.viewport.from||this.scrollTarget.range.head>this.viewport.to);return g&&(this.viewport=this.getViewport(h,this.scrollTarget)),this.updateForViewport(),(2&a||g)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(r?[]:this.lineGaps)),a|=this.computeVisibleRanges(),this.mustEnforceCursorAssoc&&(this.mustEnforceCursorAssoc=!1,e.docView.enforceCursorAssoc()),a}get visibleTop(){return this.scaler.fromDOM(this.pixelViewport.top)}get visibleBottom(){return this.scaler.fromDOM(this.pixelViewport.bottom)}getViewport(e,t){let i=.5-Math.max(-.5,Math.min(.5,e/1e3/2)),o=this.heightMap,s=this.state.doc,{visibleTop:n,visibleBottom:r}=this,l=new Viewport(o.lineAt(n-1e3*i,QueryType.ByHeight,s,0,0).from,o.lineAt(r+1e3*(1-i),QueryType.ByHeight,s,0,0).to);if(t){let{head:e}=t.range,i=this.editorHeight;if(e<l.from||e>l.to){let n,r=o.lineAt(e,QueryType.ByPos,s,0,0);n="center"==t.y?(r.top+r.bottom)/2-i/2:"start"==t.y||"nearest"==t.y&&e<l.from?r.top:r.bottom-i,l=new Viewport(o.lineAt(n-500,QueryType.ByHeight,s,0,0).from,o.lineAt(n+i+500,QueryType.ByHeight,s,0,0).to)}}return l}mapViewport(e,t){let i=t.mapPos(e.from,-1),o=t.mapPos(e.to,1);return new Viewport(this.heightMap.lineAt(i,QueryType.ByPos,this.state.doc,0,0).from,this.heightMap.lineAt(o,QueryType.ByPos,this.state.doc,0,0).to)}viewportIsAppropriate({from:e,to:t},i=0){if(!this.inView)return!0;let{top:o}=this.heightMap.lineAt(e,QueryType.ByPos,this.state.doc,0,0),{bottom:s}=this.heightMap.lineAt(t,QueryType.ByPos,this.state.doc,0,0),{visibleTop:n,visibleBottom:r}=this;return(0==e||o<=n-Math.max(10,Math.min(-i,250)))&&(t==this.state.doc.length||s>=r+Math.max(10,Math.min(i,250)))&&o>n-2e3&&s<r+2e3}mapLineGaps(e,t){if(!e.length||t.empty)return e;let i=[];for(let o of e)t.touchesRange(o.from,o.to)||i.push(new LineGap(t.mapPos(o.from),t.mapPos(o.to),o.size));return i}ensureLineGaps(e){let t=[];if(this.heightOracle.direction!=Direction.LTR)return t;for(let i of this.viewportLines){if(i.length<4e3)continue;let o,s,n=lineStructure(i.from,i.to,this.state);if(n.total<4e3)continue;if(this.heightOracle.lineWrapping){let e=2e3/this.heightOracle.lineLength*this.heightOracle.lineHeight;o=findPosition(n,(this.visibleTop-i.top-e)/i.height),s=findPosition(n,(this.visibleBottom-i.top+e)/i.height)}else{let e=n.total*this.heightOracle.charWidth,t=2e3*this.heightOracle.charWidth;o=findPosition(n,(this.pixelViewport.left-t)/e),s=findPosition(n,(this.pixelViewport.right+t)/e)}let r=[];o>i.from&&r.push({from:i.from,to:o}),s<i.to&&r.push({from:s,to:i.to});let l=this.state.selection.main;l.from>=i.from&&l.from<=i.to&&cutRange(r,l.from-10,l.from+10),!l.empty&&l.to>=i.from&&l.to<=i.to&&cutRange(r,l.to-10,l.to+10);for(let{from:o,to:s}of r)s-o>1e3&&t.push(find(e,e=>e.from>=i.from&&e.to<=i.to&&Math.abs(e.from-o)<1e3&&Math.abs(e.to-s)<1e3)||new LineGap(o,s,this.gapSize(i,o,s,n)))}return t}gapSize(e,t,i,o){let s=findFraction(o,i)-findFraction(o,t);return this.heightOracle.lineWrapping?e.height*s:o.total*this.heightOracle.charWidth*s}updateLineGaps(e){LineGap.same(e,this.lineGaps)||(this.lineGaps=e,this.lineGapDeco=Decoration.set(e.map(e=>e.draw(this.heightOracle.lineWrapping))))}computeVisibleRanges(){let e=this.state.facet(decorations);this.lineGaps.length&&(e=e.concat(this.lineGapDeco));let t=[];RangeSet.spans(e,this.viewport.from,this.viewport.to,{span(e,i){t.push({from:e,to:i})},point(){}},20);let i=t.length!=this.visibleRanges.length||this.visibleRanges.some((e,i)=>e.from!=t[i].from||e.to!=t[i].to);return this.visibleRanges=t,i?4:0}lineBlockAt(e){return e>=this.viewport.from&&e<=this.viewport.to&&this.viewportLines.find(t=>t.from<=e&&t.to>=e)||scaleBlock(this.heightMap.lineAt(e,QueryType.ByPos,this.state.doc,0,0),this.scaler)}lineBlockAtHeight(e){return scaleBlock(this.heightMap.lineAt(this.scaler.fromDOM(e),QueryType.ByHeight,this.state.doc,0,0),this.scaler)}elementAtHeight(e){return scaleBlock(this.heightMap.blockAt(this.scaler.fromDOM(e),this.state.doc,0,0),this.scaler)}get docHeight(){return this.scaler.toDOM(this.heightMap.height)}get contentHeight(){return this.docHeight+this.paddingTop+this.paddingBottom}}class Viewport{constructor(e,t){this.from=e,this.to=t}}function lineStructure(e,t,i){let o=[],s=e,n=0;return RangeSet.spans(i.facet(decorations),e,t,{span(){},point(e,t){e>s&&(o.push({from:s,to:e}),n+=e-s),s=t}},20),s<t&&(o.push({from:s,to:t}),n+=t-s),{total:n,ranges:o}}function findPosition({total:e,ranges:t},i){if(i<=0)return t[0].from;if(i>=1)return t[t.length-1].to;let o=Math.floor(e*i);for(let e=0;;e++){let{from:i,to:s}=t[e],n=s-i;if(o<=n)return i+o;o-=n}}function findFraction(e,t){let i=0;for(let{from:o,to:s}of e.ranges){if(t<=s){i+=t-o;break}i+=s-o}return i/e.total}function cutRange(e,t,i){for(let o=0;o<e.length;o++){let s=e[o];if(s.from<i&&s.to>t){let n=[];s.from<t&&n.push({from:s.from,to:t}),s.to>i&&n.push({from:i,to:s.to}),e.splice(o,1,...n),o+=n.length-1}}}function find(e,t){for(let i of e)if(t(i))return i}const IdScaler={toDOM:e=>e,fromDOM:e=>e,scale:1};class BigScaler{constructor(e,t,i){let o=0,s=0,n=0;this.viewports=i.map(({from:i,to:s})=>{let n=t.lineAt(i,QueryType.ByPos,e,0,0).top,r=t.lineAt(s,QueryType.ByPos,e,0,0).bottom;return o+=r-n,{from:i,to:s,top:n,bottom:r,domTop:0,domBottom:0}}),this.scale=(7e6-o)/(t.height-o);for(let e of this.viewports)e.domTop=n+(e.top-s)*this.scale,n=e.domBottom=e.domTop+(e.bottom-e.top),s=e.bottom}toDOM(e){for(let t=0,i=0,o=0;;t++){let s=t<this.viewports.length?this.viewports[t]:null;if(!s||e<s.top)return o+(e-i)*this.scale;if(e<=s.bottom)return s.domTop+(e-s.top);i=s.bottom,o=s.domBottom}}fromDOM(e){for(let t=0,i=0,o=0;;t++){let s=t<this.viewports.length?this.viewports[t]:null;if(!s||e<s.domTop)return i+(e-o)/this.scale;if(e<=s.domBottom)return s.top+(e-s.domTop);i=s.bottom,o=s.domBottom}}}function scaleBlock(e,t){if(1==t.scale)return e;let i=t.toDOM(e.top),o=t.toDOM(e.bottom);return new BlockInfo(e.from,e.length,i,o-i,Array.isArray(e.type)?e.type.map(e=>scaleBlock(e,t)):e.type)}const theme=Facet.define({combine:e=>e.join(" ")}),darkTheme=Facet.define({combine:e=>e.indexOf(!0)>-1}),baseThemeID=StyleModule.newName(),baseLightID=StyleModule.newName(),baseDarkID=StyleModule.newName(),lightDarkIDs={"&light":"."+baseLightID,"&dark":"."+baseDarkID};function buildTheme(e,t,i){return new StyleModule(t,{finish:t=>/&/.test(t)?t.replace(/&\w*/,t=>{if("&"==t)return e;if(!i||!i[t])throw new RangeError("Unsupported selector: "+t);return i[t]}):e+" "+t})}const baseTheme=buildTheme("."+baseThemeID,{"&.cm-editor":{position:"relative !important",boxSizing:"border-box","&.cm-focused":{outline:"1px dotted #212121"},display:"flex !important",flexDirection:"column"},".cm-scroller":{display:"flex !important",alignItems:"flex-start !important",fontFamily:"monospace",lineHeight:1.4,height:"100%",overflowX:"auto",position:"relative",zIndex:0},".cm-content":{margin:0,flexGrow:2,minHeight:"100%",display:"block",whiteSpace:"pre",wordWrap:"normal",boxSizing:"border-box",padding:"4px 0",outline:"none","&[contenteditable=true]":{WebkitUserModify:"read-write-plaintext-only"}},".cm-lineWrapping":{whiteSpace_fallback:"pre-wrap",whiteSpace:"break-spaces",wordBreak:"break-word",overflowWrap:"anywhere"},"&light .cm-content":{caretColor:"black"},"&dark .cm-content":{caretColor:"white"},".cm-line":{display:"block",padding:"0 2px 0 4px"},".cm-selectionLayer":{zIndex:-1,contain:"size style"},".cm-selectionBackground":{position:"absolute"},"&light .cm-selectionBackground":{background:"#d9d9d9"},"&dark .cm-selectionBackground":{background:"#222"},"&light.cm-focused .cm-selectionBackground":{background:"#d7d4f0"},"&dark.cm-focused .cm-selectionBackground":{background:"#233"},".cm-cursorLayer":{zIndex:100,contain:"size style",pointerEvents:"none"},"&.cm-focused .cm-cursorLayer":{animation:"steps(1) cm-blink 1.2s infinite"},"@keyframes cm-blink":{"0%":{},"50%":{visibility:"hidden"},"100%":{}},"@keyframes cm-blink2":{"0%":{},"50%":{visibility:"hidden"},"100%":{}},".cm-cursor, .cm-dropCursor":{position:"absolute",borderLeft:"1.2px solid black",marginLeft:"-0.6px",pointerEvents:"none"},".cm-cursor":{display:"none"},"&dark .cm-cursor":{borderLeftColor:"#444"},"&.cm-focused .cm-cursor":{display:"block"},"&light .cm-activeLine":{backgroundColor:"#f3f9ff"},"&dark .cm-activeLine":{backgroundColor:"#223039"},"&light .cm-specialChar":{color:"red"},"&dark .cm-specialChar":{color:"#f78"},".cm-tab":{display:"inline-block",overflow:"hidden",verticalAlign:"bottom"},".cm-placeholder":{color:"#888",display:"inline-block",verticalAlign:"top"},".cm-button":{verticalAlign:"middle",color:"inherit",fontSize:"70%",padding:".2em 1em",borderRadius:"1px"},"&light .cm-button":{backgroundImage:"linear-gradient(#eff1f5, #d9d9df)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#b4b4b4, #d0d3d6)"}},"&dark .cm-button":{backgroundImage:"linear-gradient(#393939, #111)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#111, #333)"}},".cm-textfield":{verticalAlign:"middle",color:"inherit",fontSize:"70%",border:"1px solid silver",padding:".2em .5em"},"&light .cm-textfield":{backgroundColor:"white"},"&dark .cm-textfield":{border:"1px solid #555",backgroundColor:"inherit"}},lightDarkIDs),observeOptions={childList:!0,characterData:!0,subtree:!0,attributes:!0,characterDataOldValue:!0},useCharData=browser.ie&&browser.ie_version<=11;class DOMObserver{constructor(e,t,i){this.view=e,this.onChange=t,this.onScrollChanged=i,this.active=!1,this.selectionRange=new DOMSelectionState,this.selectionChanged=!1,this.delayedFlush=-1,this.resizeTimeout=-1,this.queue=[],this.delayedAndroidKey=null,this.scrollTargets=[],this.intersection=null,this.resize=null,this.intersecting=!1,this.gapIntersection=null,this.gaps=[],this.parentCheck=-1,this.dom=e.contentDOM,this.observer=new MutationObserver(t=>{for(let e of t)this.queue.push(e);(browser.ie&&browser.ie_version<=11||browser.ios&&e.composing)&&t.some(e=>"childList"==e.type&&e.removedNodes.length||"characterData"==e.type&&e.oldValue.length>e.target.nodeValue.length)?this.flushSoon():this.flush()}),useCharData&&(this.onCharData=e=>{this.queue.push({target:e.target,type:"characterData",oldValue:e.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this),"function"==typeof ResizeObserver&&(this.resize=new ResizeObserver(()=>{this.view.docView.lastUpdate<Date.now()-75&&this.resizeTimeout<0&&(this.resizeTimeout=setTimeout(()=>{this.resizeTimeout=-1,this.view.requestMeasure()},50))}),this.resize.observe(e.scrollDOM)),this.start(),this.onScroll=this.onScroll.bind(this),window.addEventListener("scroll",this.onScroll),"function"==typeof IntersectionObserver&&(this.intersection=new IntersectionObserver(e=>{this.parentCheck<0&&(this.parentCheck=setTimeout(this.listenForScroll.bind(this),1e3)),e.length>0&&e[e.length-1].intersectionRatio>0!=this.intersecting&&(this.intersecting=!this.intersecting,this.intersecting!=this.view.inView&&this.onScrollChanged(document.createEvent("Event")))},{}),this.intersection.observe(this.dom),this.gapIntersection=new IntersectionObserver(e=>{e.length>0&&e[e.length-1].intersectionRatio>0&&this.onScrollChanged(document.createEvent("Event"))},{})),this.listenForScroll(),this.readSelectionRange(),this.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}onScroll(e){this.intersecting&&this.flush(!1),this.onScrollChanged(e)}updateGaps(e){if(this.gapIntersection&&(e.length!=this.gaps.length||this.gaps.some((t,i)=>t!=e[i]))){this.gapIntersection.disconnect();for(let t of e)this.gapIntersection.observe(t);this.gaps=e}}onSelectionChange(e){if(!this.readSelectionRange()||this.delayedAndroidKey)return;let{view:t}=this,i=this.selectionRange;if(t.state.facet(editable)?t.root.activeElement!=this.dom:!hasSelection(t.dom,i))return;let o=i.anchorNode&&t.docView.nearest(i.anchorNode);o&&o.ignoreEvent(e)||((browser.ie&&browser.ie_version<=11||browser.android&&browser.chrome)&&!t.state.selection.main.empty&&i.focusNode&&isEquivalentPosition(i.focusNode,i.focusOffset,i.anchorNode,i.anchorOffset)?this.flushSoon():this.flush(!1))}readSelectionRange(){let{root:e}=this.view,t=getSelection(e),i=browser.safari&&11==e.nodeType&&deepActiveElement()==this.view.contentDOM&&safariSelectionRangeHack(this.view)||t;return!this.selectionRange.eq(i)&&(this.selectionRange.setRange(i),this.selectionChanged=!0)}setSelectionRange(e,t){this.selectionRange.set(e.node,e.offset,t.node,t.offset),this.selectionChanged=!1}listenForScroll(){this.parentCheck=-1;let e=0,t=null;for(let i=this.dom;i;)if(1==i.nodeType)!t&&e<this.scrollTargets.length&&this.scrollTargets[e]==i?e++:t||(t=this.scrollTargets.slice(0,e)),t&&t.push(i),i=i.assignedSlot||i.parentNode;else{if(11!=i.nodeType)break;i=i.host}if(e<this.scrollTargets.length&&!t&&(t=this.scrollTargets.slice(0,e)),t){for(let e of this.scrollTargets)e.removeEventListener("scroll",this.onScroll);for(let e of this.scrollTargets=t)e.addEventListener("scroll",this.onScroll)}}ignore(e){if(!this.active)return e();try{return this.stop(),e()}finally{this.start(),this.clear()}}start(){this.active||(this.observer.observe(this.dom,observeOptions),useCharData&&this.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.active=!0)}stop(){this.active&&(this.active=!1,this.observer.disconnect(),useCharData&&this.dom.removeEventListener("DOMCharacterDataModified",this.onCharData))}clear(){this.observer.takeRecords(),this.queue.length=0,this.selectionChanged=!1}delayAndroidKey(e,t){this.delayedAndroidKey||requestAnimationFrame(()=>{let e=this.delayedAndroidKey;this.delayedAndroidKey=null;let t=this.view.state;dispatchKey(this.view.contentDOM,e.key,e.keyCode)?this.processRecords():this.flush(),this.view.state==t&&this.view.update([])}),this.delayedAndroidKey&&"Enter"!=e||(this.delayedAndroidKey={key:e,keyCode:t})}flushSoon(){this.delayedFlush<0&&(this.delayedFlush=window.setTimeout(()=>{this.delayedFlush=-1,this.flush()},20))}forceFlush(){this.delayedFlush>=0&&(window.clearTimeout(this.delayedFlush),this.delayedFlush=-1,this.flush())}processRecords(){let e=this.queue;for(let t of this.observer.takeRecords())e.push(t);e.length&&(this.queue=[]);let t=-1,i=-1,o=!1;for(let s of e){let e=this.readMutation(s);e&&(e.typeOver&&(o=!0),-1==t?({from:t,to:i}=e):(t=Math.min(e.from,t),i=Math.max(e.to,i)))}return{from:t,to:i,typeOver:o}}flush(e=!0){if(this.delayedFlush>=0||this.delayedAndroidKey)return;e&&this.readSelectionRange();let{from:t,to:i,typeOver:o}=this.processRecords(),s=this.selectionChanged&&hasSelection(this.dom,this.selectionRange);if(t<0&&!s)return;this.selectionChanged=!1;let n=this.view.state;this.onChange(t,i,o),this.view.state==n&&this.view.update([])}readMutation(e){let t=this.view.docView.nearest(e.target);if(!t||t.ignoreMutation(e))return null;if(t.markDirty("attributes"==e.type),"attributes"==e.type&&(t.dirty|=4),"childList"==e.type){let i=findChild(t,e.previousSibling||e.target.previousSibling,-1),o=findChild(t,e.nextSibling||e.target.nextSibling,1);return{from:i?t.posAfter(i):t.posAtStart,to:o?t.posBefore(o):t.posAtEnd,typeOver:!1}}return"characterData"==e.type?{from:t.posAtStart,to:t.posAtEnd,typeOver:e.target.nodeValue==e.oldValue}:null}destroy(){var e,t,i;this.stop(),null===(e=this.intersection)||void 0===e||e.disconnect(),null===(t=this.gapIntersection)||void 0===t||t.disconnect(),null===(i=this.resize)||void 0===i||i.disconnect();for(let e of this.scrollTargets)e.removeEventListener("scroll",this.onScroll);window.removeEventListener("scroll",this.onScroll),this.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange),clearTimeout(this.parentCheck),clearTimeout(this.resizeTimeout)}}function findChild(e,t,i){for(;t;){let o=ContentView.get(t);if(o&&o.parent==e)return o;let s=t.parentNode;t=s!=e.dom?s:i>0?t.nextSibling:t.previousSibling}return null}function safariSelectionRangeHack(e){let t=null;function i(e){e.preventDefault(),e.stopImmediatePropagation(),t=e.getTargetRanges()[0]}if(e.contentDOM.addEventListener("beforeinput",i,!0),document.execCommand("indent"),e.contentDOM.removeEventListener("beforeinput",i,!0),!t)return null;let o=t.startContainer,s=t.startOffset,n=t.endContainer,r=t.endOffset,l=e.docView.domAtPos(e.state.selection.main.anchor);return isEquivalentPosition(l.node,l.offset,n,r)&&([o,s,n,r]=[n,r,o,s]),{anchorNode:o,anchorOffset:s,focusNode:n,focusOffset:r}}function applyDOMChange(e,t,i,o){let s,n,r=e.state.selection.main;if(t>-1){let o=e.docView.domBoundsAround(t,i,0);if(!o||e.state.readOnly)return;let{from:l,to:a}=o,h=e.docView.impreciseHead||e.docView.impreciseAnchor?[]:selectionPoints(e),c=new DOMReader(h,e);c.readRange(o.startDOM,o.endDOM),n=selectionFromPoints(h,l);let d=r.from,u=null;(8===e.inputState.lastKeyCode&&e.inputState.lastKeyTime>Date.now()-100||browser.android&&c.text.length<a-l)&&(d=r.to,u="end");let p=findDiff(e.state.sliceDoc(l,a),c.text,d-l,u);p&&(s={from:l+p.from,to:l+p.toA,insert:e.state.toText(c.text.slice(p.from,p.toB))})}else if(e.hasFocus||!e.state.facet(editable)){let t=e.observer.selectionRange,{impreciseHead:i,impreciseAnchor:o}=e.docView,s=i&&i.node==t.focusNode&&i.offset==t.focusOffset||!contains(e.contentDOM,t.focusNode)?e.state.selection.main.head:e.docView.posFromDOM(t.focusNode,t.focusOffset),l=o&&o.node==t.anchorNode&&o.offset==t.anchorOffset||!contains(e.contentDOM,t.anchorNode)?e.state.selection.main.anchor:e.docView.posFromDOM(t.anchorNode,t.anchorOffset);s==r.head&&l==r.anchor||(n=EditorSelection.single(l,s))}if(s||n)if(!s&&o&&!r.empty&&n&&n.main.empty?s={from:r.from,to:r.to,insert:e.state.doc.slice(r.from,r.to)}:s&&s.from>=r.from&&s.to<=r.to&&(s.from!=r.from||s.to!=r.to)&&r.to-r.from-(s.to-s.from)<=4&&(s={from:r.from,to:r.to,insert:e.state.doc.slice(r.from,s.from).append(s.insert).append(e.state.doc.slice(s.to,r.to))}),s){let t=e.state;if(browser.ios&&e.inputState.flushIOSKey(e))return;if(browser.android&&(s.from==r.from&&s.to==r.to&&1==s.insert.length&&2==s.insert.lines&&dispatchKey(e.contentDOM,"Enter",13)||s.from==r.from-1&&s.to==r.to&&0==s.insert.length&&dispatchKey(e.contentDOM,"Backspace",8)||s.from==r.from&&s.to==r.to+1&&0==s.insert.length&&dispatchKey(e.contentDOM,"Delete",46)))return;let i,o=s.insert.toString();if(e.state.facet(inputHandler).some(t=>t(e,s.from,s.to,o)))return;if(e.inputState.composing>=0&&e.inputState.composing++,s.from>=r.from&&s.to<=r.to&&s.to-s.from>=(r.to-r.from)/3&&(!n||n.main.empty&&n.main.from==s.from+s.insert.length)){let o=r.from<s.from?t.sliceDoc(r.from,s.from):"",n=r.to>s.to?t.sliceDoc(s.to,r.to):"";i=t.replaceSelection(e.state.toText(o+s.insert.sliceString(0,void 0,e.state.lineBreak)+n))}else{let e=t.changes(s);i={changes:e,selection:n&&!t.selection.main.eq(n.main)&&n.main.to<=e.newLength?t.selection.replaceRange(n.main):void 0}}let l="input.type";e.composing&&(l+=".compose",e.inputState.compositionFirstChange&&(l+=".start",e.inputState.compositionFirstChange=!1)),e.dispatch(i,{scrollIntoView:!0,userEvent:l})}else if(n&&!n.main.eq(r)){let t=!1,i="select";e.inputState.lastSelectionTime>Date.now()-50&&("select"==e.inputState.lastSelectionOrigin&&(t=!0),i=e.inputState.lastSelectionOrigin),e.dispatch({selection:n,scrollIntoView:t,userEvent:i})}}function findDiff(e,t,i,o){let s=Math.min(e.length,t.length),n=0;for(;n<s&&e.charCodeAt(n)==t.charCodeAt(n);)n++;if(n==s&&e.length==t.length)return null;let r=e.length,l=t.length;for(;r>0&&l>0&&e.charCodeAt(r-1)==t.charCodeAt(l-1);)r--,l--;if("end"==o){i-=r+Math.max(0,n-Math.min(r,l))-n}if(r<n&&e.length<t.length){n-=i<=n&&i>=r?n-i:0,l=n+(l-r),r=n}else if(l<n){n-=i<=n&&i>=l?n-i:0,r=n+(r-l),l=n}return{from:n,toA:r,toB:l}}function selectionPoints(e){let t=[];if(e.root.activeElement!=e.contentDOM)return t;let{anchorNode:i,anchorOffset:o,focusNode:s,focusOffset:n}=e.observer.selectionRange;return i&&(t.push(new DOMPoint(i,o)),s==i&&n==o||t.push(new DOMPoint(s,n))),t}function selectionFromPoints(e,t){if(0==e.length)return null;let i=e[0].pos,o=2==e.length?e[1].pos:i;return i>-1&&o>-1?EditorSelection.single(i+t,o+t):null}class EditorView{constructor(e={}){this.plugins=[],this.pluginMap=new Map,this.editorAttrs={},this.contentAttrs={},this.bidiCache=[],this.destroyed=!1,this.updateState=2,this.measureScheduled=-1,this.measureRequests=[],this.contentDOM=document.createElement("div"),this.scrollDOM=document.createElement("div"),this.scrollDOM.tabIndex=-1,this.scrollDOM.className="cm-scroller",this.scrollDOM.appendChild(this.contentDOM),this.announceDOM=document.createElement("div"),this.announceDOM.style.cssText="position: absolute; top: -10000px",this.announceDOM.setAttribute("aria-live","polite"),this.dom=document.createElement("div"),this.dom.appendChild(this.announceDOM),this.dom.appendChild(this.scrollDOM),this._dispatch=e.dispatch||(e=>this.update([e])),this.dispatch=this.dispatch.bind(this),this.root=e.root||getRoot(e.parent)||document,this.viewState=new ViewState(e.state||EditorState.create()),this.plugins=this.state.facet(viewPlugin).map(e=>new PluginInstance(e));for(let e of this.plugins)e.update(this);this.observer=new DOMObserver(this,(e,t,i)=>{applyDOMChange(this,e,t,i)},e=>{this.inputState.runScrollHandlers(this,e),this.observer.intersecting&&this.measure()}),this.inputState=new InputState(this),this.docView=new DocView(this),this.mountStyles(),this.updateAttrs(),this.updateState=0,ensureGlobalHandler(),this.requestMeasure(),e.parent&&e.parent.appendChild(this.dom)}get state(){return this.viewState.state}get viewport(){return this.viewState.viewport}get visibleRanges(){return this.viewState.visibleRanges}get inView(){return this.viewState.inView}get composing(){return this.inputState.composing>0}dispatch(...e){this._dispatch(1==e.length&&e[0]instanceof Transaction?e[0]:this.state.update(...e))}update(e){if(0!=this.updateState)throw new Error("Calls to EditorView.update are not allowed while an update is in progress");let t,i=!1,o=this.state;for(let t of e){if(t.startState!=o)throw new RangeError("Trying to update state with a transaction that doesn't start from the previous state.");o=t.state}if(this.destroyed)return void(this.viewState.state=o);if(o.facet(EditorState.phrases)!=this.state.facet(EditorState.phrases))return this.setState(o);t=new ViewUpdate(this,o,e);let s=this.viewState.scrollTarget;try{this.updateState=2;for(let t of e){if(s&&(s=s.map(t.changes)),t.scrollIntoView){let{main:e}=t.state.selection;s=new ScrollTarget(e.empty?e:EditorSelection.cursor(e.head,e.head>e.anchor?-1:1))}for(let e of t.effects)e.is(scrollTo)?s=new ScrollTarget(e.value):e.is(centerOn)?s=new ScrollTarget(e.value,"center"):e.is(scrollIntoView)&&(s=e.value)}this.viewState.update(t,s),this.bidiCache=CachedOrder.update(this.bidiCache,t.changes),t.empty||(this.updatePlugins(t),this.inputState.update(t)),i=this.docView.update(t),this.state.facet(styleModule)!=this.styleModules&&this.mountStyles(),this.updateAttrs(),this.showAnnouncements(e),this.docView.updateSelection(i,e.some(e=>e.isUserEvent("select.pointer")))}finally{this.updateState=0}if((i||s||this.viewState.mustEnforceCursorAssoc)&&this.requestMeasure(),!t.empty)for(let e of this.state.facet(updateListener))e(t)}setState(e){if(0!=this.updateState)throw new Error("Calls to EditorView.setState are not allowed while an update is in progress");if(this.destroyed)this.viewState.state=e;else{this.updateState=2;try{for(let e of this.plugins)e.destroy(this);this.viewState=new ViewState(e),this.plugins=e.facet(viewPlugin).map(e=>new PluginInstance(e)),this.pluginMap.clear();for(let e of this.plugins)e.update(this);this.docView=new DocView(this),this.inputState.ensureHandlers(this),this.mountStyles(),this.updateAttrs(),this.bidiCache=[]}finally{this.updateState=0}this.requestMeasure()}}updatePlugins(e){let t=e.startState.facet(viewPlugin),i=e.state.facet(viewPlugin);if(t!=i){let o=[];for(let s of i){let i=t.indexOf(s);if(i<0)o.push(new PluginInstance(s));else{let t=this.plugins[i];t.mustUpdate=e,o.push(t)}}for(let t of this.plugins)t.mustUpdate!=e&&t.destroy(this);this.plugins=o,this.pluginMap.clear(),this.inputState.ensureHandlers(this)}else for(let t of this.plugins)t.mustUpdate=e;for(let e=0;e<this.plugins.length;e++)this.plugins[e].update(this)}measure(e=!0){if(this.destroyed)return;this.measureScheduled>-1&&cancelAnimationFrame(this.measureScheduled),this.measureScheduled=0,e&&this.observer.flush();let t=null;try{for(let e=0;;e++){this.updateState=1;let i=this.viewport,o=this.viewState.measure(this);if(!o&&!this.measureRequests.length&&null==this.viewState.scrollTarget)break;if(e>5){console.warn(this.measureRequests.length?"Measure loop restarted more than 5 times":"Viewport failed to stabilize");break}let s=[];4&o||([this.measureRequests,s]=[s,this.measureRequests]);let n=s.map(e=>{try{return e.read(this)}catch(e){return logException(this.state,e),BadMeasure}}),r=new ViewUpdate(this,this.state),l=!1;r.flags|=o,t?t.flags|=o:t=r,this.updateState=2,r.empty||(this.updatePlugins(r),this.inputState.update(r),this.updateAttrs(),l=this.docView.update(r));for(let e=0;e<s.length;e++)if(n[e]!=BadMeasure)try{let t=s[e];t.write&&t.write(n[e],this)}catch(e){logException(this.state,e)}if(this.viewState.scrollTarget&&(this.docView.scrollIntoView(this.viewState.scrollTarget),this.viewState.scrollTarget=null),l&&this.docView.updateSelection(!0),this.viewport.from==i.from&&this.viewport.to==i.to&&0==this.measureRequests.length)break}}finally{this.updateState=0,this.measureScheduled=-1}if(t&&!t.empty)for(let e of this.state.facet(updateListener))e(t)}get themeClasses(){return baseThemeID+" "+(this.state.facet(darkTheme)?baseDarkID:baseLightID)+" "+this.state.facet(theme)}updateAttrs(){let e=attrsFromFacet(this,editorAttributes,{class:"cm-editor"+(this.hasFocus?" cm-focused ":" ")+this.themeClasses}),t={spellcheck:"false",autocorrect:"off",autocapitalize:"off",translate:"no",contenteditable:this.state.facet(editable)?"true":"false",class:"cm-content",style:`${browser.tabSize}: ${this.state.tabSize}`,role:"textbox","aria-multiline":"true"};this.state.readOnly&&(t["aria-readonly"]="true"),attrsFromFacet(this,contentAttributes,t),this.observer.ignore(()=>{updateAttrs(this.contentDOM,this.contentAttrs,t),updateAttrs(this.dom,this.editorAttrs,e)}),this.editorAttrs=e,this.contentAttrs=t}showAnnouncements(e){let t=!0;for(let i of e)for(let e of i.effects)if(e.is(EditorView.announce)){t&&(this.announceDOM.textContent=""),t=!1,this.announceDOM.appendChild(document.createElement("div")).textContent=e.value}}mountStyles(){this.styleModules=this.state.facet(styleModule),StyleModule.mount(this.root,this.styleModules.concat(baseTheme).reverse())}readMeasured(){if(2==this.updateState)throw new Error("Reading the editor layout isn't allowed during an update");0==this.updateState&&this.measureScheduled>-1&&this.measure(!1)}requestMeasure(e){if(this.measureScheduled<0&&(this.measureScheduled=requestAnimationFrame(()=>this.measure())),e){if(null!=e.key)for(let t=0;t<this.measureRequests.length;t++)if(this.measureRequests[t].key===e.key)return void(this.measureRequests[t]=e);this.measureRequests.push(e)}}pluginField(e){let t=[];for(let i of this.plugins)i.update(this).takeField(e,t);return t}plugin(e){let t=this.pluginMap.get(e);return(void 0===t||t&&t.spec!=e)&&this.pluginMap.set(e,t=this.plugins.find(t=>t.spec==e)||null),t&&t.update(this).value}get documentTop(){return this.contentDOM.getBoundingClientRect().top+this.viewState.paddingTop}get documentPadding(){return{top:this.viewState.paddingTop,bottom:this.viewState.paddingBottom}}blockAtHeight(e,t){let i=ensureTop(t,this);return this.elementAtHeight(e-i).moveY(i)}elementAtHeight(e){return this.readMeasured(),this.viewState.elementAtHeight(e)}visualLineAtHeight(e,t){let i=ensureTop(t,this);return this.lineBlockAtHeight(e-i).moveY(i)}lineBlockAtHeight(e){return this.readMeasured(),this.viewState.lineBlockAtHeight(e)}viewportLines(e,t){let i=ensureTop(t,this);for(let t of this.viewportLineBlocks)e(t.moveY(i))}get viewportLineBlocks(){return this.viewState.viewportLines}visualLineAt(e,t=0){return this.lineBlockAt(e).moveY(t+this.viewState.paddingTop)}lineBlockAt(e){return this.viewState.lineBlockAt(e)}get contentHeight(){return this.viewState.contentHeight}moveByChar(e,t,i){return skipAtoms(this,e,moveByChar(this,e,t,i))}moveByGroup(e,t){return skipAtoms(this,e,moveByChar(this,e,t,t=>byGroup(this,e.head,t)))}moveToLineBoundary(e,t,i=!0){return moveToLineBoundary(this,e,t,i)}moveVertically(e,t,i){return skipAtoms(this,e,moveVertically(this,e,t,i))}scrollPosIntoView(e){this.dispatch({effects:scrollTo.of(EditorSelection.cursor(e))})}domAtPos(e){return this.docView.domAtPos(e)}posAtDOM(e,t=0){return this.docView.posFromDOM(e,t)}posAtCoords(e,t=!0){return this.readMeasured(),posAtCoords(this,e,t)}coordsAtPos(e,t=1){this.readMeasured();let i=this.docView.coordsAt(e,t);if(!i||i.left==i.right)return i;let o=this.state.doc.lineAt(e),s=this.bidiSpans(o);return flattenRect(i,s[BidiSpan.find(s,e-o.from,-1,t)].dir==Direction.LTR==t>0)}get defaultCharacterWidth(){return this.viewState.heightOracle.charWidth}get defaultLineHeight(){return this.viewState.heightOracle.lineHeight}get textDirection(){return this.viewState.heightOracle.direction}get lineWrapping(){return this.viewState.heightOracle.lineWrapping}bidiSpans(e){if(e.length>MaxBidiLine)return trivialOrder(e.length);let t=this.textDirection;for(let i of this.bidiCache)if(i.from==e.from&&i.dir==t)return i.order;let i=computeOrder(e.text,this.textDirection);return this.bidiCache.push(new CachedOrder(e.from,e.to,t,i)),i}get hasFocus(){var e;return(document.hasFocus()||browser.safari&&(null===(e=this.inputState)||void 0===e?void 0:e.lastContextMenu)>Date.now()-3e4)&&this.root.activeElement==this.contentDOM}focus(){this.observer.ignore(()=>{focusPreventScroll(this.contentDOM),this.docView.updateSelection()})}destroy(){for(let e of this.plugins)e.destroy(this);this.plugins=[],this.inputState.destroy(),this.dom.remove(),this.observer.destroy(),this.measureScheduled>-1&&cancelAnimationFrame(this.measureScheduled),this.destroyed=!0}static scrollIntoView(e,t={}){return scrollIntoView.of(new ScrollTarget("number"==typeof e?EditorSelection.cursor(e):e,t.y,t.x,t.yMargin,t.xMargin))}static domEventHandlers(e){return ViewPlugin.define(()=>({}),{eventHandlers:e})}static theme(e,t){let i=StyleModule.newName(),o=[theme.of(i),styleModule.of(buildTheme("."+i,e))];return t&&t.dark&&o.push(darkTheme.of(!0)),o}static baseTheme(e){return Prec.lowest(styleModule.of(buildTheme("."+baseThemeID,e,lightDarkIDs)))}}EditorView.scrollTo=scrollTo,EditorView.centerOn=centerOn,EditorView.styleModule=styleModule,EditorView.inputHandler=inputHandler,EditorView.exceptionSink=exceptionSink,EditorView.updateListener=updateListener,EditorView.editable=editable,EditorView.mouseSelectionStyle=mouseSelectionStyle,EditorView.dragMovesSelection=dragMovesSelection$1,EditorView.clickAddsSelectionRange=clickAddsSelectionRange,EditorView.decorations=decorations,EditorView.darkTheme=darkTheme,EditorView.contentAttributes=contentAttributes,EditorView.editorAttributes=editorAttributes,EditorView.lineWrapping=EditorView.contentAttributes.of({class:"cm-lineWrapping"}),EditorView.announce=StateEffect.define();const MaxBidiLine=4096;function ensureTop(e,t){return(null==e?t.contentDOM.getBoundingClientRect().top:e)+t.viewState.paddingTop}let resizeDebounce=-1;function ensureGlobalHandler(){window.addEventListener("resize",()=>{-1==resizeDebounce&&(resizeDebounce=setTimeout(handleResize,50))})}function handleResize(){resizeDebounce=-1;let e=document.querySelectorAll(".cm-content");for(let t=0;t<e.length;t++){let i=ContentView.get(e[t]);i&&i.editorView.requestMeasure()}}const BadMeasure={};class CachedOrder{constructor(e,t,i,o){this.from=e,this.to=t,this.dir=i,this.order=o}static update(e,t){if(t.empty)return e;let i=[],o=e.length?e[e.length-1].dir:Direction.LTR;for(let s=Math.max(0,e.length-10);s<e.length;s++){let n=e[s];n.dir!=o||t.touchesRange(n.from,n.to)||i.push(new CachedOrder(t.mapPos(n.from,1),t.mapPos(n.to,-1),n.dir,n.order))}return i}}function attrsFromFacet(e,t,i){for(let o=e.state.facet(t),s=o.length-1;s>=0;s--){let t=o[s],n="function"==typeof t?t(e):t;n&&combineAttrs(n,i)}return i}const currentPlatform=browser.mac?"mac":browser.windows?"win":browser.linux?"linux":"key";function normalizeKeyName(e,t){const i=e.split(/-(?!$)/);let o,s,n,r,l=i[i.length-1];"Space"==l&&(l=" ");for(let e=0;e<i.length-1;++e){const l=i[e];if(/^(cmd|meta|m)$/i.test(l))r=!0;else if(/^a(lt)?$/i.test(l))o=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))n=!0;else{if(!/^mod$/i.test(l))throw new Error("Unrecognized modifier name: "+l);"mac"==t?r=!0:s=!0}}return o&&(l="Alt-"+l),s&&(l="Ctrl-"+l),r&&(l="Meta-"+l),n&&(l="Shift-"+l),l}function modifiers(e,t,i){return t.altKey&&(e="Alt-"+e),t.ctrlKey&&(e="Ctrl-"+e),t.metaKey&&(e="Meta-"+e),!1!==i&&t.shiftKey&&(e="Shift-"+e),e}const handleKeyEvents=EditorView.domEventHandlers({keydown:(e,t)=>runHandlers(getKeymap(t.state),e,t,"editor")}),keymap=Facet.define({enables:handleKeyEvents}),Keymaps=new WeakMap;function getKeymap(e){let t=e.facet(keymap),i=Keymaps.get(t);return i||Keymaps.set(t,i=buildKeymap(t.reduce((e,t)=>e.concat(t),[]))),i}function runScopeHandlers(e,t,i){return runHandlers(getKeymap(e.state),t,e,i)}let storedPrefix=null;const PrefixTimeout=4e3;function buildKeymap(e,t=currentPlatform){let i=Object.create(null),o=Object.create(null),s=(e,t)=>{let i=o[e];if(null==i)o[e]=t;else if(i!=t)throw new Error("Key binding "+e+" is used both as a regular binding and as a multi-stroke prefix")},n=(e,o,n,r)=>{let l=i[e]||(i[e]=Object.create(null)),a=o.split(/ (?!$)/).map(e=>normalizeKeyName(e,t));for(let t=1;t<a.length;t++){let i=a.slice(0,t).join(" ");s(i,!0),l[i]||(l[i]={preventDefault:!0,commands:[t=>{let o=storedPrefix={view:t,prefix:i,scope:e};return setTimeout(()=>{storedPrefix==o&&(storedPrefix=null)},4e3),!0}]})}let h=a.join(" ");s(h,!1);let c=l[h]||(l[h]={preventDefault:!1,commands:[]});c.commands.push(n),r&&(c.preventDefault=!0)};for(let i of e){let e=i[t]||i.key;if(e)for(let t of i.scope?i.scope.split(" "):["editor"])n(t,e,i.run,i.preventDefault),i.shift&&n(t,"Shift-"+e,i.shift,i.preventDefault)}return i}function runHandlers(e,t,i,o){let s=keyName(t),n=1==s.length&&" "!=s,r="",l=!1;storedPrefix&&storedPrefix.view==i&&storedPrefix.scope==o&&(r=storedPrefix.prefix+" ",(l=modifierCodes.indexOf(t.keyCode)<0)&&(storedPrefix=null));let a,h=e=>{if(e){for(let t of e.commands)if(t(i))return!0;e.preventDefault&&(l=!0)}return!1},c=e[o];if(c){if(h(c[r+modifiers(s,t,!n)]))return!0;if(n&&(t.shiftKey||t.altKey||t.metaKey)&&(a=base[t.keyCode])&&a!=s){if(h(c[r+modifiers(a,t,!0)]))return!0}else if(n&&t.shiftKey&&h(c[r+modifiers(s,t,!0)]))return!0}return l}const CanHidePrimary=!browser.ios,selectionConfig=Facet.define({combine:e=>combineConfig(e,{cursorBlinkRate:1200,drawRangeCursor:!0},{cursorBlinkRate:(e,t)=>Math.min(e,t),drawRangeCursor:(e,t)=>e||t})});function drawSelection(e={}){return[selectionConfig.of(e),drawSelectionPlugin,hideNativeSelection]}class Piece{constructor(e,t,i,o,s){this.left=e,this.top=t,this.width=i,this.height=o,this.className=s}draw(){let e=document.createElement("div");return e.className=this.className,this.adjust(e),e}adjust(e){e.style.left=this.left+"px",e.style.top=this.top+"px",this.width>=0&&(e.style.width=this.width+"px"),e.style.height=this.height+"px"}eq(e){return this.left==e.left&&this.top==e.top&&this.width==e.width&&this.height==e.height&&this.className==e.className}}const drawSelectionPlugin=ViewPlugin.fromClass(class{constructor(e){this.view=e,this.rangePieces=[],this.cursors=[],this.measureReq={read:this.readPos.bind(this),write:this.drawSel.bind(this)},this.selectionLayer=e.scrollDOM.appendChild(document.createElement("div")),this.selectionLayer.className="cm-selectionLayer",this.selectionLayer.setAttribute("aria-hidden","true"),this.cursorLayer=e.scrollDOM.appendChild(document.createElement("div")),this.cursorLayer.className="cm-cursorLayer",this.cursorLayer.setAttribute("aria-hidden","true"),e.requestMeasure(this.measureReq),this.setBlinkRate()}setBlinkRate(){this.cursorLayer.style.animationDuration=this.view.state.facet(selectionConfig).cursorBlinkRate+"ms"}update(e){let t=e.startState.facet(selectionConfig)!=e.state.facet(selectionConfig);(t||e.selectionSet||e.geometryChanged||e.viewportChanged)&&this.view.requestMeasure(this.measureReq),e.transactions.some(e=>e.scrollIntoView)&&(this.cursorLayer.style.animationName="cm-blink"==this.cursorLayer.style.animationName?"cm-blink2":"cm-blink"),t&&this.setBlinkRate()}readPos(){let{state:e}=this.view,t=e.facet(selectionConfig),i=e.selection.ranges.map(e=>e.empty?[]:measureRange(this.view,e)).reduce((e,t)=>e.concat(t)),o=[];for(let i of e.selection.ranges){let s=i==e.selection.main;if(i.empty?!s||CanHidePrimary:t.drawRangeCursor){let e=measureCursor(this.view,i,s);e&&o.push(e)}}return{rangePieces:i,cursors:o}}drawSel({rangePieces:e,cursors:t}){if(e.length!=this.rangePieces.length||e.some((e,t)=>!e.eq(this.rangePieces[t]))){this.selectionLayer.textContent="";for(let t of e)this.selectionLayer.appendChild(t.draw());this.rangePieces=e}if(t.length!=this.cursors.length||t.some((e,t)=>!e.eq(this.cursors[t]))){let e=this.cursorLayer.children;if(e.length!==t.length){this.cursorLayer.textContent="";for(const e of t)this.cursorLayer.appendChild(e.draw())}else t.forEach((t,i)=>t.adjust(e[i]));this.cursors=t}}destroy(){this.selectionLayer.remove(),this.cursorLayer.remove()}}),themeSpec={".cm-line":{"& ::selection":{backgroundColor:"transparent !important"},"&::selection":{backgroundColor:"transparent !important"}}};CanHidePrimary&&(themeSpec[".cm-line"].caretColor="transparent !important");const hideNativeSelection=Prec.highest(EditorView.theme(themeSpec));function getBase(e){let t=e.scrollDOM.getBoundingClientRect();return{left:(e.textDirection==Direction.LTR?t.left:t.right-e.scrollDOM.clientWidth)-e.scrollDOM.scrollLeft,top:t.top-e.scrollDOM.scrollTop}}function wrappedLine(e,t,i){let o=EditorSelection.cursor(t);return{from:Math.max(i.from,e.moveToLineBoundary(o,!1,!0).from),to:Math.min(i.to,e.moveToLineBoundary(o,!0,!0).from),type:BlockType.Text}}function blockAt(e,t){let i=e.lineBlockAt(t);if(Array.isArray(i.type))for(let e of i.type)if(e.to>t||e.to==t&&(e.to==i.to||e.type==BlockType.Text))return e;return i}function measureRange(e,t){if(t.to<=e.viewport.from||t.from>=e.viewport.to)return[];let i=Math.max(t.from,e.viewport.from),o=Math.min(t.to,e.viewport.to),s=e.textDirection==Direction.LTR,n=e.contentDOM,r=n.getBoundingClientRect(),l=getBase(e),a=window.getComputedStyle(n.firstChild),h=r.left+parseInt(a.paddingLeft)+Math.min(0,parseInt(a.textIndent)),c=r.right-parseInt(a.paddingRight),d=blockAt(e,i),u=blockAt(e,o),p=d.type==BlockType.Text?d:null,f=u.type==BlockType.Text?u:null;if(e.lineWrapping&&(p&&(p=wrappedLine(e,i,p)),f&&(f=wrappedLine(e,o,f))),p&&f&&p.from==f.from)return m(w(t.from,t.to,p));{let i=p?w(t.from,null,p):y(d,!1),o=f?w(null,t.to,f):y(u,!0),s=[];return(p||d).to<(f||u).from-1?s.push(g(h,i.bottom,c,o.top)):i.bottom<o.top&&e.elementAtHeight((i.bottom+o.top)/2).type==BlockType.Text&&(i.bottom=o.top=(i.bottom+o.top)/2),m(i).concat(s).concat(m(o))}function g(e,t,i,o){return new Piece(e-l.left,t-l.top,i-e,o-t,"cm-selectionBackground")}function m({top:e,bottom:t,horizontal:i}){let o=[];for(let s=0;s<i.length;s+=2)o.push(g(i[s],e,i[s+1],t));return o}function w(t,i,o){let n=1e9,r=-1e9,l=[];function a(t,i,a,d,u){let p=e.coordsAtPos(t,t==o.to?-2:2),f=e.coordsAtPos(a,a==o.from?2:-2);n=Math.min(p.top,f.top,n),r=Math.max(p.bottom,f.bottom,r),u==Direction.LTR?l.push(s&&i?h:p.left,s&&d?c:f.right):l.push(!s&&d?h:f.left,!s&&i?c:p.right)}let d=null!=t?t:o.from,u=null!=i?i:o.to;for(let o of e.visibleRanges)if(o.to>d&&o.from<u)for(let s=Math.max(o.from,d),n=Math.min(o.to,u);;){let o=e.state.doc.lineAt(s);for(let r of e.bidiSpans(o)){let e=r.from+o.from,l=r.to+o.from;if(e>=n)break;l>s&&a(Math.max(e,s),null==t&&e<=d,Math.min(l,n),null==i&&l>=u,r.dir)}if(s=o.to+1,s>=n)break}return 0==l.length&&a(d,null==t,u,null==i,e.textDirection),{top:n,bottom:r,horizontal:l}}function y(e,t){let i=r.top+(t?e.top:e.bottom);return{top:i,bottom:i,horizontal:[]}}}function measureCursor(e,t,i){let o=e.coordsAtPos(t.head,t.assoc||1);if(!o)return null;let s=getBase(e);return new Piece(o.left-s.left,o.top-s.top,-1,o.bottom-o.top,i?"cm-cursor cm-cursor-primary":"cm-cursor cm-cursor-secondary")}const setDropCursorPos=StateEffect.define({map:(e,t)=>null==e?null:t.mapPos(e)}),dropCursorPos=StateField.define({create:()=>null,update:(e,t)=>(null!=e&&(e=t.changes.mapPos(e)),t.effects.reduce((e,t)=>t.is(setDropCursorPos)?t.value:e,e))}),drawDropCursor=ViewPlugin.fromClass(class{constructor(e){this.view=e,this.cursor=null,this.measureReq={read:this.readPos.bind(this),write:this.drawCursor.bind(this)}}update(e){var t;let i=e.state.field(dropCursorPos);null==i?null!=this.cursor&&(null===(t=this.cursor)||void 0===t||t.remove(),this.cursor=null):(this.cursor||(this.cursor=this.view.scrollDOM.appendChild(document.createElement("div")),this.cursor.className="cm-dropCursor"),(e.startState.field(dropCursorPos)!=i||e.docChanged||e.geometryChanged)&&this.view.requestMeasure(this.measureReq))}readPos(){let e=this.view.state.field(dropCursorPos),t=null!=e&&this.view.coordsAtPos(e);if(!t)return null;let i=this.view.scrollDOM.getBoundingClientRect();return{left:t.left-i.left+this.view.scrollDOM.scrollLeft,top:t.top-i.top+this.view.scrollDOM.scrollTop,height:t.bottom-t.top}}drawCursor(e){this.cursor&&(e?(this.cursor.style.left=e.left+"px",this.cursor.style.top=e.top+"px",this.cursor.style.height=e.height+"px"):this.cursor.style.left="-100000px")}destroy(){this.cursor&&this.cursor.remove()}setDropPos(e){this.view.state.field(dropCursorPos)!=e&&this.view.dispatch({effects:setDropCursorPos.of(e)})}},{eventHandlers:{dragover(e){this.setDropPos(this.view.posAtCoords({x:e.clientX,y:e.clientY}))},dragleave(e){e.target!=this.view.contentDOM&&this.view.contentDOM.contains(e.relatedTarget)||this.setDropPos(null)},dragend(){this.setDropPos(null)},drop(){this.setDropPos(null)}}});function dropCursor(){return[dropCursorPos,drawDropCursor]}function iterMatches(e,t,i,o,s){t.lastIndex=0;for(let n,r=e.iterRange(i,o),l=i;!r.next().done;l+=r.value.length)if(!r.lineBreak)for(;n=t.exec(r.value);)s(l+n.index,l+n.index+n[0].length,n)}function matchRanges(e,t){let i=e.visibleRanges;if(1==i.length&&i[0].from==e.viewport.from&&i[0].to==e.viewport.to)return i;let o=[];for(let{from:s,to:n}of i)s=Math.max(e.state.doc.lineAt(s).from,s-t),n=Math.min(e.state.doc.lineAt(n).to,n+t),o.length&&o[o.length-1].to>=s?o[o.length-1].to=n:o.push({from:s,to:n});return o}class MatchDecorator{constructor(e){let{regexp:t,decoration:i,boundary:o,maxLength:s=1e3}=e;if(!t.global)throw new RangeError("The regular expression given to MatchDecorator should have its 'g' flag set");this.regexp=t,this.getDeco="function"==typeof i?i:()=>i,this.boundary=o,this.maxLength=s}createDeco(e){let t=new RangeSetBuilder;for(let{from:i,to:o}of matchRanges(e,this.maxLength))iterMatches(e.state.doc,this.regexp,i,o,(i,o,s)=>t.add(i,o,this.getDeco(s,e,i)));return t.finish()}updateDeco(e,t){let i=1e9,o=-1;return e.docChanged&&e.changes.iterChanges((t,s,n,r)=>{r>e.view.viewport.from&&n<e.view.viewport.to&&(i=Math.min(n,i),o=Math.max(r,o))}),e.viewportChanged||o-i>1e3?this.createDeco(e.view):o>-1?this.updateRange(e.view,t.map(e.changes),i,o):t}updateRange(e,t,i,o){for(let s of e.visibleRanges){let n=Math.max(s.from,i),r=Math.min(s.to,o);if(r>n){let i=e.state.doc.lineAt(n),o=i.to<r?e.state.doc.lineAt(r):i,l=Math.max(s.from,i.from),a=Math.min(s.to,o.to);if(this.boundary){for(;n>i.from;n--)if(this.boundary.test(i.text[n-1-i.from])){l=n;break}for(;r<o.to;r++)if(this.boundary.test(o.text[r-o.from])){a=r;break}}let h,c=[];if(i==o)for(this.regexp.lastIndex=l-i.from;(h=this.regexp.exec(i.text))&&h.index<a-i.from;){let t=h.index+i.from;c.push(this.getDeco(h,e,t).range(t,t+h[0].length))}else iterMatches(e.state.doc,this.regexp,l,a,(t,i,o)=>c.push(this.getDeco(o,e,t).range(t,i)));t=t.update({filterFrom:l,filterTo:a,filter:(e,t)=>e<l||t>a,add:c})}}return t}}const UnicodeRegexpSupport=null!=/x/.unicode?"gu":"g",Specials=new RegExp("[\0-\b\n--­؜​‎‏\u2028\u2029‭‮\ufeff￹-￼]",UnicodeRegexpSupport),Names={0:"null",7:"bell",8:"backspace",10:"newline",11:"vertical tab",13:"carriage return",27:"escape",8203:"zero width space",8204:"zero width non-joiner",8205:"zero width joiner",8206:"left-to-right mark",8207:"right-to-left mark",8232:"line separator",8237:"left-to-right override",8238:"right-to-left override",8233:"paragraph separator",65279:"zero width no-break space",65532:"object replacement"};let _supportsTabSize=null;function supportsTabSize(){var e;if(null==_supportsTabSize&&"undefined"!=typeof document&&document.body){let t=document.body.style;_supportsTabSize=null!=(null!==(e=t.tabSize)&&void 0!==e?e:t.MozTabSize)}return _supportsTabSize||!1}const specialCharConfig=Facet.define({combine(e){let t=combineConfig(e,{render:null,specialChars:Specials,addSpecialChars:null});return(t.replaceTabs=!supportsTabSize())&&(t.specialChars=new RegExp("\t|"+t.specialChars.source,UnicodeRegexpSupport)),t.addSpecialChars&&(t.specialChars=new RegExp(t.specialChars.source+"|"+t.addSpecialChars.source,UnicodeRegexpSupport)),t}});function highlightSpecialChars(e={}){return[specialCharConfig.of(e),specialCharPlugin()]}let _plugin=null;function specialCharPlugin(){return _plugin||(_plugin=ViewPlugin.fromClass(class{constructor(e){this.view=e,this.decorations=Decoration.none,this.decorationCache=Object.create(null),this.decorator=this.makeDecorator(e.state.facet(specialCharConfig)),this.decorations=this.decorator.createDeco(e)}makeDecorator(e){return new MatchDecorator({regexp:e.specialChars,decoration:(t,i,o)=>{let{doc:s}=i.state,n=codePointAt(t[0],0);if(9==n){let e=s.lineAt(o),t=i.state.tabSize,n=countColumn(e.text,t,o-e.from);return Decoration.replace({widget:new TabWidget((t-n%t)*this.view.defaultCharacterWidth)})}return this.decorationCache[n]||(this.decorationCache[n]=Decoration.replace({widget:new SpecialCharWidget(e,n)}))},boundary:e.replaceTabs?void 0:/[^]/})}update(e){let t=e.state.facet(specialCharConfig);e.startState.facet(specialCharConfig)!=t?(this.decorator=this.makeDecorator(t),this.decorations=this.decorator.createDeco(e.view)):this.decorations=this.decorator.updateDeco(e,this.decorations)}},{decorations:e=>e.decorations}))}const DefaultPlaceholder="•";function placeholder$1(e){return e>=32?"•":10==e?"␤":String.fromCharCode(9216+e)}class SpecialCharWidget extends WidgetType{constructor(e,t){super(),this.options=e,this.code=t}eq(e){return e.code==this.code}toDOM(e){let t=placeholder$1(this.code),i=e.state.phrase("Control character")+" "+(Names[this.code]||"0x"+this.code.toString(16)),o=this.options.render&&this.options.render(this.code,i,t);if(o)return o;let s=document.createElement("span");return s.textContent=t,s.title=i,s.setAttribute("aria-label",i),s.className="cm-specialChar",s}ignoreEvent(){return!1}}class TabWidget extends WidgetType{constructor(e){super(),this.width=e}eq(e){return e.width==this.width}toDOM(){let e=document.createElement("span");return e.textContent="\t",e.className="cm-tab",e.style.width=this.width+"px",e}ignoreEvent(){return!1}}const plugin=ViewPlugin.fromClass(class{constructor(){this.height=1e3,this.attrs={style:"padding-bottom: 1000px"}}update(e){let t=e.view.viewState.editorHeight-e.view.defaultLineHeight;t!=this.height&&(this.height=t,this.attrs={style:`padding-bottom: ${t}px`})}});function scrollPastEnd(){return[plugin,contentAttributes.of(e=>{var t;return(null===(t=e.plugin(plugin))||void 0===t?void 0:t.attrs)||null})]}function highlightActiveLine(){return activeLineHighlighter}const lineDeco=Decoration.line({class:"cm-activeLine"}),activeLineHighlighter=ViewPlugin.fromClass(class{constructor(e){this.decorations=this.getDeco(e)}update(e){(e.docChanged||e.selectionSet)&&(this.decorations=this.getDeco(e.view))}getDeco(e){let t=-1,i=[];for(let o of e.state.selection.ranges){if(!o.empty)return Decoration.none;let s=e.lineBlockAt(o.head);s.from>t&&(i.push(lineDeco.range(s.from)),t=s.from)}return Decoration.set(i)}},{decorations:e=>e.decorations});class Placeholder extends WidgetType{constructor(e){super(),this.content=e}toDOM(){let e=document.createElement("span");return e.className="cm-placeholder",e.style.pointerEvents="none",e.appendChild("string"==typeof this.content?document.createTextNode(this.content):this.content),"string"==typeof this.content?e.setAttribute("aria-label","placeholder "+this.content):e.setAttribute("aria-hidden","true"),e}ignoreEvent(){return!1}}function placeholder(e){return ViewPlugin.fromClass(class{constructor(t){this.view=t,this.placeholder=Decoration.set([Decoration.widget({widget:new Placeholder(e),side:1}).range(0)])}get decorations(){return this.view.state.doc.length?Decoration.none:this.placeholder}},{decorations:e=>e.decorations})}const __test={HeightMap,HeightOracle,MeasuredHeights,QueryType,ChangedRange,computeOrder,moveVisually};export{BidiSpan,BlockInfo,BlockType,Decoration,Direction,EditorView,MatchDecorator,PluginField,PluginFieldProvider,ViewPlugin,ViewUpdate,WidgetType,__test,drawSelection,dropCursor,highlightActiveLine,highlightSpecialChars,keymap,logException,placeholder,runScopeHandlers,scrollPastEnd};